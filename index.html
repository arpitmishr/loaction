<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <title>GeoGuard Logistics | Rider App</title>
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 950: '#020617' },
                        primary: '#3b82f6',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b'
                    },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <!-- ICONS (Phosphor) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* Base & Reset */
        body { -webkit-tap-highlight-color: transparent; user-select: none; }
        
        /* Custom Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Modal Transitions */
        .modal { transition: opacity 0.3s ease, transform 0.3s ease; opacity: 0; pointer-events: none; transform: scale(0.95); }
        .modal.open { opacity: 1; pointer-events: auto; transform: scale(1); }

        /* Range Slider */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #3b82f6; margin-top: -6px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #334155; border-radius: 2px; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 font-sans antialiased min-h-screen pb-40">

    <!-- HEADER -->
    <header class="fixed top-0 w-full z-40 bg-slate-900/90 backdrop-blur-md border-b border-slate-800 shadow-md">
        <div class="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-500/30">
                    <i class="ph-fill ph-moped text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-sm font-bold text-white leading-tight">LOGISTICS <span class="text-blue-500">PRO</span></h1>
                    <div class="flex items-center gap-1">
                        <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                        <span class="text-[10px] text-slate-400 font-mono tracking-wide" id="status-text">ONLINE</span>
                    </div>
                </div>
            </div>
            <div id="gps-badge" class="px-2 py-1 rounded border border-slate-700 bg-slate-800 text-[10px] font-mono text-yellow-500 flex items-center gap-1">
                <i class="ph-bold ph-spinner animate-spin"></i> GPS
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="max-w-md mx-auto pt-20 px-4 space-y-5">

        <!-- 1. NAVIGATION & RADAR -->
        <div class="relative w-full aspect-square bg-slate-900 rounded-2xl border border-slate-700 shadow-2xl overflow-hidden group">
            
            <!-- Canvas Map -->
            <canvas id="radar-canvas" class="absolute inset-0 w-full h-full z-10 block"></canvas>

            <!-- HUD: Compass Heading -->
            <div class="absolute top-3 left-1/2 -translate-x-1/2 z-20 bg-black/60 backdrop-blur px-3 py-1 rounded-full border border-slate-700 text-xs font-mono text-cyan-400 flex items-center gap-2">
                <i class="ph-fill ph-compass"></i> <span id="val-heading">0</span>°
            </div>

            <!-- HUD: Zoom Controls -->
            <div class="absolute bottom-4 right-4 z-20 flex flex-col gap-2">
                <button onclick="app.zoom(1)" class="w-10 h-10 bg-slate-800 border border-slate-600 rounded-full text-white flex items-center justify-center active:scale-95 shadow-lg">
                    <i class="ph-bold ph-plus"></i>
                </button>
                <button onclick="app.zoom(-1)" class="w-10 h-10 bg-slate-800 border border-slate-600 rounded-full text-white flex items-center justify-center active:scale-95 shadow-lg">
                    <i class="ph-bold ph-minus"></i>
                </button>
            </div>

            <!-- HUD: Compass Permission (iOS) -->
            <button id="btn-compass" class="absolute top-4 right-4 z-20 w-8 h-8 bg-slate-800 border border-slate-600 rounded text-amber-500 flex items-center justify-center shadow-lg" title="Calibrate Compass">
                <i class="ph-fill ph-compass-tool"></i>
            </button>

            <!-- Center User Icon -->
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-10 pointer-events-none">
                <div class="w-4 h-4 bg-blue-500 rounded-full border-2 border-white shadow-[0_0_20px_rgba(59,130,246,0.6)]"></div>
                <!-- Vision Cone -->
                <div class="absolute -top-16 -left-10 w-0 h-0 border-l-[40px] border-l-transparent border-r-[40px] border-r-transparent border-t-[80px] border-t-blue-500/10"></div>
            </div>
        </div>

        <!-- 2. ROUTING & TARGET -->
        <div class="bg-slate-900 rounded-xl border border-slate-800 p-4 shadow-lg">
            <label class="text-[10px] uppercase text-slate-500 font-bold mb-2 block">Select Destination</label>
            <div class="flex gap-2">
                <select id="select-target" onchange="app.setTarget()" class="flex-1 bg-slate-950 border border-slate-700 text-sm rounded-lg px-3 py-2 outline-none focus:border-blue-500 text-white">
                    <option value="">-- Select Shop --</option>
                    <!-- Filled dynamically -->
                </select>
                <button onclick="app.openMaps()" class="bg-slate-800 hover:bg-slate-700 text-white px-3 py-2 rounded-lg border border-slate-600 transition-colors">
                    <i class="ph-bold ph-google-logo text-blue-400"></i>
                </button>
            </div>
            
            <!-- Guidance Info -->
            <div id="nav-info" class="hidden mt-3 p-3 bg-blue-900/20 border border-blue-800 rounded-lg flex justify-between items-center">
                <div>
                    <div class="text-xs text-blue-400">Straight Line Distance</div>
                    <div class="text-lg font-bold text-white font-mono"><span id="nav-dist">0</span>m</div>
                </div>
                <div class="text-right">
                    <div class="text-xs text-blue-400">Bearing</div>
                    <div class="text-lg font-bold text-white font-mono"><span id="nav-bear">0</span>°</div>
                </div>
            </div>
        </div>

        <!-- 3. CURRENT LOCATION ACTION -->
        <div class="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden">
            <div class="bg-slate-800/50 p-4 border-b border-slate-800 flex justify-between items-center">
                <span class="text-xs font-bold text-slate-400 uppercase">Current Status</span>
                <span id="zone-status" class="px-2 py-1 bg-slate-800 rounded text-[10px] font-bold text-slate-500">OUTSIDE</span>
            </div>
            
            <div class="p-4 space-y-3">
                <!-- Location Name Display -->
                <div>
                    <div class="text-[10px] text-slate-500 mb-1">CURRENT LOCATION</div>
                    <div id="current-loc-name" class="text-lg font-bold text-white truncate">Moving...</div>
                    <div id="current-coords" class="text-xs font-mono text-slate-500">Waiting for GPS...</div>
                </div>

                <!-- Action Buttons -->
                <div class="grid grid-cols-2 gap-3 pt-2">
                    <!-- ADD SHOP (Admin/Setup function) -->
                    <button onclick="app.openAddModal()" class="py-3 rounded-lg border border-slate-700 bg-slate-800 text-slate-300 text-xs font-bold hover:bg-slate-700 transition">
                        SAVE SHOP LOC
                    </button>
                    
                    <!-- TAKE ORDER (Locked if outside) -->
                    <button id="btn-order" onclick="app.openOrderModal()" disabled class="py-3 rounded-lg bg-slate-800 text-slate-500 border border-slate-700 text-xs font-bold flex items-center justify-center gap-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="ph-bold ph-shopping-cart"></i> TAKE ORDER
                    </button>
                </div>
            </div>
        </div>

        <!-- 4. VISIT & ORDER LOGS -->
        <div class="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden mb-8">
            <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                <h3 class="text-xs font-bold text-white">TODAY'S ACTIVITY</h3>
                <span class="text-[10px] text-slate-500">No Deletion Allowed</span>
            </div>
            <div class="max-h-60 overflow-y-auto no-scrollbar">
                <table class="w-full text-left text-xs">
                    <thead class="bg-slate-950 text-slate-500 sticky top-0">
                        <tr>
                            <th class="px-4 py-2">Type</th>
                            <th class="px-4 py-2">Location</th>
                            <th class="px-4 py-2">Time/Info</th>
                        </tr>
                    </thead>
                    <tbody id="log-list" class="divide-y divide-slate-800 text-slate-300">
                        <!-- Logs injected here -->
                    </tbody>
                </table>
            </div>
            <!-- Export Button -->
            <button onclick="app.exportData()" class="w-full py-3 bg-slate-800 hover:bg-slate-700 text-blue-400 text-xs font-bold border-t border-slate-700 flex items-center justify-center gap-2">
                <i class="ph-bold ph-download-simple"></i> EXPORT TO CSV
            </button>
        </div>

    </main>

    <!-- === MODALS === -->

    <!-- 1. ADD LOCATION MODAL -->
    <div id="modal-add" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-slate-900 w-full max-w-sm rounded-xl border border-slate-700 shadow-2xl overflow-hidden">
            <div class="p-4 border-b border-slate-800"><h3 class="font-bold text-white">Save New Shop</h3></div>
            <div class="p-4 space-y-4">
                <p class="text-xs text-slate-400">Use this to mark a new customer location. Ensure you are standing at the entrance.</p>
                <input type="text" id="input-loc-name" placeholder="Shop Name (e.g. Gupta General Store)" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-3 text-sm text-white focus:border-blue-500 outline-none">
            </div>
            <div class="p-4 bg-slate-950 flex gap-3">
                <button onclick="app.closeModals()" class="flex-1 py-2 rounded-lg border border-slate-700 text-slate-400 text-sm">Cancel</button>
                <button onclick="app.saveLocation()" class="flex-1 py-2 rounded-lg bg-blue-600 text-white text-sm font-bold shadow-lg shadow-blue-500/30">Save Location</button>
            </div>
        </div>
    </div>

    <!-- 2. TAKE ORDER MODAL -->
    <div id="modal-order" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-slate-900 w-full max-w-sm rounded-xl border border-slate-700 shadow-2xl overflow-hidden">
            <div class="p-4 border-b border-slate-800 bg-emerald-900/20">
                <h3 class="font-bold text-emerald-400 flex items-center gap-2"><i class="ph-fill ph-check-circle"></i> Location Verified</h3>
            </div>
            <div class="p-4 space-y-4">
                <div class="text-xs text-slate-400">Shop: <span id="order-shop-name" class="text-white font-bold">--</span></div>
                <textarea id="input-order-details" rows="3" placeholder="Enter Order Details / Items..." class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-3 text-sm text-white focus:border-emerald-500 outline-none"></textarea>
                <input type="number" id="input-order-amt" placeholder="Amount (₹)" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-3 text-sm text-white focus:border-emerald-500 outline-none">
            </div>
            <div class="p-4 bg-slate-950 flex gap-3">
                <button onclick="app.closeModals()" class="flex-1 py-2 rounded-lg border border-slate-700 text-slate-400 text-sm">Cancel</button>
                <button onclick="app.submitOrder()" class="flex-1 py-2 rounded-lg bg-emerald-600 text-white text-sm font-bold shadow-lg shadow-emerald-500/30">Confirm Order</button>
            </div>
        </div>
    </div>

    <!-- 3. ACCURACY WARNING MODAL -->
    <div id="modal-wifi" class="modal fixed inset-0 z-[60] flex items-center justify-center bg-red-900/90 backdrop-blur-md p-6 text-center">
        <div class="bg-slate-900 p-6 rounded-2xl border border-red-500 shadow-2xl max-w-xs">
            <div class="w-12 h-12 bg-red-500/20 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="ph-fill ph-wifi-slash text-2xl"></i>
            </div>
            <h2 class="text-lg font-bold text-white mb-2">Weak GPS Signal</h2>
            <p class="text-sm text-slate-300 mb-6">
                Accuracy is too low (<span id="wifi-acc-val">--</span>m). 
                <br><br>
                <strong>Please turn on Wi-Fi</strong> to improve indoor location accuracy.
            </p>
            <button class="w-full py-2 bg-slate-800 text-slate-400 text-xs rounded border border-slate-700">Waiting for better signal...</button>
        </div>
    </div>

<script>
/**
 * ==========================================================================================
 * GEOGUARD LOGISTICS PRO - SINGLE FILE APPLICATION
 * ==========================================================================================
 */

/* --- 1. CORE UTILITIES & MATH --- */
const Utils = {
    // Haversine Distance
    getDist: (lat1, lon1, lat2, lon2) => {
        const R = 6371e3; // meters
        const rad = Math.PI / 180;
        const dLat = (lat2 - lat1) * rad;
        const dLon = (lon2 - lon1) * rad;
        const a = Math.sin(dLat/2)**2 + Math.cos(lat1*rad) * Math.cos(lat2*rad) * Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    },
    
    // Bearing calculation (0-360)
    getBearing: (lat1, lon1, lat2, lon2) => {
        const rad = Math.PI / 180;
        const deg = 180 / Math.PI;
        const y = Math.sin((lon2 - lon1) * rad) * Math.cos(lat2 * rad);
        const x = Math.cos(lat1 * rad) * Math.sin(lat2 * rad) - Math.sin(lat1 * rad) * Math.cos(lat2 * rad) * Math.cos((lon2 - lon1) * rad);
        return (Math.atan2(y, x) * deg + 360) % 360;
    },

    uuid: () => Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
    
    timeStr: (ts) => new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute:'2-digit' })
};

/* --- 2. DATA STORAGE --- */
class Store {
    constructor() {
        this.LOCS = 'geo_shops';
        this.LOGS = 'geo_activity';
    }
    getLocs() { return JSON.parse(localStorage.getItem(this.LOCS)) || []; }
    saveLoc(l) { const d = this.getLocs(); d.push(l); localStorage.setItem(this.LOCS, JSON.stringify(d)); return d; }
    updateLoc(l) { const d = this.getLocs().map(x => x.id === l.id ? l : x); localStorage.setItem(this.LOCS, JSON.stringify(d)); }
    
    getLogs() { return JSON.parse(localStorage.getItem(this.LOGS)) || []; }
    log(type, locName, details) {
        const l = { id: Utils.uuid(), type, loc: locName, desc: details, ts: Date.now() };
        const d = this.getLogs();
        d.unshift(l);
        localStorage.setItem(this.LOGS, JSON.stringify(d));
        return l;
    }
}

/* --- 3. GEOLOCATION & SENSOR ENGINE --- */
class GeoEngine {
    constructor(cb) {
        this.cb = cb;
        // Kalman Filter State
        this.latK = { x: NaN, p: NaN, q: 0.001, r: 0.01 }; // q=process noise, r=sensor noise
        this.lngK = { x: NaN, p: NaN, q: 0.001, r: 0.01 };
    }

    // Simplified 1D Kalman Filter
    kalman(k, z) {
        if (isNaN(k.x)) { k.x = z; k.p = 1; return z; }
        k.p = k.p + k.q;
        const kg = k.p / (k.p + k.r);
        k.x = k.x + kg * (z - k.x);
        k.p = (1 - kg) * k.p;
        return k.x;
    }

    start() {
        if (!navigator.geolocation) return alert("GPS Required");
        
        navigator.geolocation.watchPosition(
            pos => {
                const { latitude, longitude, accuracy, speed, heading } = pos.coords;
                
                // Apply Filter
                const lat = this.kalman(this.latK, latitude);
                const lng = this.kalman(this.lngK, longitude);

                this.cb('gps', { lat, lng, acc: accuracy, speed, heading, ts: Date.now() });
            },
            err => this.cb('err', err),
            { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
        );
    }
}

/* --- 4. COMPASS MANAGER --- */
class Compass {
    constructor(cb) {
        this.cb = cb;
        this.heading = 0;
        
        // Handle iOS Permission
        document.getElementById('btn-compass').onclick = () => {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(r => { if(r === 'granted') this.listen(); else alert("Compass Denied"); })
                    .catch(console.error);
            } else {
                this.listen();
            }
        };
        // Auto start for Android/Non-permission browsers
        this.listen();
    }

    listen() {
        window.addEventListener('deviceorientation', e => {
            if(e.webkitCompassHeading) this.heading = e.webkitCompassHeading;
            else if(e.alpha) this.heading = 360 - e.alpha;
            this.cb(this.heading);
        }, true);
    }
}

/* --- 5. APP CONTROLLER (MAIN LOGIC) --- */
class App {
    constructor() {
        this.store = new Store();
        this.geo = new GeoEngine((t,d) => this.onGeo(t,d));
        this.compass = new Compass(h => this.onHeading(h));
        
        // State
        this.pos = null;
        this.heading = 0;
        this.locs = this.store.getLocs();
        this.targetLoc = null; // Routing target
        this.zoomLevel = 1.0; // Scale factor
        
        // UI Elements
        this.els = {
            canvas: document.getElementById('radar-canvas'),
            ctx: document.getElementById('radar-canvas').getContext('2d'),
            gpsBadge: document.getElementById('gps-badge'),
            statusText: document.getElementById('status-text'),
            currentName: document.getElementById('current-loc-name'),
            currentCoords: document.getElementById('current-coords'),
            zoneStatus: document.getElementById('zone-status'),
            btnOrder: document.getElementById('btn-order'),
            logList: document.getElementById('log-list'),
            selectTarget: document.getElementById('select-target'),
            navInfo: document.getElementById('nav-info'),
            valHeading: document.getElementById('val-heading')
        };

        // Init
        this.resizeCanvas();
        window.onresize = () => this.resizeCanvas();
        this.renderLogs();
        this.populateTargets();
        
        this.geo.start();
        console.log("System Started");
    }

    /* --- EVENT HANDLERS --- */
    onGeo(type, data) {
        if (type === 'err') {
            this.els.gpsBadge.classList.replace('text-yellow-500', 'text-red-500');
            this.els.gpsBadge.innerHTML = 'ERR';
            return;
        }

        // 1. Process Data
        this.pos = data;
        this.els.gpsBadge.classList.replace('text-yellow-500', 'text-emerald-500');
        this.els.gpsBadge.innerHTML = `GPS ±${Math.round(data.acc)}m`;
        this.els.currentCoords.innerText = `${data.lat.toFixed(5)}, ${data.lng.toFixed(5)}`;

        // 2. Wi-Fi / Accuracy Enforcer
        const wifiModal = document.getElementById('modal-wifi');
        if (data.acc > 35) { // Threshold: 35m (typical cell tower range is >50m)
            wifiModal.classList.add('open');
            document.getElementById('wifi-acc-val').innerText = Math.round(data.acc);
        } else {
            wifiModal.classList.remove('open');
        }

        // 3. Geofence Logic (Smart Buffer)
        this.checkGeofences(data);

        // 4. Update Navigation Info if active
        if (this.targetLoc) {
            const dist = Utils.getDist(data.lat, data.lng, this.targetLoc.lat, this.targetLoc.lng);
            const bear = Utils.getBearing(data.lat, data.lng, this.targetLoc.lat, this.targetLoc.lng);
            document.getElementById('nav-dist').innerText = Math.round(dist);
            document.getElementById('nav-bear').innerText = Math.round(bear);
        }

        // 5. Redraw Map
        this.drawRadar();
    }

    onHeading(h) {
        this.heading = h;
        this.els.valHeading.innerText = Math.round(h);
        if (this.pos) this.drawRadar(); // Smooth rotation
    }

    /* --- GEOFENCE LOGIC --- */
    checkGeofences(pos) {
        let insideAny = false;
        
        this.locs.forEach(loc => {
            const realDist = Utils.getDist(pos.lat, pos.lng, loc.lat, loc.lng);
            
            // SMART BUFFER: Subtract half accuracy to handle drift
            const buffer = pos.acc / 2;
            const adjustedDist = Math.max(0, realDist - buffer);
            const radius = 20; // 20m Geofence
            const hysteresis = 10; // Extra 10m to exit

            // ENTER
            if (!loc.isInside && realDist <= radius) {
                loc.isInside = true;
                loc.entryTime = Date.now();
                this.store.log('VISIT_IN', loc.name, `Acc: ${Math.round(pos.acc)}m`);
                this.renderLogs();
                this.store.updateLoc(loc); // Save state
            }
            // EXIT
            else if (loc.isInside && adjustedDist > (radius + hysteresis)) {
                // Time Dwell Check (must be out for 15s)
                if (!loc._exitTentative) loc._exitTentative = Date.now();
                if (Date.now() - loc._exitTentative > 15000) {
                    loc.isInside = false;
                    loc._exitTentative = null;
                    const dur = Math.round((Date.now() - loc.entryTime) / 60000); // mins
                    this.store.log('VISIT_OUT', loc.name, `Duration: ${dur} min`);
                    this.renderLogs();
                    this.store.updateLoc(loc);
                }
            } else {
                loc._exitTentative = null;
            }

            if (loc.isInside) {
                insideAny = true;
                this.els.currentName.innerText = loc.name;
                this.els.zoneStatus.innerText = "INSIDE";
                this.els.zoneStatus.className = "px-2 py-1 bg-emerald-900/50 border border-emerald-500 rounded text-[10px] font-bold text-emerald-400";
                
                // Enable Order Button
                this.els.btnOrder.disabled = false;
                this.els.btnOrder.classList.replace('bg-slate-800', 'bg-emerald-600');
                this.els.btnOrder.classList.replace('text-slate-500', 'text-white');
                document.getElementById('order-shop-name').innerText = loc.name;
            }
        });

        if (!insideAny) {
            this.els.currentName.innerText = "In Transit";
            this.els.zoneStatus.innerText = "OUTSIDE";
            this.els.zoneStatus.className = "px-2 py-1 bg-slate-800 rounded text-[10px] font-bold text-slate-500";
            
            // Disable Order Button
            this.els.btnOrder.disabled = true;
            this.els.btnOrder.classList.add('bg-slate-800', 'text-slate-500');
            this.els.btnOrder.classList.remove('bg-emerald-600', 'text-white');
        }
    }

    /* --- CANVAS RADAR --- */
    resizeCanvas() {
        const p = this.els.canvas.parentElement;
        this.els.canvas.width = p.clientWidth;
        this.els.canvas.height = p.clientHeight;
        if(this.pos) this.drawRadar();
    }

    zoom(dir) {
        this.zoomLevel = Math.max(0.5, Math.min(3.0, this.zoomLevel + (dir * 0.25)));
        this.drawRadar();
    }

    drawRadar() {
        if (!this.pos) return;
        
        const w = this.els.canvas.width;
        const h = this.els.canvas.height;
        const ctx = this.els.ctx;
        const cx = w/2, cy = h/2;
        
        // Scale: Base 2px per meter * zoom
        const scale = 2 * this.zoomLevel; 

        ctx.clearRect(0, 0, w, h);
        
        // --- SAVE CONTEXT & ROTATE WORLD ---
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(-this.heading * Math.PI / 180); // Rotate map opposite to heading

        // 1. Draw Grid
        ctx.strokeStyle = '#334155';
        ctx.lineWidth = 1;
        [20, 50, 100].forEach(r => {
            ctx.beginPath(); ctx.arc(0, 0, r * scale, 0, Math.PI*2); ctx.stroke();
        });

        // 2. Draw North Arrow
        ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(0, -100*scale); 
        ctx.strokeStyle = '#ef4444'; ctx.setLineDash([5,5]); ctx.stroke(); ctx.setLineDash([]);
        
        // 3. Draw Locations
        this.locs.forEach(loc => {
            const d = Utils.getDist(this.pos.lat, this.pos.lng, loc.lat, loc.lng);
            const b = Utils.getBearing(this.pos.lat, this.pos.lng, loc.lat, loc.lng);
            
            // Convert polar to cartesian
            const angle = (b - 90) * Math.PI / 180;
            const x = Math.cos(angle) * d * scale;
            const y = Math.sin(angle) * d * scale;

            // Draw Dot
            ctx.beginPath();
            ctx.arc(x, y, 6, 0, Math.PI*2);
            ctx.fillStyle = loc.isInside ? '#10b981' : (loc.id === this.targetLoc?.id ? '#f59e0b' : '#3b82f6');
            ctx.fill();

            // Label (Counter-rotated)
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(this.heading * Math.PI / 180); 
            ctx.fillStyle = '#fff'; ctx.font = '10px sans-serif'; ctx.textAlign = 'center';
            ctx.fillText(loc.name, 0, 15);
            ctx.restore();
        });

        // 4. Draw Navigation Line (If Target Set)
        if (this.targetLoc) {
            const d = Utils.getDist(this.pos.lat, this.pos.lng, this.targetLoc.lat, this.targetLoc.lng);
            const b = Utils.getBearing(this.pos.lat, this.pos.lng, this.targetLoc.lat, this.targetLoc.lng);
            
            const angle = (b - 90) * Math.PI / 180;
            const tx = Math.cos(angle) * d * scale;
            const ty = Math.sin(angle) * d * scale;

            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(tx, ty);
            ctx.strokeStyle = '#f59e0b';
            ctx.lineWidth = 2;
            ctx.setLineDash([4, 4]);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        ctx.restore(); // Restore to normal screen coords
    }

    /* --- ROUTING --- */
    populateTargets() {
        this.els.selectTarget.innerHTML = '<option value="">-- Select Shop --</option>' + 
            this.locs.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
    }

    setTarget() {
        const id = this.els.selectTarget.value;
        if (!id) {
            this.targetLoc = null;
            this.els.navInfo.classList.add('hidden');
        } else {
            this.targetLoc = this.locs.find(l => l.id === id);
            this.els.navInfo.classList.remove('hidden');
        }
        this.drawRadar();
    }

    openMaps() {
        if (!this.targetLoc) return alert("Select a shop first");
        // Open Google Maps Directions
        const url = `https://www.google.com/maps/dir/?api=1&destination=${this.targetLoc.lat},${this.targetLoc.lng}`;
        window.open(url, '_blank');
    }

    /* --- ORDERS & MODALS --- */
    openAddModal() { document.getElementById('modal-add').classList.add('open'); }
    openOrderModal() { document.getElementById('modal-order').classList.add('open'); }
    closeModals() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('open')); }

    saveLocation() {
        const name = document.getElementById('input-loc-name').value;
        if (!name || !this.pos) return;
        
        const loc = { 
            id: Utils.uuid(), 
            name, 
            lat: this.pos.lat, 
            lng: this.pos.lng, 
            isInside: true, 
            entryTime: Date.now() 
        };
        
        this.store.saveLoc(loc);
        this.locs.push(loc);
        this.store.log('NEW_SHOP', name, 'Location Registered');
        
        this.populateTargets();
        this.renderLogs();
        this.closeModals();
        document.getElementById('input-loc-name').value = '';
    }

    submitOrder() {
        const details = document.getElementById('input-order-details').value;
        const amt = document.getElementById('input-order-amt').value;
        const shop = document.getElementById('order-shop-name').innerText;
        
        if (!details || !amt) return alert("Fill all fields");
        
        this.store.log('ORDER', shop, `₹${amt} - ${details}`);
        this.renderLogs();
        this.closeModals();
        
        // Reset inputs
        document.getElementById('input-order-details').value = '';
        document.getElementById('input-order-amt').value = '';
    }

    /* --- LOGGING & EXPORT --- */
    renderLogs() {
        const logs = this.store.getLogs();
        this.els.logList.innerHTML = logs.map(l => {
            let color = 'text-slate-300';
            if(l.type === 'VISIT_IN') color = 'text-blue-400';
            if(l.type === 'ORDER') color = 'text-emerald-400';
            if(l.type === 'VISIT_OUT') color = 'text-amber-400';
            
            return `
                <tr class="hover:bg-slate-800/50 border-b border-slate-800 last:border-0">
                    <td class="px-4 py-3 font-bold text-[10px] ${color}">${l.type}</td>
                    <td class="px-4 py-3 font-bold text-white">${l.loc}</td>
                    <td class="px-4 py-3">
                        <div class="text-[10px] text-slate-400">${Utils.timeStr(l.ts)}</div>
                        <div class="text-[10px] text-slate-500 truncate max-w-[100px]">${l.desc}</div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    exportData() {
        const logs = this.store.getLogs();
        let csv = "Type,Location,Time,Details\n";
        logs.forEach(l => {
            csv += `${l.type},"${l.loc}",${new Date(l.ts).toISOString()},"${l.desc}"\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `GeoGuard_Export_${Date.now()}.csv`;
        a.click();
    }
}

// Initialize Application
const app = new App();
</script>
</body>
</html>
