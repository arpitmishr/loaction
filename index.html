<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <meta name="description" content="GeoGuard Logistics - Shop Management Module">
    <title>GeoGuard | Shop Management</title>

    <!-- ==================================================================================
         LIBRARIES
         ================================================================================== -->
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',   
                        secondary: '#64748b', 
                        success: '#16a34a',   
                        warning: '#f59e0b',
                        danger: '#dc2626',    
                        bg: '#f8fafc',        
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['monospace']
                    },
                    zIndex: {
                        'map-ui': '2000',
                        'modal': '3000'
                    }
                }
            }
        }
    </script>

    <!-- ICONS -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- LEAFLET MAPS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- ROUTING -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <!-- GOOGLE API -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>

    <!-- ==================================================================================
         STYLES
         ================================================================================== -->
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; width: 100%; overflow: hidden; }
        body { background-color: #f8fafc; color: #1e293b; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Tab Transitions */
        .tab-content { 
            display: none; 
            height: 100%; 
            overflow-y: auto; 
            padding-bottom: 90px; 
            animation: fadeIn 0.2s ease-in-out;
        }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Map Setup */
        #map-wrapper {
            position: relative;
            width: 100%;
            height: 55vh;
            min-height: 350px;
            background: #e2e8f0;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        #osm-map { width: 100%; height: 100%; z-index: 1; }
        
        /* Floating Controls */
        .map-overlay {
            position: absolute;
            z-index: 2000 !important;
        }

        /* Modal Styles */
        .modal-backdrop {
            position: fixed; inset: 0; 
            background: rgba(15, 23, 42, 0.7); 
            backdrop-filter: blur(4px);
            z-index: 3000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.2s ease;
        }
        .modal-backdrop.open { opacity: 1; pointer-events: auto; }
        
        .modal-content {
            background: white; width: 95%; max-width: 420px;
            max-height: 85vh; overflow-y: auto;
            border-radius: 1rem; padding: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            transform: scale(0.95); transition: transform 0.2s ease;
        }
        .modal-backdrop.open .modal-content { transform: scale(1); }
        
        /* Leaflet Cleanup */
        .leaflet-routing-container { display: none !important; }
    </style>
</head>
<body class="flex flex-col">

    <!-- HEADER -->
    <header class="fixed top-0 w-full z-50 bg-white/95 backdrop-blur border-b border-slate-200 h-16 flex-none">
        <div class="max-w-md mx-auto px-4 h-full flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-500/30">
                    <i class="ph-bold ph-storefront text-xl"></i>
                </div>
                <div>
                    <h1 class="text-sm font-bold text-slate-800 leading-tight">GEO<span class="text-blue-600">GUARD</span></h1>
                    <div class="text-[10px] font-medium text-slate-400 font-mono">SHOP MANAGER PRO</div>
                </div>
            </div>
            <div id="gps-indicator" class="flex items-center gap-1.5 px-2.5 py-1 bg-slate-100 border border-slate-200 rounded-full">
                <i class="ph-bold ph-spinner animate-spin text-orange-500 text-xs"></i>
                <span class="text-[10px] font-bold text-slate-600">GPS...</span>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-1 w-full max-w-md mx-auto pt-16 relative bg-slate-50">

        <!-- TAB 1: MAP -->
        <div id="view-map" class="tab-content active px-4 py-4 space-y-4">
            
            <!-- KNOWN ISSUE NOTIFICATION -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-2 flex items-center gap-2 text-[10px] text-yellow-700">
                <i class="ph-fill ph-warning-circle text-lg"></i>
                <span><b>Notice:</b> Auto-map rotation is currently disabled. Map orientation is static (North-Up).</span>
            </div>

            <div id="map-wrapper">
                <div id="osm-map"></div>

                <!-- HUD -->
                <div class="map-overlay top-4 left-4 bg-white/95 px-3 py-1.5 rounded-full border border-slate-200 shadow-md flex items-center gap-2">
                    <i class="ph-fill ph-compass text-blue-600"></i>
                    <span id="hud-heading" class="text-xs font-bold font-mono text-slate-700">0</span>°
                </div>

                <!-- Controls -->
                <button onclick="App.map.recenter()" class="map-overlay bottom-4 right-4 w-12 h-12 bg-blue-600 text-white rounded-full shadow-lg flex items-center justify-center hover:bg-blue-700">
                    <i class="ph-bold ph-crosshair text-xl"></i>
                </button>
            </div>

            <!-- Action Card -->
            <div class="bg-white rounded-xl p-4 border border-slate-200 shadow-sm space-y-4">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-[10px] text-slate-400 font-bold uppercase">Current Zone</div>
                        <div id="lbl-zone" class="text-sm font-bold text-slate-500">Outside Zone</div>
                    </div>
                    <button id="btn-take-order" onclick="App.ui.modal('order')" disabled class="px-4 py-2 rounded-lg bg-slate-100 text-slate-300 text-xs font-bold transition-all">
                        TAKE ORDER
                    </button>
                </div>
                
                <button onclick="App.ui.modal('add')" class="w-full py-3 bg-slate-900 text-white rounded-xl font-bold text-xs flex items-center justify-center gap-2 shadow-lg shadow-slate-900/20">
                    <i class="ph-bold ph-plus-circle text-lg"></i> ADD NEW SHOP / STORE
                </button>
            </div>
        </div>

        <!-- TAB 2: STORES (New Requirements) -->
        <div id="view-stores" class="tab-content px-4 py-6 space-y-4">
            <h2 class="text-lg font-bold text-slate-800 px-1 flex items-center justify-between">
                <span>My Stores</span>
                <span class="text-[10px] font-normal text-slate-400 bg-slate-100 px-2 py-1 rounded">Read Only</span>
            </h2>
            <div id="list-stores" class="space-y-3">
                <!-- Injected via JS -->
            </div>
        </div>

        <!-- TAB 3: ORDERS -->
        <div id="view-orders" class="tab-content px-4 py-6 space-y-4">
            <h2 class="text-lg font-bold text-slate-800 px-1">Order History</h2>
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden min-h-[200px]">
                <table class="w-full text-left text-xs">
                    <thead class="bg-slate-50 text-slate-500 border-b border-slate-200">
                        <tr>
                            <th class="px-4 py-3">Shop</th>
                            <th class="px-4 py-3">Details</th>
                            <th class="px-4 py-3 text-right">Amt</th>
                        </tr>
                    </thead>
                    <tbody id="list-orders" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>

        <!-- TAB 4: SETTINGS -->
        <div id="view-settings" class="tab-content px-4 py-6 space-y-4">
            <h2 class="text-lg font-bold text-slate-800 px-1">Settings</h2>
            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm space-y-3">
                <button onclick="Cloud.login()" class="w-full py-2 border border-slate-300 rounded text-xs font-bold flex justify-center gap-2 items-center">
                    <i class="ph-bold ph-google-logo"></i> Google Login
                </button>
                <button onclick="Cloud.sync()" class="w-full py-2 bg-blue-50 text-blue-600 rounded text-xs font-bold">
                    Sync Data
                </button>
                <div id="sync-status" class="text-center text-[10px] text-slate-400">Offline</div>
            </div>
            <button onclick="App.data.exportCSV()" class="w-full py-3 bg-white border border-emerald-200 text-emerald-600 font-bold rounded-xl shadow-sm">
                Export Data CSV
            </button>
        </div>

    </main>

    <!-- BOTTOM NAV -->
    <nav class="fixed bottom-0 w-full bg-white border-t border-slate-200 z-40 h-16 pb-safe">
        <div class="flex justify-around items-center h-full max-w-md mx-auto">
            <button onclick="App.ui.switchTab('map')" class="nav-btn active group flex flex-col items-center w-full" data-target="map">
                <i class="ph-fill ph-map-trifold text-2xl text-slate-400 group-[.active]:text-blue-600"></i>
                <span class="text-[10px] font-bold text-slate-400 group-[.active]:text-blue-600">Map</span>
            </button>
            <button onclick="App.ui.switchTab('stores')" class="nav-btn group flex flex-col items-center w-full" data-target="stores">
                <i class="ph-bold ph-storefront text-2xl text-slate-400 group-[.active]:text-blue-600"></i>
                <span class="text-[10px] font-medium text-slate-400 group-[.active]:text-blue-600">Stores</span>
            </button>
            <button onclick="App.ui.switchTab('orders')" class="nav-btn group flex flex-col items-center w-full" data-target="orders">
                <i class="ph-bold ph-receipt text-2xl text-slate-400 group-[.active]:text-blue-600"></i>
                <span class="text-[10px] font-medium text-slate-400 group-[.active]:text-blue-600">Orders</span>
            </button>
            <button onclick="App.ui.switchTab('settings')" class="nav-btn group flex flex-col items-center w-full" data-target="settings">
                <i class="ph-bold ph-gear text-2xl text-slate-400 group-[.active]:text-blue-600"></i>
                <span class="text-[10px] font-medium text-slate-400 group-[.active]:text-blue-600">Settings</span>
            </button>
        </div>
    </nav>

    <!-- ==================================================================================
         MODALS (UPDATED WITH NEW REQUIREMENTS)
         ================================================================================== -->

    <!-- Modal: Add Shop -->
    <div id="modal-add" class="modal-backdrop">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
                <h3 class="font-bold text-slate-800 text-lg">Add New Shop</h3>
                <button onclick="App.ui.closeModals()" class="text-slate-400 hover:text-red-500"><i class="ph-bold ph-x text-lg"></i></button>
            </div>
            
            <div class="space-y-3">
                <!-- Location Read-Only -->
                <div class="bg-blue-50 p-2 rounded border border-blue-100 text-[10px] text-blue-700 font-mono text-center">
                    GPS: <span id="lbl-gps-coords">WAITING...</span>
                </div>

                <!-- Basic Details -->
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase">Shop Name <span class="text-red-500">*</span></label>
                    <input id="inp-name" type="text" class="w-full p-2 bg-slate-50 border border-slate-300 rounded text-sm focus:border-blue-500 outline-none">
                </div>

                <!-- Type & Phone -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 uppercase">Type <span class="text-red-500">*</span></label>
                        <select id="inp-type" class="w-full p-2 bg-slate-50 border border-slate-300 rounded text-sm outline-none">
                            <option value="Shop">Shop</option>
                            <option value="Dhaba">Dhaba</option>
                            <option value="Hotel">Hotel</option>
                            <option value="Cafe">Cafe</option>
                            <option value="Resort">Resort</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 uppercase">Phone</label>
                        <input id="inp-phone" type="tel" class="w-full p-2 bg-slate-50 border border-slate-300 rounded text-sm outline-none">
                    </div>
                </div>

                <!-- Address & Remarks -->
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase">Full Address</label>
                    <input id="inp-address" type="text" class="w-full p-2 bg-slate-50 border border-slate-300 rounded text-sm outline-none">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase">Remarks / Notes</label>
                    <textarea id="inp-remarks" rows="2" class="w-full p-2 bg-slate-50 border border-slate-300 rounded text-sm outline-none"></textarea>
                </div>

                <!-- Payment Configuration -->
                <div class="pt-2 border-t border-slate-100">
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Customer / Payment Type <span class="text-red-500">*</span></label>
                    <select id="inp-pay-type" onchange="App.ui.toggleCreditFields()" class="w-full p-2 bg-slate-50 border border-slate-300 rounded text-sm outline-none font-bold text-slate-700">
                        <option value="Cash">Cash</option>
                        <option value="Online">Online / UPI</option>
                        <option value="Credit">Credit (Udhaar)</option>
                    </select>
                </div>

                <!-- Credit Fields (Conditional) -->
                <div id="section-credit" class="hidden bg-orange-50 p-3 rounded-lg border border-orange-200 space-y-3">
                    <div class="text-[10px] font-bold text-orange-600 uppercase tracking-wide border-b border-orange-200 pb-1">Credit Configuration</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500">Credit Limit (₹)</label>
                            <input id="inp-cred-limit" type="number" class="w-full p-2 bg-white border border-slate-300 rounded text-sm">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500">Cycle (Days)</label>
                            <input id="inp-cred-days" type="number" class="w-full p-2 bg-white border border-slate-300 rounded text-sm">
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500">GST Number</label>
                        <input id="inp-gst" type="text" class="w-full p-2 bg-white border border-slate-300 rounded text-sm uppercase">
                    </div>
                </div>

                <button onclick="App.data.addLocation()" class="w-full py-3 bg-blue-600 text-white rounded-lg font-bold text-sm shadow hover:bg-blue-700 mt-2">
                    SAVE SHOP
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Order -->
    <div id="modal-order" class="modal-backdrop">
        <div class="modal-content">
            <h3 class="font-bold text-slate-800 text-lg mb-2">Take Order</h3>
            <div class="bg-slate-100 p-2 rounded mb-3 text-xs text-slate-500">Shop: <b id="lbl-ord-shop" class="text-slate-800">--</b></div>
            <div class="space-y-3">
                <input id="inp-ord-desc" placeholder="Items..." class="w-full p-2 border rounded text-sm">
                <input id="inp-ord-amt" type="number" placeholder="Amount (₹)" class="w-full p-2 border rounded text-sm">
                <div class="flex gap-2">
                    <button onclick="App.ui.closeModals()" class="flex-1 py-2 text-slate-500 font-bold text-sm">Cancel</button>
                    <button onclick="App.data.addOrder()" class="flex-1 py-2 bg-emerald-600 text-white rounded font-bold text-sm">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================================================================================
         JAVASCRIPT
         ================================================================================== -->
    <script>
        const CONFIG = {
            DB: 'geoguard_v5_db',
            GPS: { enableHighAccuracy: true, maximumAge: 1000, timeout: 5000 },
            GAPI: 'AIzaSyBpwJ_Z5wnR67SxDfxEf0Vr0KiFFwR8beE' // Demo Key
        };

        const Utils = {
            id: () => Date.now().toString(36),
            dist: (l1, n1, l2, n2) => {
                const R=6371e3, r=Math.PI/180, a=Math.sin((l2-l1)*r/2)**2+Math.cos(l1*r)*Math.cos(l2*r)*Math.sin((n2-n1)*r/2)**2;
                return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
            },
            fmtMoney: (n) => new Intl.NumberFormat('en-IN', {style:'currency', currency:'INR'}).format(n),
            date: (ts) => new Date(ts).toLocaleDateString()
        };

        // --- CLOUD SYNC ---
        const Cloud = {
            token: null,
            init: function() {
                const i = setInterval(() => { if(window.google) { clearInterval(i); this.load(); } }, 500);
            },
            load: function() {
                gapi.load('client', async()=>{
                    await gapi.client.init({apiKey:CONFIG.GAPI, discoveryDocs:['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']});
                });
            },
            login: function() {
                google.accounts.oauth2.initTokenClient({
                    client_id: '405512233820-hj65j2lgmqf8arfqhqmugh0un3garh54.apps.googleusercontent.com',
                    scope: 'https://www.googleapis.com/auth/drive.file',
                    callback: (r)=>{ this.token=r.access_token; document.getElementById('sync-status').innerText="Logged In"; }
                }).requestAccessToken();
            },
            sync: async function() {
                if(!this.token) return alert("Please Login First");
                const blob = new Blob([JSON.stringify(App.data.dump())], {type:'application/json'});
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify({name:'geo_backup.json'})],{type:'application/json'}));
                form.append('file', blob);
                await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method:'POST', headers:{'Authorization':`Bearer ${this.token}`}, body:form
                });
                document.getElementById('sync-status').innerText="Synced Now";
            }
        };

        // --- DATA STORE ---
        const Storage = {
            state: { locs:[], orders:[], prof:{} },
            init: function() {
                const s = localStorage.getItem(CONFIG.DB);
                if(s) this.state = JSON.parse(s);
            },
            save: function() { localStorage.setItem(CONFIG.DB, JSON.stringify(this.state)); },
            
            // Updated to accept full data object
            addLocation: function(data) {
                this.state.locs.push(data);
                this.save();
            },
            
            // Protected: User cannot delete
            // removeLocation: function(id) { ... } // Disabled per requirements

            addOrder: function(s, d, a) {
                this.state.orders.unshift({id:Utils.id(), shop:s, desc:d, amt:a, date:Date.now()});
                this.save();
            }
        };

        // --- MAP ENGINE ---
        const MapEngine = {
            map: null,
            userMk: null,
            markers: {},
            init: function() {
                this.map = L.map('osm-map', {zoomControl:false}).setView([20,78],5);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{maxZoom:19}).addTo(this.map);
                
                const icon = L.divIcon({className:'bg-transparent', html:'<div class="w-4 h-4 bg-blue-600 rounded-full border-2 border-white shadow-lg"></div>'});
                this.userMk = L.marker([0,0],{icon, zIndexOffset:1000}).addTo(this.map);
            },
            updatePos: function(lat, lng, first) {
                this.userMk.setLatLng([lat,lng]);
                if(first) this.map.setView([lat,lng], 16);
            },
            render: function() {
                for(let k in this.markers) this.map.removeLayer(this.markers[k]);
                this.markers={};
                Storage.state.locs.forEach(l => {
                    const col = l.isInside ? '#16a34a' : '#2563eb';
                    const icon = L.divIcon({className:'bg-transparent', html:`<div class="w-3 h-3 rounded-full border border-white shadow" style="background:${col}"></div>`});
                    this.markers[l.id] = L.marker([l.lat, l.lng], {icon}).addTo(this.map).bindPopup(l.name);
                });
            },
            recenter: function() { if(App.pos) this.map.setView([App.pos.lat, App.pos.lng], 16); }
        };

        // --- MAIN APP ---
        const App = {
            pos: null,
            init: function() {
                Storage.init();
                Cloud.init();
                MapEngine.init();
                this.startGPS();
                this.ui.renderStores();
                this.ui.renderOrders();
                
                // Compass
                window.addEventListener('deviceorientation', e=>{
                    const h = e.webkitCompassHeading || Math.abs(e.alpha-360);
                    if(h) document.getElementById('hud-heading').innerText = Math.round(h);
                }, true);
            },
            startGPS: function() {
                navigator.geolocation.watchPosition(p => {
                    const {latitude:lat, longitude:lng, accuracy:acc} = p.coords;
                    const f = !this.pos;
                    this.pos = {lat, lng};
                    
                    // UI Update
                    const ind = document.getElementById('gps-indicator');
                    ind.innerHTML = `<span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span> <span class="text-emerald-700 font-bold text-[10px]">±${Math.round(acc)}m</span>`;
                    ind.className = "flex items-center gap-1.5 px-2.5 py-1 bg-emerald-50 border border-emerald-200 rounded-full";
                    
                    MapEngine.updatePos(lat, lng, f);
                    this.checkZone();
                }, e=>console.log(e), CONFIG.GPS);
            },
            checkZone: function() {
                if(!this.pos) return;
                let inside = false;
                Storage.state.locs.forEach(l => {
                    const d = Utils.dist(this.pos.lat, this.pos.lng, l.lat, l.lng);
                    if(!l.isInside && d<=5) { l.isInside=true; Storage.save(); MapEngine.render(); }
                    else if(l.isInside && d>10) { l.isInside=false; Storage.save(); MapEngine.render(); }
                    
                    if(l.isInside) {
                        inside=true;
                        document.getElementById('lbl-zone').innerText = l.name;
                        document.getElementById('lbl-zone').className = "text-sm font-bold text-emerald-600";
                        document.getElementById('lbl-ord-shop').innerText = l.name;
                        document.getElementById('btn-take-order').disabled=false;
                        document.getElementById('btn-take-order').className = "px-4 py-2 rounded-lg bg-emerald-600 text-white text-xs font-bold shadow";
                    }
                });
                if(!inside) {
                    document.getElementById('lbl-zone').innerText = "Outside Zone";
                    document.getElementById('lbl-zone').className = "text-sm font-bold text-slate-500";
                    document.getElementById('btn-take-order').disabled=true;
                    document.getElementById('btn-take-order').className = "px-4 py-2 rounded-lg bg-slate-100 text-slate-300 text-xs font-bold";
                }
            },
            data: {
                dump: () => Storage.state,
                addLocation: function() {
                    const name = document.getElementById('inp-name').value;
                    if(!name || !App.pos) return alert("Name & GPS required");
                    
                    const payType = document.getElementById('inp-pay-type').value;
                    const isCredit = payType === 'Credit';

                    const payload = {
                        id: Utils.id(),
                        name: name,
                        lat: App.pos.lat,
                        lng: App.pos.lng,
                        type: document.getElementById('inp-type').value,
                        phone: document.getElementById('inp-phone').value || '',
                        address: document.getElementById('inp-address').value || '',
                        remarks: document.getElementById('inp-remarks').value || '',
                        payment: {
                            type: payType,
                            limit: isCredit ? document.getElementById('inp-cred-limit').value : null,
                            cycle: isCredit ? document.getElementById('inp-cred-days').value : null,
                            gst: isCredit ? document.getElementById('inp-gst').value : null
                        },
                        isInside: false,
                        created: Date.now()
                    };

                    Storage.addLocation(payload);
                    App.ui.closeModals();
                    App.ui.renderStores();
                    MapEngine.render();
                    
                    // Reset Form
                    document.getElementById('inp-name').value = '';
                    document.getElementById('inp-address').value = '';
                },
                addOrder: function() {
                    const d = document.getElementById('inp-ord-desc').value;
                    const a = document.getElementById('inp-ord-amt').value;
                    const s = document.getElementById('lbl-ord-shop').innerText;
                    if(d && a) {
                        Storage.addOrder(s, d, a);
                        App.ui.closeModals();
                        App.ui.renderOrders();
                        document.getElementById('inp-ord-desc').value = '';
                        document.getElementById('inp-ord-amt').value = '';
                    }
                },
                exportCSV: function() {
                    let c = "TYPE,SHOP,DETAILS,AMT,DATE\n";
                    Storage.state.orders.forEach(o=> c+=`ORDER,${o.shop},"${o.desc}",${o.amt},${Utils.date(o.date)}\n`);
                    Storage.state.locs.forEach(l=> c+=`SHOP,${l.name},"${l.address} - ${l.payment.type}",0,${Utils.date(l.created)}\n`);
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(new Blob([c],{type:'text/csv'}));
                    a.download = 'geo_export.csv';
                    a.click();
                }
            },
            ui: {
                switchTab: function(t) {
                    document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
                    document.getElementById('view-'+t).classList.add('active');
                    document.querySelectorAll('.nav-btn').forEach(b => {
                        b.classList.toggle('active', b.dataset.target === t);
                        // Update Icon Colors
                        const icon = b.querySelector('i');
                        const txt = b.querySelector('span');
                        if(b.dataset.target === t) {
                            icon.classList.remove('text-slate-400'); icon.classList.add('text-blue-600');
                            txt.classList.remove('text-slate-400'); txt.classList.add('text-blue-600');
                        } else {
                            icon.classList.add('text-slate-400'); icon.classList.remove('text-blue-600');
                            txt.classList.add('text-slate-400'); txt.classList.remove('text-blue-600');
                        }
                    });
                    if(t==='map') setTimeout(()=>MapEngine.map.invalidateSize(), 100);
                },
                modal: function(id) {
                    document.getElementById('modal-'+id).classList.add('open');
                    if(id==='add' && App.pos) {
                        document.getElementById('lbl-gps-coords').innerText = `${App.pos.lat.toFixed(6)}, ${App.pos.lng.toFixed(6)}`;
                    }
                },
                closeModals: function() {
                    document.querySelectorAll('.modal-backdrop').forEach(e=>e.classList.remove('open'));
                },
                toggleCreditFields: function() {
                    const val = document.getElementById('inp-pay-type').value;
                    const div = document.getElementById('section-credit');
                    if(val === 'Credit') div.classList.remove('hidden'); else div.classList.add('hidden');
                },
                renderStores: function() {
                    const list = document.getElementById('list-stores');
                    const stores = Storage.state.locs;
                    if(!stores.length) { list.innerHTML='<div class="text-center text-slate-400 p-4">No shops saved.</div>'; return; }
                    
                    list.innerHTML = stores.map(s => {
                        let badges = `<span class="px-1.5 py-0.5 bg-slate-100 text-slate-500 rounded text-[10px] border border-slate-200">${s.type}</span>`;
                        if(s.payment.type === 'Credit') badges += `<span class="ml-1 px-1.5 py-0.5 bg-orange-100 text-orange-600 rounded text-[10px] border border-orange-200">Credit</span>`;
                        else if(s.payment.type === 'Cash') badges += `<span class="ml-1 px-1.5 py-0.5 bg-green-100 text-green-600 rounded text-[10px] border border-green-200">Cash</span>`;
                        else badges += `<span class="ml-1 px-1.5 py-0.5 bg-blue-100 text-blue-600 rounded text-[10px] border border-blue-200">Online</span>`;

                        return `
                        <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-bold text-slate-800">${s.name}</div>
                                    <div class="mt-1 flex flex-wrap gap-1">${badges}</div>
                                    <div class="mt-2 text-xs text-slate-500 flex items-center gap-1"><i class="ph-bold ph-map-pin"></i> ${s.address || 'No Address'}</div>
                                    ${s.phone ? `<div class="mt-1 text-xs text-slate-500 flex items-center gap-1"><i class="ph-bold ph-phone"></i> ${s.phone}</div>` : ''}
                                </div>
                                <div class="text-[10px] font-mono text-slate-400 bg-slate-50 px-1 rounded">
                                    ${s.lat.toFixed(3)}, ${s.lng.toFixed(3)}
                                </div>
                            </div>
                            <!-- Note: Delete button removed per requirements -->
                        </div>`;
                    }).join('');
                },
                renderOrders: function() {
                    const list = document.getElementById('list-orders');
                    let html = '';
                    Storage.state.orders.forEach(o => {
                        html += `<tr><td class="px-4 py-3 font-bold text-slate-700">${o.shop}</td><td class="px-4 py-3 text-slate-500">${o.desc}</td><td class="px-4 py-3 text-right font-bold text-emerald-600 font-mono">${Utils.fmtMoney(o.amt)}</td></tr>`;
                    });
                    list.innerHTML = html || '<tr><td colspan="3" class="p-4 text-center text-slate-400">No orders.</td></tr>';
                }
            }
        };

        // --- START ---
        window.App = App;
        window.onload = () => App.init();
    </script>
</body>
</html>
