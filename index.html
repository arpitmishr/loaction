<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <title>GeoGuard Logistics | Cloud Sync</title>
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 950: '#020617' },
                        primary: '#3b82f6',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b'
                    },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <!-- LEAFLET MAP CSS & JS (OpenStreetMap) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- ICONS -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- GOOGLE API SCRIPTS -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; user-select: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .modal { transition: opacity 0.3s ease, transform 0.3s ease; opacity: 0; pointer-events: none; transform: scale(0.95); }
        .modal.open { opacity: 1; pointer-events: auto; transform: scale(1); }
        
        /* Tab Transitions */
        .tab-content { display: none; animation: fadeIn 0.2s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Leaflet Dark Mode Tweaks */
        .leaflet-container { background: #0f172a; font-family: inherit; }
        .leaflet-popup-content-wrapper, .leaflet-popup-tip { background: #1e293b; color: #fff; border: 1px solid #334155; }
        .leaflet-popup-close-button { color: #94a3b8 !important; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 font-sans antialiased min-h-screen flex flex-col">

    <!-- HEADER -->
    <header class="fixed top-0 w-full z-40 bg-slate-900/95 backdrop-blur-md border-b border-slate-800 shadow-md">
        <div class="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-500/30">
                    <i class="ph-fill ph-moped text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-sm font-bold text-white leading-tight">LOGISTICS <span class="text-blue-500">CLOUD</span></h1>
                    <div class="flex items-center gap-1">
                        <span id="cloud-dot" class="w-2 h-2 rounded-full bg-slate-500"></span>
                        <span class="text-[10px] text-slate-400 font-mono tracking-wide" id="cloud-status">OFFLINE</span>
                    </div>
                </div>
            </div>
            <div id="gps-badge" class="px-2 py-1 rounded border border-slate-700 bg-slate-800 text-[10px] font-mono text-yellow-500 flex items-center gap-1">
                <i class="ph-bold ph-spinner animate-spin"></i> GPS
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT AREA -->
    <main class="flex-1 max-w-md mx-auto w-full pt-20 pb-24 px-4 overflow-y-auto no-scrollbar">

        <!-- === TAB 1: MAP & HOME === -->
        <div id="tab-home" class="tab-content active space-y-5">
            
            <!-- OPENSTREETMAP CONTAINER -->
            <div class="relative w-full aspect-square bg-slate-900 rounded-2xl border border-slate-700 shadow-2xl overflow-hidden z-0 group">
                <div id="osm-map" class="absolute inset-0 w-full h-full z-10 block bg-slate-800"></div>
                
                <!-- Recenter Button -->
                <button onclick="app.centerMap()" class="absolute bottom-4 right-4 z-[400] w-10 h-10 bg-slate-800 border border-slate-600 rounded-full text-blue-400 flex items-center justify-center shadow-lg active:scale-95 transition-transform">
                    <i class="ph-bold ph-crosshair"></i>
                </button>
            </div>

            <!-- ROUTING -->
            <div class="bg-slate-900 rounded-xl border border-slate-800 p-4 shadow-lg">
                <label class="text-[10px] uppercase text-slate-500 font-bold mb-2 block">Navigation</label>
                <div class="flex gap-2">
                    <select id="select-target" onchange="app.setTarget()" class="flex-1 bg-slate-950 border border-slate-700 text-sm rounded-lg px-3 py-2 outline-none focus:border-blue-500 text-white">
                        <option value="">-- Select Shop --</option>
                    </select>
                    <button onclick="app.openMaps()" class="bg-slate-800 hover:bg-slate-700 text-white px-3 py-2 rounded-lg border border-slate-600"><i class="ph-bold ph-google-logo text-blue-400"></i></button>
                </div>
                <div id="nav-info" class="hidden mt-3 p-3 bg-blue-900/20 border border-blue-800 rounded-lg flex justify-between items-center">
                    <div><div class="text-xs text-blue-400">Distance</div><div class="text-lg font-bold text-white font-mono"><span id="nav-dist">0</span>m</div></div>
                    <div class="text-right"><div class="text-xs text-blue-400">Bearing</div><div class="text-lg font-bold text-white font-mono"><span id="nav-bear">0</span>°</div></div>
                </div>
            </div>

            <!-- ACTION CARD -->
            <div class="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden">
                <div class="bg-slate-800/50 p-4 border-b border-slate-800 flex justify-between items-center">
                    <span class="text-xs font-bold text-slate-400 uppercase">Current Status</span>
                    <span id="zone-status" class="px-2 py-1 bg-slate-800 rounded text-[10px] font-bold text-slate-500">OUTSIDE</span>
                </div>
                <div class="p-4 space-y-3">
                    <div>
                        <div class="text-[10px] text-slate-500 mb-1">LOCATION</div>
                        <div id="current-loc-name" class="text-lg font-bold text-white truncate">Moving...</div>
                        <div id="current-coords" class="text-xs font-mono text-slate-500">Waiting for GPS...</div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 pt-2">
                        <button onclick="app.openAddModal()" class="py-3 rounded-lg border border-slate-700 bg-slate-800 text-slate-300 text-xs font-bold hover:bg-slate-700">SAVE SHOP</button>
                        <button id="btn-order" onclick="app.openOrderModal()" disabled class="py-3 rounded-lg bg-slate-800 text-slate-500 border border-slate-700 text-xs font-bold flex items-center justify-center gap-2 transition-all disabled:opacity-50">
                            <i class="ph-bold ph-shopping-cart"></i> TAKE ORDER
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- === TAB 2: ORDER HISTORY === -->
        <div id="tab-orders" class="tab-content space-y-4">
            <h2 class="text-lg font-bold text-white border-l-4 border-blue-500 pl-3">Order History</h2>
            
            <!-- Filters -->
            <div class="bg-slate-900 p-4 rounded-xl border border-slate-800 space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] text-slate-500 uppercase font-bold">Date</label>
                        <input type="date" id="filter-date" onchange="app.renderOrders()" class="w-full bg-slate-950 border border-slate-700 rounded p-2 text-xs text-white">
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-500 uppercase font-bold">Shop</label>
                        <select id="filter-shop" onchange="app.renderOrders()" class="w-full bg-slate-950 border border-slate-700 rounded p-2 text-xs text-white">
                            <option value="all">All Shops</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- List -->
            <div class="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden min-h-[300px]">
                <table class="w-full text-left text-xs">
                    <thead class="bg-slate-950 text-slate-500">
                        <tr><th class="px-4 py-2">Shop</th><th class="px-4 py-2">Items</th><th class="px-4 py-2 text-right">Amt</th></tr>
                    </thead>
                    <tbody id="order-list" class="divide-y divide-slate-800 text-slate-300">
                        <!-- Injected -->
                    </tbody>
                    <tfoot class="bg-slate-950 text-white font-bold">
                        <tr><td class="px-4 py-2" colspan="2">Total</td><td class="px-4 py-2 text-right text-emerald-400" id="order-total">₹0</td></tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- === TAB 3: STORE MANAGEMENT === -->
        <div id="tab-store" class="tab-content space-y-4">
            <h2 class="text-lg font-bold text-white border-l-4 border-emerald-500 pl-3">My Stores</h2>
            <div id="store-list" class="space-y-3">
                <!-- Injected Stores -->
            </div>
        </div>

        <!-- === TAB 4: PROFILE === -->
        <div id="tab-profile" class="tab-content space-y-4">
            <h2 class="text-lg font-bold text-white border-l-4 border-purple-500 pl-3">Rider Profile</h2>
            
            <!-- Profile Card -->
            <div class="bg-slate-900 p-6 rounded-xl border border-slate-800 text-center">
                <div class="w-20 h-20 bg-slate-800 rounded-full mx-auto mb-4 flex items-center justify-center border-2 border-slate-700">
                    <i class="ph-fill ph-user text-4xl text-slate-500"></i>
                </div>
                <div class="space-y-3 text-left">
                    <div>
                        <label class="text-[10px] text-slate-500 uppercase font-bold">Full Name</label>
                        <input type="text" id="prof-name" placeholder="Enter Name" class="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white">
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-500 uppercase font-bold">Rider ID / Phone</label>
                        <input type="text" id="prof-id" placeholder="ID12345" class="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white">
                    </div>
                    <button onclick="app.saveProfile()" class="w-full py-2 bg-blue-600 hover:bg-blue-500 text-white rounded font-bold text-sm">Update Profile</button>
                </div>
            </div>

            <!-- Cloud Sync Control -->
            <div class="bg-slate-900 p-4 rounded-xl border border-slate-800">
                <h3 class="font-bold text-white mb-2 flex items-center gap-2">
                    <i class="ph-bold ph-google-logo text-white"></i> Google Drive Backup
                </h3>
                <p class="text-xs text-slate-400 mb-4">Sync orders and locations to your Google Drive.</p>
                
                <button id="btn-glogin" onclick="drive.login()" class="w-full py-2 bg-white text-slate-900 rounded font-bold text-sm flex items-center justify-center gap-2 mb-2">
                    <i class="ph-bold ph-sign-in"></i> Sign in with Google
                </button>
                <button id="btn-gsync" onclick="drive.sync()" disabled class="w-full py-2 bg-slate-800 text-slate-500 rounded font-bold text-sm flex items-center justify-center gap-2 border border-slate-700">
                    <i class="ph-bold ph-arrows-clockwise"></i> Sync Now
                </button>
                <div id="drive-msg" class="text-[10px] text-center mt-2 text-slate-500">Not connected</div>
            </div>

            <!-- Export -->
            <button onclick="app.exportData()" class="w-full py-3 bg-slate-800 border border-slate-700 text-emerald-400 font-bold rounded-xl flex items-center justify-center gap-2">
                <i class="ph-bold ph-file-csv"></i> EXPORT ALL DATA
            </button>
        </div>

    </main>

    <!-- BOTTOM NAVIGATION -->
    <nav class="fixed bottom-0 w-full bg-slate-900 border-t border-slate-800 z-50 pb-safe">
        <div class="max-w-md mx-auto flex justify-around items-center h-16">
            <button onclick="app.switchTab('home')" class="nav-btn active flex flex-col items-center gap-1 text-slate-500 w-full" data-target="home">
                <i class="ph-bold ph-map-trifold text-xl"></i><span class="text-[10px]">Map</span>
            </button>
            <button onclick="app.switchTab('orders')" class="nav-btn flex flex-col items-center gap-1 text-slate-500 w-full" data-target="orders">
                <i class="ph-bold ph-receipt text-xl"></i><span class="text-[10px]">Orders</span>
            </button>
            <button onclick="app.switchTab('store')" class="nav-btn flex flex-col items-center gap-1 text-slate-500 w-full" data-target="store">
                <i class="ph-bold ph-storefront text-xl"></i><span class="text-[10px]">Store</span>
            </button>
            <button onclick="app.switchTab('profile')" class="nav-btn flex flex-col items-center gap-1 text-slate-500 w-full" data-target="profile">
                <i class="ph-bold ph-user-circle text-xl"></i><span class="text-[10px]">Profile</span>
            </button>
        </div>
    </nav>

    <!-- MODALS (Hidden) -->
    <!-- UPDATED ADD MODAL -->
    <div id="modal-add" class="modal fixed inset-0 z-[1000] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-slate-900 w-full max-w-sm rounded-xl border border-slate-700 flex flex-col max-h-[85vh]">
            
            <!-- Header -->
            <div class="p-4 border-b border-slate-800">
                <h3 class="font-bold text-white">Save Shop Location</h3>
                <p class="text-[10px] text-slate-400">Current GPS: <span id="add-modal-gps" class="font-mono text-emerald-400">Waiting...</span></p>
            </div>

            <!-- Scrollable Form -->
            <div class="p-4 space-y-4 overflow-y-auto custom-scrollbar flex-1">
                
                <!-- Important Fields -->
                <div class="space-y-3">
                    <div class="text-[10px] font-bold text-blue-400 uppercase tracking-wider">Important (Mandatory)</div>
                    
                    <input type="text" id="inp-name" placeholder="Shop Name *" class="w-full bg-slate-950 border border-slate-700 rounded p-3 text-sm text-white focus:border-blue-500 outline-none">
                    
                    <input type="text" id="inp-auth" placeholder="Authorized Person Name *" class="w-full bg-slate-950 border border-slate-700 rounded p-3 text-sm text-white focus:border-blue-500 outline-none">
                    
                    <input type="tel" id="inp-contact" placeholder="Contact Number *" class="w-full bg-slate-950 border border-slate-700 rounded p-3 text-sm text-white focus:border-blue-500 outline-none">
                    
                    <textarea id="inp-addr" rows="2" placeholder="Full Address *" class="w-full bg-slate-950 border border-slate-700 rounded p-3 text-sm text-white focus:border-blue-500 outline-none"></textarea>
                </div>

                <!-- Optional Fields -->
                <div class="space-y-3 pt-2 border-t border-slate-800">
                    <div class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Optional</div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <select id="inp-type" class="w-full bg-slate-950 border border-slate-700 rounded p-3 text-sm text-white outline-none">
                            <option value="Cash">Type: Cash</option>
                            <option value="Credit">Type: Credit</option>
                        </select>
                        <input type="text" id="inp-gst" placeholder="GST No." class="w-full bg-slate-950 border border-slate-700 rounded p-3 text-sm text-white outline-none">
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" id="inp-limit" placeholder="Credit Limit (₹)" class="w-full bg-slate-950 border border-slate-700 rounded p-3 text-sm text-white outline-none">
                        <input type="number" id="inp-days" placeholder="Credit Days" class="w-full bg-slate-950 border border-slate-700 rounded p-3 text-sm text-white outline-none">
                    </div>

                    <textarea id="inp-remark" rows="1" placeholder="Remarks / Notes" class="w-full bg-slate-950 border border-slate-700 rounded p-3 text-sm text-white outline-none"></textarea>
                </div>
            </div>

            <!-- Footer Buttons -->
            <div class="p-4 border-t border-slate-800 flex gap-3 bg-slate-900 rounded-b-xl">
                <button onclick="app.closeModals()" class="flex-1 py-3 border border-slate-700 text-slate-400 rounded-lg text-sm font-bold">Cancel</button>
                <button onclick="app.saveLocation()" class="flex-1 py-3 bg-blue-600 text-white rounded-lg text-sm font-bold shadow-lg shadow-blue-900/20">Save Shop</button>
            </div>
        </div>
    </div>

    <!-- UPDATED ORDER MODAL -->
    <div id="modal-order" class="modal fixed inset-0 z-[1000] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-slate-900 w-full max-w-sm rounded-xl border border-slate-700 p-4 space-y-4">
            <div class="border-b border-slate-800 pb-2">
                <div class="text-xs text-slate-400">Shop: <span id="order-shop-name" class="text-white font-bold">--</span></div>
            </div>
            
            <!-- Order Items -->
            <textarea id="input-order-details" rows="3" placeholder="Order Items / Description..." class="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white focus:border-blue-500 outline-none"></textarea>
            
            <!-- Date and Amount Grid -->
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="text-[10px] text-slate-500 uppercase font-bold block mb-1">Delivery Date</label>
                    <input type="date" id="input-order-date" class="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white text-xs outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="text-[10px] text-slate-500 uppercase font-bold block mb-1">Value (Optional)</label>
                    <input type="number" id="input-order-amt" placeholder="₹0" class="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white text-xs outline-none focus:border-blue-500">
                </div>
            </div>

            <div class="flex gap-3 pt-2">
                <button onclick="app.closeModals()" class="flex-1 py-3 border border-slate-700 text-slate-400 rounded-lg text-sm font-bold">Cancel</button>
                <button onclick="app.submitOrder()" class="flex-1 py-3 bg-emerald-600 text-white rounded-lg text-sm font-bold shadow-[0_0_15px_rgba(16,185,129,0.3)]">Confirm Order</button>
            </div>
        </div>
    </div>

    <div id="modal-wifi" class="modal fixed inset-0 z-[1000] flex items-center justify-center bg-red-900/90 backdrop-blur-md p-6 text-center">
        <div class="bg-slate-900 p-6 rounded-2xl border border-red-500 shadow-2xl max-w-xs">
            <i class="ph-fill ph-wifi-slash text-4xl text-red-500 mb-4"></i>
            <h2 class="text-lg font-bold text-white">Weak Signal</h2>
            <p class="text-sm text-slate-300 mt-2 mb-4">Turn on Wi-Fi for location accuracy.</p>
        </div>
    </div>

<script>
/**
 * ==========================================================================================
 * GEOGUARD LOGISTICS PRO - CLOUD EDITION (LEAFLET)
 * ==========================================================================================
 */

// --- CONFIGURATION ---
const GOOGLE_API_KEY = 'AIzaSyBpwJ_Z5wnR67SxDfxEf0Vr0KiFFwR8beE'; 
const GOOGLE_CLIENT_ID = '405512233820-hj65j2lgmqf8arfqhqmugh0un3garh54.apps.googleusercontent.com';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';
const DB_FILE_NAME = 'geoguard_db.json';

// --- UTILS ---
const Utils = {
    getDist: (lat1, lon1, lat2, lon2) => {
        const R = 6371e3; const rad = Math.PI/180;
        const a = Math.sin((lat2-lat1)*rad/2)**2 + Math.cos(lat1*rad)*Math.cos(lat2*rad)*Math.sin((lon2-lon1)*rad/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    },
    getBearing: (lat1, lon1, lat2, lon2) => {
        const rad = Math.PI/180; const deg = 180/Math.PI;
        const y = Math.sin((lon2-lon1)*rad) * Math.cos(lat2*rad);
        const x = Math.cos(lat1*rad)*Math.sin(lat2*rad) - Math.sin(lat1*rad)*Math.cos(lat2*rad)*Math.cos((lon2-lon1)*rad);
        return (Math.atan2(y, x) * deg + 360) % 360;
    },
    uuid: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
    fmtDate: (ts) => new Date(ts).toISOString().split('T')[0]
};

// --- GOOGLE DRIVE SERVICE ---
class GoogleCloud {
    constructor(storeInstance) {
        this.store = storeInstance;
        this.tokenClient = null;
        this.accessToken = null;
        this.isReady = false;
        this.init();
    }

    init() {
        const check = setInterval(() => {
            if (window.google && window.gapi) {
                clearInterval(check);
                this.initGapi();
            }
        }, 500);
    }

    initGapi() {
        gapi.load('client', async () => {
            await gapi.client.init({ apiKey: GOOGLE_API_KEY, discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'] });
            this.tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID, scope: SCOPES,
                callback: (resp) => {
                    if (resp.error) throw resp;
                    this.accessToken = resp.access_token;
                    this.updateUI(true);
                    this.sync();
                },
            });
            this.isReady = true;
        });
    }

    login() {
        if(!this.isReady) return alert("Google API loading...");
        this.tokenClient.requestAccessToken({prompt: 'consent'});
    }

    updateUI(isLoggedIn) {
        const btnLogin = document.getElementById('btn-glogin');
        const btnSync = document.getElementById('btn-gsync');
        const status = document.getElementById('cloud-status');
        const dot = document.getElementById('cloud-dot');
        const msg = document.getElementById('drive-msg');

        if(isLoggedIn) {
            btnLogin.classList.add('hidden');
            btnSync.disabled = false;
            btnSync.classList.replace('text-slate-500', 'text-white');
            status.innerText = "CONNECTED";
            dot.classList.replace('bg-slate-500', 'bg-emerald-500');
            msg.innerText = "Ready to Sync";
        }
    }

    async sync() {
        const msg = document.getElementById('drive-msg');
        msg.innerText = "Syncing...";
        
        try {
            const q = `name = '${DB_FILE_NAME}' and trashed = false`;
            const res = await gapi.client.drive.files.list({ q, fields: 'files(id, name)' });
            const files = res.result.files;
            const localData = this.store.dump();

            if (files && files.length > 0) {
                const fileId = files[0].id;
                await gapi.client.request({
                    path: `/upload/drive/v3/files/${fileId}`,
                    method: 'PATCH',
                    params: { uploadType: 'media' },
                    body: JSON.stringify(localData)
                });
                msg.innerText = "Sync Complete (Updated)";
            } else {
                const metadata = { name: DB_FILE_NAME, mimeType: 'application/json' };
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', new Blob([JSON.stringify(localData)], { type: 'application/json' }));

                await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + this.accessToken },
                    body: form
                });
                msg.innerText = "Sync Complete (Created)";
            }
        } catch (e) {
            console.error(e);
            msg.innerText = "Sync Failed";
        }
    }
}

// --- DATA STORE ---
class Store {
    constructor() {
        this.LOCS = 'geo_shops';
        this.LOGS = 'geo_activity';
        this.PROF = 'geo_profile';
    }
    getLocs() { return JSON.parse(localStorage.getItem(this.LOCS)) || []; }
    saveLoc(l) { const d = this.getLocs(); d.push(l); localStorage.setItem(this.LOCS, JSON.stringify(d)); return d; }
    updateLoc(l) { const d = this.getLocs().map(x => x.id === l.id ? l : x); localStorage.setItem(this.LOCS, JSON.stringify(d)); }
    deleteLoc(id) { const d = this.getLocs().filter(x => x.id !== id); localStorage.setItem(this.LOCS, JSON.stringify(d)); }
    
    getLogs() { return JSON.parse(localStorage.getItem(this.LOGS)) || []; }
    log(type, locName, details, amt=0, targetDate=null) {
        // Use provided targetDate, otherwise default to today
        const tDate = targetDate || Utils.fmtDate(Date.now());
        
        const l = { 
            id: Utils.uuid(), 
            type, 
            loc: locName, 
            desc: details, 
            amt: amt || 0, // Ensure amt is 0 if empty
            targetDate: tDate, // Store the delivery/future date
            ts: Date.now(), 
            date: Utils.fmtDate(Date.now()) // Keep creation date for history filtering
        };
        const d = this.getLogs(); d.unshift(l); localStorage.setItem(this.LOGS, JSON.stringify(d));
        return l;
    }

    getProfile() { return JSON.parse(localStorage.getItem(this.PROF)) || { name: '', id: '' }; }
    saveProfile(p) { localStorage.setItem(this.PROF, JSON.stringify(p)); }

    dump() {
        return { profile: this.getProfile(), locations: this.getLocs(), logs: this.getLogs(), lastSync: Date.now() };
    }
}

// --- APP CONTROLLER ---
class App {
    constructor() {
        this.store = new Store();
        this.drive = new GoogleCloud(this.store);
        window.drive = this.drive;

        // Geo Engine
        this.latK = {x:NaN,p:1,q:0.001,r:0.01}; 
        this.lngK = {x:NaN,p:1,q:0.001,r:0.01};
        this.pos = null; 
        this.targetLoc = null; 
        this.locs = this.store.getLocs();

        // Map Objects
        this.map = null;
        this.userMarker = null;
        this.shopLayer = null;
        this.routeLine = null;

        // Bind UI
        this.initUI();
        this.initMap();
        this.startGeo();
    }

    kalman(k, z) { if(isNaN(k.x)){k.x=z;return z} k.p+=k.q; const kg=k.p/(k.p+k.r); k.x+=kg*(z-k.x); k.p=(1-kg)*k.p; return k.x; }

    initUI() {
        const p = this.store.getProfile();
        document.getElementById('prof-name').value = p.name;
        document.getElementById('prof-id').value = p.id;
        document.getElementById('filter-date').value = Utils.fmtDate(Date.now());
        
        this.renderStores();
        this.populateDropdowns();
    }

    // --- LEAFLET MAP ---
    initMap() {
        // Init Leaflet
        this.map = L.map('osm-map', { zoomControl: false, attributionControl: false }).setView([20.5937, 78.9629], 5);
        
        // Dark Theme Tiles
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19, subdomains: 'abcd'
        }).addTo(this.map);

        this.shopLayer = L.layerGroup().addTo(this.map);
        this.updateMapMarkers();
    }

    updateMapMarkers() {
        if(!this.map || !this.shopLayer) return;
        this.shopLayer.clearLayers();

        this.locs.forEach(l => {
            const color = l.isInside ? '#10b981' : (l.id === this.targetLoc?.id ? '#f59e0b' : '#3b82f6');
            
            const marker = L.circleMarker([l.lat, l.lng], {
                radius: 8, fillColor: color, color: '#fff', weight: 1, opacity: 1, fillOpacity: 0.8
            });

            marker.bindPopup(`
                <div class="text-slate-900 font-bold">${l.name}</div>
                <button onclick="app.navTo('${l.id}')" class="text-blue-600 text-xs underline">Select Target</button>
            `);
            marker.addTo(this.shopLayer);
        });
    }

    updateRouteLine() {
        if (this.routeLine) { this.map.removeLayer(this.routeLine); this.routeLine = null; }
        if (this.pos && this.targetLoc) {
            this.routeLine = L.polyline([[this.pos.lat, this.pos.lng], [this.targetLoc.lat, this.targetLoc.lng]], {
                color: '#f59e0b', weight: 3, dashArray: '5, 10', opacity: 0.7
            }).addTo(this.map);
        }
    }

    centerMap() {
        if(this.pos && this.map) this.map.setView([this.pos.lat, this.pos.lng], 17);
    }

    // --- GEO LOGIC ---
    startGeo() {
        if(!navigator.geolocation) return alert("GPS Required");
        navigator.geolocation.watchPosition(p => {
            const {latitude, longitude, accuracy} = p.coords;
            const lat = this.kalman(this.latK, latitude); const lng = this.kalman(this.lngK, longitude);
            this.onGeo({lat, lng, acc: accuracy});
        }, e => console.error(e), {enableHighAccuracy:true, timeout:15000});
    }

    onGeo(pos) {
        this.pos = pos;
        document.getElementById('current-coords').innerText = `${pos.lat.toFixed(5)}, ${pos.lng.toFixed(5)}`;
        
        const wifiModal = document.getElementById('modal-wifi');
        if(pos.acc > 40) wifiModal.classList.add('open'); else wifiModal.classList.remove('open');

        // Update User Marker
        const latLng = [pos.lat, pos.lng];
        if (!this.userMarker) {
            const pulseIcon = L.divIcon({
                className: 'css-icon',
                html: '<div class="w-4 h-4 bg-blue-500 rounded-full border-2 border-white shadow-[0_0_15px_rgba(59,130,246,0.8)] relative"><div class="absolute -inset-4 rounded-full bg-blue-500/30 animate-pulse-fast"></div></div>',
                iconSize: [16, 16], iconAnchor: [8, 8]
            });
            this.userMarker = L.marker(latLng, {icon: pulseIcon}).addTo(this.map);
            this.map.setView(latLng, 16);
        } else {
            this.userMarker.setLatLng(latLng);
        }

        this.updateRouteLine();
        this.checkGeofences(pos);

        if(this.targetLoc) {
            const d = Utils.getDist(pos.lat, pos.lng, this.targetLoc.lat, this.targetLoc.lng);
            document.getElementById('nav-dist').innerText = Math.round(d);
            document.getElementById('nav-bear').innerText = Math.round(Utils.getBearing(pos.lat, pos.lng, this.targetLoc.lat, this.targetLoc.lng));
        }
    }

checkGeofences(pos) {
        let inside = false;
        
        // --- UPDATED CONFIGURATION ---
        const radius = 5; // 5 meters radius (10m Diameter)
        const exitBuffer = 5; // Must move 5m past the radius to exit (Total 10m distance)
        // -----------------------------

        this.locs.forEach(l => {
            const dist = Utils.getDist(pos.lat, pos.lng, l.lat, l.lng);
            
            // Calculate buffer based on GPS accuracy to prevent false exits
            const buff = pos.acc / 2;
            const adj = Math.max(0, dist - buff);

            // ENTRY LOGIC: Strict 5m radius
            if(!l.isInside && dist <= radius) {
                l.isInside = true; 
                l.entryTime = Date.now();
                this.store.log('VISIT_IN', l.name, `Acc: ${Math.round(pos.acc)}m`);
                this.store.updateLoc(l);
            } 
            // EXIT LOGIC: Hysteresis (Radius + Buffer) to prevent flickering
            else if(l.isInside && adj > (radius + exitBuffer)) {
                if(!l._exitT) l._exitT = Date.now();
                
                // Must be outside for 10 seconds to confirm exit
                if(Date.now() - l._exitT > 10000) { 
                    l.isInside = false; 
                    l._exitT = null;
                    const min = Math.round((Date.now() - l.entryTime)/60000);
                    this.store.log('VISIT_OUT', l.name, `Duration: ${min}m`);
                    this.store.updateLoc(l);
                }
            } else { 
                l._exitT = null; 
            }

            // UI UPDATES IF INSIDE
            if(l.isInside) {
                inside = true;
                document.getElementById('current-loc-name').innerText = l.name;
                document.getElementById('zone-status').innerText = "INSIDE";
                document.getElementById('zone-status').className = "px-2 py-1 bg-emerald-900/50 border border-emerald-500 rounded text-[10px] font-bold text-emerald-400";
                
                // Enable Order Button
                const btn = document.getElementById('btn-order');
                btn.disabled = false;
                btn.className = "py-3 rounded-lg bg-emerald-600 text-white text-xs font-bold flex items-center justify-center gap-2 shadow-[0_0_15px_rgba(16,185,129,0.4)] animate-pulse";
                document.getElementById('order-shop-name').innerText = l.name;
            }
        });

        // UI UPDATES IF OUTSIDE
        if(!inside) {
            document.getElementById('current-loc-name').innerText = "In Transit";
            document.getElementById('zone-status').innerText = "OUTSIDE";
            document.getElementById('zone-status').className = "px-2 py-1 bg-slate-800 rounded text-[10px] font-bold text-slate-500";
            
            // Disable Order Button
            const btn = document.getElementById('btn-order');
            btn.disabled = true;
            btn.className = "py-3 rounded-lg bg-slate-800 text-slate-500 border border-slate-700 text-xs font-bold flex items-center justify-center gap-2";
        }
        
        this.updateMapMarkers(); // Refresh map colors
    }

    // --- TABS & UI ---
    switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.add('active');
        
        document.querySelectorAll('.nav-btn').forEach(btn => {
            if(btn.dataset.target === tabId) {
                btn.classList.add('text-blue-500'); btn.classList.remove('text-slate-500');
            } else {
                btn.classList.remove('text-blue-500'); btn.classList.add('text-slate-500');
            }
        });

        if(tabId === 'orders') this.renderOrders();
        if(tabId === 'store') this.renderStores();
        if(tabId === 'home' && this.map) setTimeout(() => this.map.invalidateSize(), 100);
    }

    populateDropdowns() {
        const sel = document.getElementById('select-target');
        const filter = document.getElementById('filter-shop');
        let html = '<option value="">-- Select Shop --</option>';
        let filterHtml = '<option value="all">All Shops</option>';
        
        this.locs.forEach(l => {
            html += `<option value="${l.id}">${l.name}</option>`;
            filterHtml += `<option value="${l.name}">${l.name}</option>`;
        });
        
        sel.innerHTML = html;
        filter.innerHTML = filterHtml;
    }

    // --- ORDER LOGIC ---
    renderOrders() {
        // 1. Get the date selected by the user
        const filterDate = document.getElementById('filter-date').value;
        const shop = document.getElementById('filter-shop').value;
        const logs = this.store.getLogs();
        let total = 0;
        
        // 2. Filter logs based on Delivery Date (targetDate)
        const filtered = logs.filter(l => {
            if(l.type !== 'ORDER') return false;
            
            // USE TARGET DATE (Due Date)
            // If l.targetDate doesn't exist (old data), fallback to l.date (creation date)
            const dueOn = l.targetDate || l.date;
            
            if(dueOn !== filterDate) return false; // Show orders needed for THIS date
            if(shop !== 'all' && l.loc !== shop) return false;
            
            return true;
        });

        // 3. Render the list
        document.getElementById('order-list').innerHTML = filtered.map(l => {
            total += parseFloat(l.amt || 0);
            
            const amountDisplay = l.amt > 0 ? `₹${l.amt}` : `<span class="text-slate-600 text-[10px]">No Cash</span>`;
            
            // Show "Booked On" badge so we know when the order was taken
            const bookedBadge = `<div class="text-[9px] text-blue-400 bg-blue-900/20 px-1.5 py-0.5 rounded inline-block mt-1 border border-blue-900/50">Booked: ${l.date}</div>`;

            return `
                <tr class="border-b border-slate-800 hover:bg-slate-900/50 transition-colors">
                    <td class="px-4 py-3 align-top">
                        <div class="font-bold text-white text-sm">${l.loc}</div>
                        ${bookedBadge}
                    </td>
                    <td class="px-4 py-3 text-slate-400 text-xs align-top whitespace-pre-wrap">
                        ${l.desc}
                    </td>
                    <td class="px-4 py-3 text-right text-emerald-400 font-mono text-xs align-top font-bold">
                        ${amountDisplay}
                    </td>
                </tr>
            `;
        }).join('') || '<tr><td colspan="3" class="px-4 py-8 text-center text-slate-500 italic">No deliveries scheduled for this date</td></tr>';

        document.getElementById('order-total').innerText = `₹${total}`;
    }


    
    // --- STORE LOGIC ---
    renderStores() {
        document.getElementById('store-list').innerHTML = this.locs.map(l => `
            <div class="bg-slate-900 p-4 rounded-xl border border-slate-800 flex justify-between items-center">
                <div>
                    <div class="font-bold text-white">${l.name}</div>
                    <div class="text-[10px] text-slate-500 font-mono">${l.lat.toFixed(5)}, ${l.lng.toFixed(5)}</div>
                </div>
                <div class="flex gap-2">
                    <button onclick="app.navTo('${l.id}')" class="w-8 h-8 rounded bg-slate-800 border border-slate-700 text-blue-400"><i class="ph-bold ph-navigation-arrow"></i></button>
                    <button onclick="app.delStore('${l.id}')" class="w-8 h-8 rounded bg-slate-800 border border-slate-700 text-red-400"><i class="ph-bold ph-trash"></i></button>
                </div>
            </div>
        `).join('') || '<div class="text-center text-slate-500 text-xs p-4">No Stores Saved</div>';
    }

    navTo(id) {
        this.switchTab('home');
        document.getElementById('select-target').value = id;
        this.setTarget();
    }

    delStore(id) {
        // 1. Ask for Password
        const password = prompt("Restricted Action.\nEnter Admin Password to delete:");
        
        // 2. Validate Password
        if (password !== "King3095@") {
            alert("❌ Incorrect Password! Access Denied.");
            return;
        }

        // 3. Delete Store
        this.store.deleteLoc(id);
        this.locs = this.store.getLocs();
        
        // 4. Update UI & Map
        this.populateDropdowns();
        this.renderStores();
        this.updateMapMarkers();
        
        // 5. Clear route if the target was deleted
        if(this.targetLoc?.id === id) { 
            this.targetLoc = null; 
            this.updateRouteLine(); 
        }

        alert("✅ Store Deleted Successfully.");
    }

    // --- ACTIONS ---
    saveLocation() {
        // 1. Get Important Values
        const name = document.getElementById('inp-name').value.trim();
        const auth = document.getElementById('inp-auth').value.trim();
        const contact = document.getElementById('inp-contact').value.trim();
        const addr = document.getElementById('inp-addr').value.trim();

        // 2. Validation
        if (!name || !auth || !contact || !addr) {
            alert("⚠️ Please fill all IMPORTANT fields marked with *");
            return;
        }
        if (!this.pos) {
            alert("❌ Waiting for GPS signal...");
            return;
        }

        // 3. Get Optional Values
        const details = {
            authPerson: auth,
            contact: contact,
            address: addr,
            storeType: document.getElementById('inp-type').value,
            gst: document.getElementById('inp-gst').value.trim(),
            creditLimit: document.getElementById('inp-limit').value.trim(),
            creditDays: document.getElementById('inp-days').value.trim(),
            remark: document.getElementById('inp-remark').value.trim()
        };

        // 4. Save to Store
        const newLoc = {
            id: Utils.uuid(),
            name: name,
            lat: this.pos.lat,
            lng: this.pos.lng,
            ...details, // Spread details into object
            isInside: true,
            entryTime: Date.now()
        };

        this.store.saveLoc(newLoc);
        
        // 5. Update UI
        this.locs = this.store.getLocs();
        this.populateDropdowns();
        this.updateMapMarkers();
        this.closeModals();

        // 6. Reset Form
        ['inp-name', 'inp-auth', 'inp-contact', 'inp-addr', 'inp-gst', 'inp-limit', 'inp-days', 'inp-remark'].forEach(id => {
            document.getElementById(id).value = '';
        });
        document.getElementById('inp-type').value = 'Cash';

        alert("✅ Shop Saved Successfully!");
    }

    setTarget() {
        const id = document.getElementById('select-target').value;
        this.targetLoc = id ? this.locs.find(l=>l.id===id) : null;
        if(this.targetLoc) document.getElementById('nav-info').classList.remove('hidden');
        else document.getElementById('nav-info').classList.add('hidden');
        
        this.updateMapMarkers();
        this.updateRouteLine();
    }

    openOrderModal() {
        const modal = document.getElementById('modal-order');
        modal.classList.add('open');
        // Set date picker to today by default
        document.getElementById('input-order-date').value = Utils.fmtDate(Date.now());
    }

    submitOrder() {
        const desc = document.getElementById('input-order-details').value.trim();
        const amt = document.getElementById('input-order-amt').value.trim();
        const dateVal = document.getElementById('input-order-date').value;
        const shop = document.getElementById('order-shop-name').innerText;
        
        // Only Description and Date are mandatory now
        if(desc && dateVal) {
            // Pass the dateVal as the last argument
            this.store.log('ORDER', shop, desc, amt, dateVal);
            
            this.closeModals();
            
            // Reset fields
            document.getElementById('input-order-details').value = '';
            document.getElementById('input-order-amt').value = '';
            
            this.renderOrders();
            alert("✅ Order Placed Successfully");
        } else {
            alert("⚠️ Please enter Order Details and Date");
        }
    }

    saveProfile() {
        const p = { name: document.getElementById('prof-name').value, id: document.getElementById('prof-id').value };
        this.store.saveProfile(p);
        alert("Profile Updated");
    }

    exportData() {
        const logs = this.store.getLogs();
        const prof = this.store.getProfile();
        let csv = `RIDER PROFILE\nName,${prof.name}\nID,${prof.id}\n\nTYPE,LOCATION,DATE,DETAILS,AMOUNT\n`;
        logs.forEach(l => { csv += `${l.type},"${l.loc}",${new Date(l.ts).toISOString()},"${l.desc}",${l.amt||0}\n`; });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
        a.download = `GeoLog_${prof.name || 'Export'}.csv`;
        a.click();
    }

    openMaps() {
        if(this.targetLoc) window.open(`https://www.google.com/maps/dir/?api=1&destination=${this.targetLoc.lat},${this.targetLoc.lng}`);
        else alert("Select Shop");
    }

    openAddModal() {
        document.getElementById('modal-add').classList.add('open');
        // Update the GPS text in the modal header
        if(this.pos) {
            document.getElementById('add-modal-gps').innerText = `${this.pos.lat.toFixed(5)}, ${this.pos.lng.toFixed(5)}`;
        }
    }
    openOrderModal(){document.getElementById('modal-order').classList.add('open')}
    closeModals(){document.querySelectorAll('.modal').forEach(m=>m.classList.remove('open'))}
}

const app = new App();
</script>
</body>
</html>
