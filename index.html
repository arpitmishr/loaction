<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#020617">
    <title>GeoGuard 360Â° | Tactical Tracker</title>
    
    <!-- TAILWIND CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 950: '#020617' },
                        primary: '#6366f1',
                        accent: '#06b6d4'
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'spin-slow': 'spin 4s linear infinite',
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Custom scrollbar for logs */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 font-sans antialiased min-h-screen pb-32 selection:bg-primary selection:text-white">

    <!-- HEADER -->
    <header class="fixed top-0 w-full z-50 bg-slate-900/80 backdrop-blur-md border-b border-slate-800 shadow-lg">
        <div class="max-w-2xl mx-auto px-4 py-3 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold tracking-tight text-white flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-primary animate-pulse"></span>
                    GeoGuard <span class="text-primary">360Â°</span>
                </h1>
                <p class="text-xs text-slate-400 font-mono mt-0.5">TACTICAL GEOFENCING</p>
            </div>
            <div id="gps-status" class="px-2 py-1 rounded-full bg-slate-800 border border-slate-700 text-xs font-bold text-yellow-500 flex items-center gap-1">
                <svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                INIT
            </div>
        </div>
    </header>

    <main class="max-w-2xl mx-auto px-4 pt-20 space-y-6">

        <!-- RADAR VISUALIZATION -->
        <div class="relative w-full aspect-square max-h-[400px] mx-auto bg-slate-900 rounded-full border-4 border-slate-800 shadow-2xl overflow-hidden ring-1 ring-slate-700">
            <!-- Canvas Layer -->
            <canvas id="radar-canvas" class="absolute inset-0 w-full h-full z-10"></canvas>
            
            <!-- HUD Overlays -->
            <div class="absolute top-4 left-1/2 -translate-x-1/2 z-20 bg-slate-950/80 px-3 py-1 rounded-full border border-slate-700 text-xs font-mono text-cyan-400">
                <span id="heading-val">0</span>Â° MAGNETIC
            </div>
            
            <!-- Central Crosshair (Fixed User) -->
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-20 pointer-events-none">
                <div class="w-4 h-4 bg-primary rounded-full shadow-[0_0_15px_rgba(99,102,241,0.6)] ring-2 ring-white"></div>
                <!-- Cone of vision -->
                <div class="absolute -top-12 -left-8 w-0 h-0 border-l-[32px] border-l-transparent border-r-[32px] border-r-transparent border-t-[60px] border-t-primary/10"></div>
            </div>

            <!-- Overlay for Permission -->
            <div id="compass-overlay" class="absolute inset-0 z-30 bg-slate-950/90 flex flex-col items-center justify-center p-6 text-center">
                <p class="text-sm text-slate-300 mb-4">Enable compass to rotate map with your movement.</p>
                <button id="btn-compass" class="px-6 py-2 bg-primary hover:bg-indigo-600 text-white font-bold rounded-lg transition-all shadow-lg active:scale-95">
                    Enable Compass
                </button>
            </div>
        </div>

        <!-- STATS GRID -->
        <div class="grid grid-cols-3 gap-3">
            <div class="bg-slate-900 p-3 rounded-xl border border-slate-800 text-center">
                <div class="text-[10px] uppercase tracking-wider text-slate-500 mb-1">Accuracy</div>
                <div id="val-acc" class="text-xl font-bold font-mono text-slate-200">--</div>
            </div>
            <div class="bg-slate-900 p-3 rounded-xl border border-slate-800 text-center">
                <div class="text-[10px] uppercase tracking-wider text-slate-500 mb-1">State</div>
                <div id="val-status" class="text-xl font-bold font-mono text-emerald-400">IDLE</div>
            </div>
            <div class="bg-slate-900 p-3 rounded-xl border border-slate-800 text-center">
                <div class="text-[10px] uppercase tracking-wider text-slate-500 mb-1">Zones</div>
                <div id="val-zones" class="text-xl font-bold font-mono text-slate-200">0</div>
            </div>
        </div>

        <!-- CONTROLS -->
        <div class="bg-slate-900 rounded-xl border border-slate-800 p-5 shadow-lg">
            <h2 class="text-sm font-bold text-slate-300 flex items-center gap-2 mb-3">
                <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                Current Location
            </h2>
            <div class="flex gap-2 mb-3">
                <input type="text" id="input-name" placeholder="Name (e.g. Base Alpha)" class="flex-1 bg-slate-950 border border-slate-700 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-colors">
                <button onclick="app.actionSave()" class="bg-primary hover:bg-indigo-600 text-white font-semibold px-4 rounded-lg text-sm transition-colors shadow-lg shadow-indigo-500/20">
                    Save
                </button>
            </div>
            <button onclick="app.actionSim()" class="w-full py-2 border border-slate-700 hover:bg-slate-800 text-slate-400 hover:text-white rounded-lg text-xs font-mono transition-colors">
                ðŸ§ª RUN SIMULATION PROTOCOL
            </button>
        </div>

        <!-- ZONE LIST -->
        <div class="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden">
            <div class="bg-slate-800/50 px-4 py-2 border-b border-slate-800 flex justify-between items-center">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider">Active Zones</h3>
            </div>
            <div id="list-locations" class="divide-y divide-slate-800 max-h-40 overflow-y-auto no-scrollbar">
                <!-- Zones Injected Here -->
                <div class="p-4 text-center text-xs text-slate-500">No active geofences</div>
            </div>
        </div>

        <!-- LOGS -->
        <div class="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden">
             <div class="bg-slate-800/50 px-4 py-2 border-b border-slate-800 flex justify-between items-center">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider">Event Log</h3>
                <button onclick="app.actionClear()" class="text-[10px] text-red-400 hover:text-red-300">CLEAR ALL</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-xs">
                    <thead class="bg-slate-950 text-slate-500">
                        <tr>
                            <th class="px-4 py-2 font-medium">Zone</th>
                            <th class="px-4 py-2 font-medium">Time</th>
                            <th class="px-4 py-2 font-medium">Duration</th>
                        </tr>
                    </thead>
                    <tbody id="list-logs" class="divide-y divide-slate-800 text-slate-300">
                        <!-- Logs Injected Here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- DEBUG CONSOLE -->
        <div id="console-out" class="bg-black rounded-lg border border-slate-800 p-3 font-mono text-[10px] text-green-500 h-24 overflow-y-auto mb-10">
            > System initialized...
        </div>

    </main>

    <!-- TOAST NOTIFICATIONS -->
    <div id="toast-container" class="fixed bottom-6 left-4 right-4 z-[100] flex flex-col gap-2 pointer-events-none"></div>

<script>
/**
 * ====================================================================
 *  GeoGuard 360Â° - Enterprise Logic + Sensor Fusion
 * ====================================================================
 */

/* --- UTILITIES --- */
const Utils = {
    R: 6371e3,
    uuid: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
    
    getDistance: (lat1, lon1, lat2, lon2) => {
        const toRad = x => x * Math.PI / 180;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
        return Utils.R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    },

    // Calculate Bearing (Angle) between two points
    getBearing: (lat1, lon1, lat2, lon2) => {
        const toRad = x => x * Math.PI / 180;
        const toDeg = x => x * 180 / Math.PI;
        const dLon = toRad(lon2 - lon1);
        const y = Math.sin(dLon) * Math.cos(toRad(lat2));
        const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) - 
                  Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon);
        const brng = toDeg(Math.atan2(y, x));
        return (brng + 360) % 360; // Normalize 0-360
    },

    formatTime: (ts) => new Date(ts).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'})
};

/* --- KALMAN FILTER (Noise Reduction) --- */
class KalmanFilter {
    constructor() { this.R = 5; this.Q = 1; this.A = 1; this.B = 0; this.C = 1; this.x = NaN; this.cov = NaN; }
    filter(m) {
        if (isNaN(this.x)) { this.x = m; this.cov = this.R; return m; }
        const predX = this.x; const predCov = this.cov + this.Q;
        const K = predCov / (predCov + this.R);
        this.x = predX + K * (m - predX);
        this.cov = predCov - (K * predCov);
        return this.x;
    }
}

/* --- STORAGE --- */
class StorageManager {
    constructor() { this.K_LOC = 'geo_locs_v3'; this.K_LOG = 'geo_logs_v3'; }
    getLocs() { return JSON.parse(localStorage.getItem(this.K_LOC)) || []; }
    saveLoc(l) { const ls = this.getLocs(); ls.push(l); localStorage.setItem(this.K_LOC, JSON.stringify(ls)); return ls; }
    delLoc(id) { const ls = this.getLocs().filter(l => l.id !== id); localStorage.setItem(this.K_LOC, JSON.stringify(ls)); return ls; }
    updateLoc(l) { const ls = this.getLocs().map(x => x.id === l.id ? l : x); localStorage.setItem(this.K_LOC, JSON.stringify(ls)); }
    addLog(l) { const ls = JSON.parse(localStorage.getItem(this.K_LOG)) || []; ls.unshift(l); if(ls.length>50) ls.pop(); localStorage.setItem(this.K_LOG, JSON.stringify(ls)); return ls; }
    clear() { localStorage.removeItem(this.K_LOC); localStorage.removeItem(this.K_LOG); }
    getLogs() { return JSON.parse(localStorage.getItem(this.K_LOG)) || []; }
}

/* --- HEADING MANAGER (Sensor Fusion) --- */
class HeadingManager {
    constructor(callback) {
        this.callback = callback;
        this.heading = 0;
        this.useCompass = false;
        
        // Handle iOS Permission
        const btn = document.getElementById('btn-compass');
        const overlay = document.getElementById('compass-overlay');
        
        btn.onclick = async () => {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const resp = await DeviceOrientationEvent.requestPermission();
                    if (resp === 'granted') {
                        this.startCompass();
                        overlay.style.display = 'none';
                    } else alert('Permission denied');
                } catch (e) { alert(e); }
            } else {
                // Non-iOS or older devices
                this.startCompass();
                overlay.style.display = 'none';
            }
        };
    }

    startCompass() {
        this.useCompass = true;
        window.addEventListener('deviceorientation', (e) => {
            if(e.webkitCompassHeading) {
                // iOS
                this.heading = e.webkitCompassHeading;
            } else if (e.alpha) {
                // Android (Standard) - Alpha is counter-clockwise, convert to compass
                this.heading = 360 - e.alpha; 
            }
            this.callback(this.heading);
        }, true);
    }

    // Call this with GPS Speed & Bearing updates
    updateFromGPS(speed, bearing) {
        // If moving faster than ~3km/h (0.8 m/s) and bearing is valid, trust GPS over Compass
        if (speed > 0.8 && bearing !== null && !isNaN(bearing)) {
            this.heading = bearing;
            this.callback(this.heading);
        }
        // Else rely on the 'deviceorientation' listener set up in startCompass
    }
}

/* --- GEO ENGINE (Smart Buffer) --- */
class GeoEngine {
    constructor(cb) {
        this.cb = cb;
        this.kLat = new KalmanFilter();
        this.kLng = new KalmanFilter();
        this.isSim = false;
        this.RADIUS = 15;
        this.BUFFER = 10; // Hysteresis
    }

    start() {
        if(!navigator.geolocation) return this.cb('err', 'No GPS');
        navigator.geolocation.watchPosition(
            p => this.process(p),
            e => this.cb('err', e.message),
            { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
        );
    }

    process(p) {
        if(this.isSim) return;
        
        const { latitude, longitude, accuracy, speed, heading } = p.coords;
        const lat = this.kLat.filter(latitude);
        const lng = this.kLng.filter(longitude);
        
        const data = { 
            lat, lng, acc: accuracy, 
            speed: speed, gpsHeading: heading, 
            ts: Date.now() 
        };

        this.cb('pos', data);
    }

    check(pos, zones) {
        zones.forEach(z => {
            const dist = Utils.getDistance(pos.lat, pos.lng, z.lat, z.lng);
            
            // SMART LOGIC: If accuracy is bad, pull user closer to center virtually
            const smartDist = dist - (pos.acc / 2);

            if (!z.isInside && dist <= this.RADIUS) {
                // STRICT ENTRY
                z.isInside = true;
                z.entryTime = Date.now();
                this.cb('event', { type: 'enter', zone: z });
            } 
            else if (z.isInside && smartDist > (this.RADIUS + this.BUFFER)) {
                // LENIENT EXIT
                const dur = Date.now() - z.entryTime;
                if(dur > 15000) { // Glitch filter 15s
                    z.isInside = false;
                    const log = { zone: z.name, entry: z.entryTime, exit: Date.now(), dur: Math.round(dur/1000) };
                    z.entryTime = null;
                    this.cb('event', { type: 'exit', zone: z, log: log });
                }
            }
            z._dist = dist; // For UI
        });
        return zones;
    }

    simulate(startLat, startLng) {
        this.isSim = true;
        let angle = 0;
        const timer = setInterval(() => {
            angle += 5;
            // Move in circle
            const r = 0.0004; // ~40m
            const lat = startLat + Math.sin(angle * Math.PI/180) * r;
            const lng = startLng + Math.cos(angle * Math.PI/180) * r;
            
            // Calc fake bearing
            const bearing = (angle + 90) % 360;

            this.cb('pos', { lat, lng, acc: 10, speed: 2, gpsHeading: bearing, isSim: true });
            if(angle > 720) { clearInterval(timer); this.isSim = false; }
        }, 500);
    }
}

/* --- RADAR RENDERER (ROTATING MAP) --- */
class Radar {
    constructor(canvasId) {
        this.cvs = document.getElementById(canvasId);
        this.ctx = this.cvs.getContext('2d');
        this.resize();
        window.onresize = () => this.resize();
    }
    resize() {
        const p = this.cvs.parentElement;
        this.cvs.width = p.offsetWidth;
        this.cvs.height = p.offsetWidth;
    }
    draw(user, zones, heading) {
        const w = this.cvs.width;
        const cx = w/2, cy = w/2;
        const ctx = this.ctx;
        
        // Clear
        ctx.clearRect(0,0,w,w);

        // --- COORDINATE TRANSFORMATION ---
        ctx.save();
        ctx.translate(cx, cy);
        
        // ROTATE WORLD OPPOSITE TO HEADING (So "Up" is always "Ahead")
        ctx.rotate(-heading * Math.PI / 180);

        // 1. Draw Grid (North Locked relative to world)
        ctx.lineWidth = 1;
        
        // Draw Range Rings (20m, 40m, 60m)
        const scale = (w/2) / 60; // Max range 60m
        [20, 40, 60].forEach(r => {
            ctx.beginPath();
            ctx.strokeStyle = '#334155'; // slate-700
            ctx.arc(0, 0, r * scale, 0, Math.PI*2);
            ctx.stroke();
        });

        // Draw North Line (World Coordinates)
        ctx.beginPath();
        ctx.moveTo(0, 0); ctx.lineTo(0, -w); // Line to North
        ctx.strokeStyle = '#ef4444'; // Red for North
        ctx.setLineDash([5, 5]);
        ctx.stroke();
        ctx.setLineDash([]);
        
        // Draw 'N' Label
        ctx.save();
        ctx.translate(0, -50 * scale);
        ctx.rotate(heading * Math.PI / 180); // Counter-rotate text so it's readable
        ctx.fillStyle = '#ef4444';
        ctx.font = 'bold 12px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('N', 0, 0);
        ctx.restore();

        // 2. Draw Zones
        zones.forEach(z => {
            // Distance & Bearing from User
            const d = Utils.getDistance(user.lat, user.lng, z.lat, z.lng);
            const b = Utils.getBearing(user.lat, user.lng, z.lat, z.lng);
            
            // Convert to Polar Coord on Canvas
            const rads = (b - 90) * Math.PI / 180; // -90 adjustment for canvas math
            const x = Math.cos(rads) * (d * scale);
            const y = Math.sin(rads) * (d * scale);

            // Draw Zone Circle
            ctx.beginPath();
            ctx.fillStyle = z.isInside ? 'rgba(16, 185, 129, 0.2)' : 'rgba(99, 102, 241, 0.2)';
            ctx.strokeStyle = z.isInside ? '#10b981' : '#6366f1';
            ctx.arc(x, y, 15 * scale, 0, Math.PI*2); // 15m radius
            ctx.fill();
            ctx.stroke();

            // Draw Zone Label
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(heading * Math.PI / 180); // Counter-rotate text
            ctx.fillStyle = '#fff';
            ctx.font = '10px monospace';
            ctx.textAlign = 'center';
            ctx.fillText(z.name, 0, 4);
            ctx.restore();
        });

        ctx.restore(); // Undo all rotation
    }
}

/* --- APP CONTROLLER --- */
class App {
    constructor() {
        this.store = new StorageManager();
        this.ui = {
            acc: document.getElementById('val-acc'),
            stat: document.getElementById('val-status'),
            zones: document.getElementById('val-zones'),
            list: document.getElementById('list-locations'),
            logs: document.getElementById('list-logs'),
            con: document.getElementById('console-out'),
            gps: document.getElementById('gps-status'),
            head: document.getElementById('heading-val')
        };
        
        this.currentPos = null;
        this.zones = this.store.getLocs();
        
        this.radar = new Radar('radar-canvas');
        
        // Engines
        this.geo = new GeoEngine((t, d) => this.onGeoEvent(t, d));
        this.headingMgr = new HeadingManager((h) => this.onHeading(h));
        
        this.renderZones();
        this.renderLogs();
        this.geo.start();
        
        this.log('System Initialized. Waiting for GPS...');
    }

    onGeoEvent(type, data) {
        if(type === 'err') {
            this.ui.gps.innerHTML = `<span class="text-red-500">ERR</span>`;
            this.log('GPS Error: ' + data);
            return;
        }

        if(type === 'pos') {
            this.currentPos = data;
            
            // 1. Update UI Stats
            this.ui.gps.innerHTML = `<span class="text-green-400">LIVE</span>`;
            this.ui.acc.innerText = `Â±${Math.round(data.acc)}m`;
            this.ui.acc.className = data.acc < 20 ? 'text-2xl font-bold font-mono text-emerald-400' : 'text-2xl font-bold font-mono text-red-400';

            // 2. Feed GPS Heading to Manager (if moving)
            this.headingMgr.updateFromGPS(data.speed, data.gpsHeading);

            // 3. Logic Check
            this.zones = this.geo.check(data, this.zones);
            
            // 4. Update Status Text
            const inside = this.zones.find(z => z.isInside);
            this.ui.stat.innerText = inside ? inside.name : "OUTSIDE";
            this.ui.stat.className = inside ? "text-xl font-bold font-mono text-emerald-400 animate-pulse" : "text-xl font-bold font-mono text-slate-500";
            
            this.renderZones();
        }

        if(type === 'event') {
            const { type: evtType, zone, log } = data;
            if(evtType === 'enter') {
                this.toast(`Entered: ${zone.name}`, 'green');
                this.store.updateLoc(zone);
                this.log(`>> ENTER ${zone.name}`);
            } else {
                this.toast(`Exited: ${zone.name} (${log.dur}s)`, 'indigo');
                this.store.updateLoc(zone);
                this.store.addLog(log);
                this.log(`<< EXIT ${zone.name}`);
                this.renderLogs();
            }
        }
    }

    onHeading(h) {
        // Redraw radar with new rotation
        this.ui.head.innerText = Math.round(h);
        if(this.currentPos) {
            this.radar.draw(this.currentPos, this.zones, h);
        }
    }

    // --- ACTIONS ---
    actionSave() {
        if(!this.currentPos) return this.toast('Wait for GPS', 'red');
        const name = document.getElementById('input-name').value || 'Target ' + Math.floor(Math.random()*100);
        const z = { id: Utils.uuid(), name, lat: this.currentPos.lat, lng: this.currentPos.lng, isInside: true, entryTime: Date.now() };
        this.store.saveLoc(z);
        this.zones.push(z);
        this.renderZones();
        document.getElementById('input-name').value = '';
        this.toast('Zone Saved', 'green');
    }

    actionSim() {
        if(this.zones.length === 0) return this.toast('Create a zone first', 'red');
        this.geo.simulate(this.zones[0].lat, this.zones[0].lng);
        this.toast('Simulation Started', 'indigo');
    }

    actionClear() {
        if(confirm('Clear all data?')) {
            this.store.clear();
            window.location.reload();
        }
    }

    // --- RENDERERS ---
    renderZones() {
        this.ui.zones.innerText = this.zones.length;
        this.ui.list.innerHTML = this.zones.map(z => `
            <div class="px-4 py-3 flex justify-between items-center bg-slate-900/50 hover:bg-slate-800 transition-colors">
                <div>
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full ${z.isInside ? 'bg-emerald-500 shadow-[0_0_8px_#10b981]' : 'bg-slate-600'}"></div>
                        <span class="text-sm font-bold text-slate-200">${z.name}</span>
                    </div>
                    <div class="text-[10px] font-mono text-slate-500 pl-4 mt-1">
                        DIST: ${z._dist ? Math.round(z._dist) : '?'}m
                    </div>
                </div>
                <button onclick="app.delZone('${z.id}')" class="text-xs text-red-500 hover:text-white hover:bg-red-500 px-2 py-1 rounded transition">DEL</button>
            </div>
        `).join('') || '<div class="p-4 text-center text-xs text-slate-500">No active geofences</div>';
    }

    renderLogs() {
        const logs = this.store.getLogs();
        this.ui.logs.innerHTML = logs.map(l => `
            <tr class="hover:bg-slate-800/50 transition">
                <td class="px-4 py-2 font-bold text-indigo-400">${l.zone}</td>
                <td class="px-4 py-2 font-mono text-slate-400">${Utils.formatTime(l.exit)}</td>
                <td class="px-4 py-2"><span class="bg-slate-800 px-2 py-0.5 rounded text-[10px]">${l.dur}s</span></td>
            </tr>
        `).join('');
    }

    delZone(id) {
        if(confirm('Delete?')) {
            this.store.delLoc(id);
            this.zones = this.zones.filter(z => z.id !== id);
            this.renderZones();
        }
    }

    log(msg) {
        const t = new Date().toLocaleTimeString();
        this.ui.con.innerHTML = `<div><span class="opacity-50">[${t}]</span> ${msg}</div>` + this.ui.con.innerHTML;
    }

    toast(msg, color) {
        const el = document.createElement('div');
        const colors = { green: 'border-emerald-500 bg-emerald-900/80 text-white', red: 'border-red-500 bg-red-900/80 text-white', indigo: 'border-indigo-500 bg-indigo-900/80 text-white' };
        el.className = `px-4 py-3 rounded-lg border-l-4 shadow-xl backdrop-blur-md text-sm font-semibold pointer-events-auto transform transition-all duration-300 translate-y-10 opacity-0 ${colors[color]}`;
        el.innerText = msg;
        document.getElementById('toast-container').appendChild(el);
        requestAnimationFrame(() => el.classList.remove('translate-y-10', 'opacity-0'));
        setTimeout(() => { el.classList.add('opacity-0', 'translate-y-4'); setTimeout(() => el.remove(), 300); }, 3000);
    }
}

// Start App
const app = new App();
window.app = app;
</script>
</body>
</html>
