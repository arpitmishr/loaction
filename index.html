<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FreskeyPiyo Sales System</title>
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a', 950: '#020617' },
                        brand: '#e11d48'
                    }
                }
            }
        }
    </script>
    
    <!-- ICONS -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- GOOGLE SCRIPTS -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>

    <style>
        body { background-color: #020617; color: #e2e8f0; font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .hide { display: none !important; }
        .loader { border: 3px solid #1e293b; border-top: 3px solid #e11d48; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    </style>
</head>
<body class="min-h-screen flex flex-col overflow-hidden">

    <!-- === AUTH SCREEN === -->
    <div id="view-auth" class="fixed inset-0 z-50 bg-slate-950 flex flex-col items-center justify-center p-6 text-center">
        <div class="w-20 h-20 bg-brand rounded-2xl flex items-center justify-center shadow-2xl shadow-rose-900/50 mb-6">
            <i class="ph-fill ph-brandy text-4xl text-white"></i>
        </div>
        <h1 class="text-3xl font-bold text-white mb-2">FreskeyPiyo</h1>
        <p class="text-slate-400 mb-8 max-w-xs">Sales Force Automation System<br><span class="text-xs opacity-50">Powered by Google Drive</span></p>
        
        <button onclick="driveAuth.login()" class="w-full max-w-xs py-3 bg-white text-slate-900 rounded-xl font-bold flex items-center justify-center gap-3 hover:bg-slate-200 transition-all">
            <i class="ph-bold ph-google-logo text-xl"></i>
            <span>Sign in with Google</span>
        </button>
        <div id="auth-status" class="mt-4 text-xs text-slate-500 font-mono h-5">Waiting for input...</div>
    </div>

    <!-- === APP HEADER === -->
    <header class="h-16 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-4 fixed top-0 w-full z-40">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-brand rounded flex items-center justify-center">
                <span class="font-bold text-white">FP</span>
            </div>
            <div>
                <h1 class="text-sm font-bold text-white leading-none">FreskeyPiyo</h1>
                <span id="user-role-badge" class="text-[10px] bg-slate-800 text-slate-400 px-1.5 py-0.5 rounded border border-slate-700">GUEST</span>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <div id="sync-status" class="text-[10px] text-emerald-500 font-mono hidden">SYNCED</div>
            <button onclick="app.sync()" class="w-8 h-8 bg-slate-800 rounded-full flex items-center justify-center border border-slate-700 active:scale-95 text-slate-400 hover:text-white">
                <i id="sync-icon" class="ph-bold ph-arrows-clockwise"></i>
            </button>
            <button onclick="driveAuth.logout()" class="w-8 h-8 bg-red-900/20 rounded-full flex items-center justify-center border border-red-900/50 text-red-500">
                <i class="ph-bold ph-sign-out"></i>
            </button>
        </div>
    </header>

    <!-- === MAIN CONTENT === -->
    <main class="flex-1 pt-16 pb-20 overflow-y-auto bg-slate-950 px-4 scroll-smooth">
        
        <!-- DASHBOARD TAB -->
        <div id="tab-dash" class="tab-content py-4 space-y-4">
            <!-- Manager Only Panel -->
            <div id="manager-panel" class="hide bg-slate-900 border border-slate-800 p-4 rounded-xl">
                <h2 class="text-xs font-bold text-brand uppercase tracking-wider mb-3 border-b border-slate-800 pb-2">Manager Controls</h2>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-slate-950 p-3 rounded border border-slate-800 text-center">
                        <div class="text-2xl font-bold text-white" id="stat-shops">0</div>
                        <div class="text-[10px] text-slate-500">Total Shops</div>
                    </div>
                    <div class="bg-slate-950 p-3 rounded border border-slate-800 text-center">
                        <div class="text-2xl font-bold text-emerald-400" id="stat-orders">0</div>
                        <div class="text-[10px] text-slate-500">Total Orders</div>
                    </div>
                </div>
                <div class="mt-3">
                    <button onclick="app.initializeDriveStructure()" class="w-full py-2 bg-slate-800 border border-slate-700 rounded text-xs text-slate-300 hover:text-white flex items-center justify-center gap-2">
                        <i class="ph-bold ph-folder-notch-plus"></i> Re-Check Drive Folders
                    </button>
                </div>
            </div>

            <!-- Shop Input -->
            <div class="bg-slate-900 border border-slate-800 p-4 rounded-xl shadow-lg">
                <h2 class="text-sm font-bold text-white mb-3 flex items-center gap-2">
                    <i class="ph-fill ph-storefront text-brand"></i> Add New Shop
                </h2>
                <form id="form-shop" onsubmit="app.addShop(event)" class="space-y-3">
                    <input type="text" id="inp-shop-name" placeholder="Shop Name" required class="w-full bg-slate-950 border border-slate-700 rounded p-2 text-sm focus:border-brand outline-none">
                    <input type="text" id="inp-shop-addr" placeholder="Address" required class="w-full bg-slate-950 border border-slate-700 rounded p-2 text-sm focus:border-brand outline-none">
                    <div class="grid grid-cols-2 gap-3">
                        <select id="inp-shop-route" class="bg-slate-950 border border-slate-700 rounded p-2 text-sm outline-none text-slate-300">
                            <option value="Route A">Route A</option>
                            <option value="Route B">Route B</option>
                            <option value="Route C">Route C</option>
                        </select>
                        <select id="inp-shop-type" class="bg-slate-950 border border-slate-700 rounded p-2 text-sm outline-none text-slate-300">
                            <option value="Retail">Retail</option>
                            <option value="Wholesale">Wholesale</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-brand hover:bg-rose-600 text-white font-bold py-2.5 rounded-lg text-sm transition-colors shadow-lg shadow-rose-900/20">
                        Add to Master List
                    </button>
                </form>
            </div>

            <!-- Shops List -->
            <div class="space-y-2">
                <h3 class="text-xs font-bold text-slate-500 uppercase px-1">Registered Shops</h3>
                <div id="list-shops" class="space-y-2 pb-10">
                    <!-- Populated via JS -->
                    <div class="text-center text-slate-600 py-10 text-xs">Loading Shops...</div>
                </div>
            </div>
        </div>

        <!-- ORDERS TAB -->
        <div id="tab-orders" class="tab-content py-4 space-y-4 hide">
            <h2 class="text-lg font-bold text-white border-l-4 border-emerald-500 pl-3">Order History</h2>
            <div id="list-orders" class="space-y-2"></div>
        </div>

    </main>

    <!-- === BOTTOM NAV === -->
    <nav class="fixed bottom-0 w-full bg-slate-900 border-t border-slate-800 z-50 h-16 flex justify-around items-center">
        <button onclick="app.switchTab('dash')" class="nav-btn active flex flex-col items-center gap-1 text-slate-500 w-full" data-target="dash">
            <i class="ph-bold ph-house text-xl"></i>
            <span class="text-[10px]">Home</span>
        </button>
        <button onclick="app.switchTab('orders')" class="nav-btn flex flex-col items-center gap-1 text-slate-500 w-full" data-target="orders">
            <i class="ph-bold ph-receipt text-xl"></i>
            <span class="text-[10px]">Orders</span>
        </button>
    </nav>

    <!-- === MODAL: TAKE ORDER / UPDATE STATUS === -->
    <div id="modal-action" class="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div class="bg-slate-900 w-full max-w-sm rounded-xl border border-slate-700 p-5 scale-95 transition-transform duration-300" id="modal-content">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 class="font-bold text-white text-lg" id="modal-shop-name">Shop Name</h3>
                    <div class="text-xs text-slate-500" id="modal-shop-id">ID: 123</div>
                </div>
                <button onclick="app.closeModal()" class="text-slate-400 hover:text-white"><i class="ph-bold ph-x text-xl"></i></button>
            </div>

            <!-- Tabs in Modal -->
            <div class="flex bg-slate-950 p-1 rounded-lg mb-4">
                <button onclick="app.switchModalTab('visit')" class="modal-tab-btn flex-1 py-1.5 text-xs font-bold rounded text-white bg-slate-800" data-tab="visit">Visit Info</button>
                <button onclick="app.switchModalTab('order')" class="modal-tab-btn flex-1 py-1.5 text-xs font-bold rounded text-slate-500 hover:text-white" data-tab="order">New Order</button>
            </div>

            <!-- Visit Form -->
            <div id="m-tab-visit" class="space-y-3">
                <textarea id="inp-visit-notes" rows="2" class="w-full bg-slate-950 border border-slate-700 rounded p-2 text-sm text-white" placeholder="Visit Notes / Remarks"></textarea>
                <input type="number" id="inp-visit-target" placeholder="Sales Target (Amount)" class="w-full bg-slate-950 border border-slate-700 rounded p-2 text-sm text-white">
                <input type="number" id="inp-visit-due" placeholder="Due Amount" class="w-full bg-slate-950 border border-slate-700 rounded p-2 text-sm text-white">
                <button onclick="app.saveVisit()" class="w-full py-2 bg-blue-600 text-white rounded font-bold text-sm">Save Visit Info</button>
            </div>

            <!-- Order Form -->
            <div id="m-tab-order" class="space-y-3 hidden">
                <input type="number" id="inp-order-qty" placeholder="Quantity" class="w-full bg-slate-950 border border-slate-700 rounded p-2 text-sm text-white">
                <select id="inp-order-status" class="w-full bg-slate-950 border border-slate-700 rounded p-2 text-sm text-white">
                    <option value="Pending">Pending Payment</option>
                    <option value="Paid">Paid</option>
                </select>
                <button onclick="app.saveOrder()" class="w-full py-2 bg-emerald-600 text-white rounded font-bold text-sm">Place Order</button>
            </div>
        </div>
    </div>

<script>
// ==========================================
// CONFIGURATION (ENTER YOUR KEYS HERE)
// ==========================================
const CONFIG = {
    // Replace with your actual credentials
const GOOGLE_API_KEY = 'AIzaSyBpwJ_Z5wnR67SxDfxEf0Vr0KiFFwR8beE'; 
const GOOGLE_CLIENT_ID = '405512233820-hj65j2lgmqf8arfqhqmugh0un3garh54.apps.googleusercontent.com';
    
    // Constants
    MANAGER_EMAIL: 'freskeypiyo@gmail.com',
    SCOPES: 'https://www.googleapis.com/auth/drive', // Full access needed to manage structure
    ROOT_FOLDER: 'FreskeyPiyo',
    FILES: {
        MASTER: 'shops_master.csv',
        USER_DIR: 'user_data',
        ORDER_DIR: 'orders'
    }
};

// ==========================================
// UTILITIES (CSV Parsing/Generating)
// ==========================================
const Utils = {
    uuid: () => Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
    fmtDate: () => new Date().toISOString().split('T')[0],
    
    // Simple CSV Parser (Handles quotes basically)
    parseCSV: (str) => {
        const arr = [];
        let quote = false;
        let col = 0, row = 0;
        let c = '';
        for (let i = 0; i < str.length; i++) {
            let cc = str[i], nc = str[i+1];
            arr[row] = arr[row] || [];
            if (cc == '"' && quote && nc == '"') { c += cc; ++i; continue; }
            if (cc == '"') { quote = !quote; continue; }
            if (cc == ',' && !quote) { arr[row][col] = c; c = ''; ++col; continue; }
            if (cc == '\r' && nc == '\n' && !quote) { arr[row][col] = c; c = ''; ++row; col = 0; ++i; continue; }
            if (cc == '\n' && !quote) { arr[row][col] = c; c = ''; ++row; col = 0; continue; }
            c += cc;
        }
        if(c) arr[row][col] = c;
        return arr; // Returns [[header], [row1], [row2]]
    },
    
    // Array of Objects to CSV string
    toCSV: (data, headers) => {
        const rows = [headers.join(',')];
        data.forEach(obj => {
            const row = headers.map(h => {
                let val = obj[h] || '';
                if (typeof val === 'string' && (val.includes(',') || val.includes('"') || val.includes('\n'))) {
                    val = `"${val.replace(/"/g, '""')}"`;
                }
                return val;
            });
            rows.push(row.join(','));
        });
        return rows.join('\n');
    },

    // CSV Array to Array of Objects
    csvToObj: (arr) => {
        if(arr.length < 2) return [];
        const headers = arr[0].map(h => h.trim());
        const data = [];
        for(let i=1; i<arr.length; i++){
            if(arr[i].length < headers.length) continue;
            let obj = {};
            headers.forEach((h, idx) => obj[h] = arr[i][idx]);
            data.push(obj);
        }
        return data;
    }
};

// ==========================================
// GOOGLE DRIVE SERVICE
// ==========================================
class DriveService {
    constructor() {
        this.tokenClient = null;
        this.accessToken = null;
        this.userEmail = null;
        this.rootFolderId = null;
        this.isManager = false;
    }

    init() {
        gapi.load('client', async () => {
            await gapi.client.init({
                apiKey: CONFIG.API_KEY,
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
            });
            this.tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID,
                scope: CONFIG.SCOPES,
                callback: (resp) => {
                    if (resp.error) return alert("Auth Error");
                    this.accessToken = resp.access_token;
                    this.fetchUserInfo();
                },
            });
            document.getElementById('auth-status').innerText = "System Ready. Please Sign In.";
        });
    }

    login() { this.tokenClient.requestAccessToken({prompt: 'consent'}); }
    
    logout() {
        const token = gapi.client.getToken();
        if (token !== null) {
            google.accounts.oauth2.revoke(token.access_token);
            gapi.client.setToken('');
            location.reload();
        }
    }

    async fetchUserInfo() {
        // Fetch email via Drive 'about' (simplest way without extra scopes)
        try {
            const res = await gapi.client.drive.about.get({ fields: "user" });
            this.userEmail = res.result.user.emailAddress;
            this.isManager = (this.userEmail.toLowerCase() === CONFIG.MANAGER_EMAIL.toLowerCase());
            
            app.onLogin(this.userEmail, this.isManager);
        } catch(e) { console.error(e); alert("Failed to get user info"); }
    }

    // --- FILE OPERATIONS ---

    async findFile(name, parentId = null, mimeType = null) {
        let q = `name = '${name}' and trashed = false`;
        if (parentId) q += ` and '${parentId}' in parents`;
        if (mimeType) q += ` and mimeType = '${mimeType}'`;
        
        const res = await gapi.client.drive.files.list({ q, fields: 'files(id, name)' });
        return res.result.files.length > 0 ? res.result.files[0] : null;
    }

    async createFolder(name, parentId = null) {
        const meta = { name, mimeType: 'application/vnd.google-apps.folder' };
        if (parentId) meta.parents = [parentId];
        const res = await gapi.client.drive.files.create({ resource: meta, fields: 'id' });
        return res.result;
    }

    async uploadFile(name, content, parentId = null, existingId = null) {
        const meta = { name, mimeType: 'text/csv' };
        if (parentId && !existingId) meta.parents = [parentId];

        const multipart = [
            '--boundary',
            'Content-Type: application/json; charset=UTF-8',
            '',
            JSON.stringify(meta),
            '--boundary',
            'Content-Type: text/csv',
            '',
            content,
            '--boundary--'
        ].join('\r\n');

        const path = existingId ? 
            `https://www.googleapis.com/upload/drive/v3/files/${existingId}?uploadType=multipart` :
            'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';
            
        const method = existingId ? 'PATCH' : 'POST';

        await fetch(path, {
            method: method,
            headers: { 
                'Authorization': `Bearer ${this.accessToken}`,
                'Content-Type': 'multipart/related; boundary=boundary'
            },
            body: multipart
        });
    }

    async readFile(fileId) {
        const res = await gapi.client.drive.files.get({ fileId, alt: 'media' });
        return res.body;
    }

    // --- SYSTEM SPECIFIC LOGIC ---

    async getRootFolder() {
        // Search for shared folder or owned folder
        let folder = await this.findFile(CONFIG.ROOT_FOLDER, null, 'application/vnd.google-apps.folder');
        
        if (!folder && this.isManager) {
            folder = await this.createFolder(CONFIG.ROOT_FOLDER);
            console.log("Created Root Folder");
        } else if (!folder && !this.isManager) {
            throw new Error("Folder 'FreskeyPiyo' not found. Ask Manager to share it with you.");
        }
        this.rootFolderId = folder.id;
        return folder.id;
    }
}

// ==========================================
// APP LOGIC
// ==========================================
class App {
    constructor() {
        this.data = { shops: [], userData: [], orders: [] };
        this.headers = {
            shops: ['shop_id', 'shop_name', 'address', 'latitude', 'longitude', 'route', 'shop_type', 'created_by', 'created_at'],
            userData: ['shop_id', 'target', 'visit_status', 'notes', 'due_amount', 'last_visit_date'],
            orders: ['order_id', 'shop_id', 'quantity', 'order_date', 'payment_status', 'salesman_email'] // added email for manager view
        };
        this.currentModalShop = null;
    }

    onLogin(email, isManager) {
        document.getElementById('view-auth').classList.add('hide');
        document.getElementById('user-role-badge').innerText = isManager ? "MANAGER" : "SALESMAN";
        document.getElementById('user-role-badge').classList.add(isManager ? 'text-brand' : 'text-emerald-400');
        if (isManager) document.getElementById('manager-panel').classList.remove('hide');
        
        this.sync();
    }

    // --- SYNC ENGINE ---
    async sync() {
        const icon = document.getElementById('sync-icon');
        const status = document.getElementById('sync-status');
        
        try {
            icon.classList.add('animate-spin');
            status.innerText = "SYNCING...";
            status.classList.remove('hidden');

            // 1. Get Root
            const rootId = await driveAuth.getRootFolder();
            
            // 2. Handle Subfolders (Create if manager, find if salesman)
            let userDir = await driveAuth.findFile(CONFIG.FILES.USER_DIR, rootId, 'application/vnd.google-apps.folder');
            let orderDir = await driveAuth.findFile(CONFIG.FILES.ORDER_DIR, rootId, 'application/vnd.google-apps.folder');
            
            if (driveAuth.isManager) {
                if(!userDir) userDir = await driveAuth.createFolder(CONFIG.FILES.USER_DIR, rootId);
                if(!orderDir) orderDir = await driveAuth.createFolder(CONFIG.FILES.ORDER_DIR, rootId);
            }

            // 3. SHOPS MASTER (Read -> Merge -> Write)
            let masterFile = await driveAuth.findFile(CONFIG.FILES.MASTER, rootId);
            let driveShops = [];
            
            if (masterFile) {
                const csvContent = await driveAuth.readFile(masterFile.id);
                driveShops = Utils.csvToObj(Utils.parseCSV(csvContent));
            } else if (driveAuth.isManager) {
                // Initialize Master
                await driveAuth.uploadFile(CONFIG.FILES.MASTER, this.headers.shops.join(','), rootId);
            }

            // Simple Merge: If we have local new shops not in drive, append them
            // In a real app, use timestamps. Here: naive append.
            const localShops = JSON.parse(localStorage.getItem('local_shops') || '[]');
            const newShops = localShops.filter(ls => !driveShops.find(ds => ds.shop_id === ls.shop_id));
            
            if (newShops.length > 0) {
                const updatedShops = [...driveShops, ...newShops];
                const csv = Utils.toCSV(updatedShops, this.headers.shops);
                await driveAuth.uploadFile(CONFIG.FILES.MASTER, csv, rootId, masterFile ? masterFile.id : null);
                this.data.shops = updatedShops;
                localStorage.setItem('local_shops', '[]'); // Clear pending queue
            } else {
                this.data.shops = driveShops;
            }

            // 4. USER DATA
            const userFileName = `${driveAuth.userEmail}.csv`;
            let userFile = await driveAuth.findFile(userFileName, userDir.id);
            if (userFile) {
                const content = await driveAuth.readFile(userFile.id);
                this.data.userData = Utils.csvToObj(Utils.parseCSV(content));
            } else {
                // Create empty
                await driveAuth.uploadFile(userFileName, this.headers.userData.join(','), userDir.id);
            }

            // 5. ORDERS
            const orderFileName = `orders_${driveAuth.userEmail}.csv`;
            let orderFile = await driveAuth.findFile(orderFileName, orderDir.id);
            if (orderFile) {
                const content = await driveAuth.readFile(orderFile.id);
                this.data.orders = Utils.csvToObj(Utils.parseCSV(content));
            } else {
                await driveAuth.uploadFile(orderFileName, this.headers.orders.join(','), orderDir.id);
            }

            // 6. MANAGER SPECIAL: Read all orders
            if (driveAuth.isManager) {
                // List all files in order dir
                const q = `'${orderDir.id}' in parents and trashed = false`;
                const res = await gapi.client.drive.files.list({ q, fields: 'files(id)' });
                let allOrders = [];
                for (const f of res.result.files) {
                    const c = await driveAuth.readFile(f.id);
                    allOrders = [...allOrders, ...Utils.csvToObj(Utils.parseCSV(c))];
                }
                this.data.orders = allOrders; // Manager sees all
            }

            // Render
            this.renderShops();
            this.renderOrders();
            this.updateStats();
            
            status.innerText = "ONLINE";
        } catch (e) {
            console.error(e);
            alert("Sync Failed: " + e.message);
            status.innerText = "ERROR";
        } finally {
            icon.classList.remove('animate-spin');
        }
    }

    // --- UI ACTIONS ---

    async initializeDriveStructure() {
        if(!driveAuth.isManager) return;
        await this.sync();
        alert("Structure Verified");
    }

    addShop(e) {
        e.preventDefault();
        const name = document.getElementById('inp-shop-name').value;
        const addr = document.getElementById('inp-shop-addr').value;
        const route = document.getElementById('inp-shop-route').value;
        const type = document.getElementById('inp-shop-type').value;

        const newShop = {
            shop_id: Utils.uuid(),
            shop_name: name,
            address: addr,
            latitude: '0', // In real app, get navigator.geolocation
            longitude: '0',
            route: route,
            shop_type: type,
            created_by: driveAuth.userEmail,
            created_at: Utils.fmtDate()
        };

        // Optimistic UI
        this.data.shops.push(newShop);
        this.renderShops();
        
        // Save to local queue for sync
        const queue = JSON.parse(localStorage.getItem('local_shops') || '[]');
        queue.push(newShop);
        localStorage.setItem('local_shops', JSON.stringify(queue));

        document.getElementById('form-shop').reset();
        this.sync(); // Trigger sync
    }

    renderShops() {
        const list = document.getElementById('list-shops');
        list.innerHTML = this.data.shops.map(shop => {
            const meta = this.data.userData.find(u => u.shop_id === shop.shop_id) || {};
            const visited = meta.visit_status === 'Visited';
            const statusColor = visited ? 'bg-emerald-500/10 text-emerald-500 border-emerald-500/50' : 'bg-slate-800 text-slate-500 border-slate-700';
            
            return `
            <div onclick="app.openModal('${shop.shop_id}')" class="bg-slate-900 border border-slate-800 p-3 rounded-xl flex justify-between items-center hover:bg-slate-800 transition-colors cursor-pointer">
                <div>
                    <div class="font-bold text-white text-sm">${shop.shop_name}</div>
                    <div class="text-[10px] text-slate-400">${shop.address} • ${shop.route}</div>
                    ${meta.due_amount ? `<div class="text-[10px] text-brand font-bold mt-1">Due: ₹${meta.due_amount}</div>` : ''}
                </div>
                <div class="flex flex-col items-end gap-1">
                    <span class="px-2 py-1 text-[10px] rounded border ${statusColor} font-bold">${visited ? 'VISITED' : 'PENDING'}</span>
                    <i class="ph-bold ph-caret-right text-slate-600"></i>
                </div>
            </div>`;
        }).join('');
    }

    renderOrders() {
        const list = document.getElementById('list-orders');
        list.innerHTML = this.data.orders.map(ord => {
            const shop = this.data.shops.find(s => s.shop_id === ord.shop_id);
            return `
            <div class="bg-slate-900 border border-slate-800 p-3 rounded-xl mb-2">
                <div class="flex justify-between mb-1">
                    <span class="font-bold text-white text-sm">${shop ? shop.shop_name : 'Unknown Shop'}</span>
                    <span class="text-[10px] text-slate-500">${ord.order_date}</span>
                </div>
                <div class="flex justify-between items-center">
                    <div class="text-xs text-slate-300">Qty: ${ord.quantity}</div>
                    <span class="text-[10px] px-2 py-0.5 rounded bg-blue-900/30 text-blue-400 border border-blue-900">${ord.payment_status}</span>
                </div>
                ${driveAuth.isManager ? `<div class="text-[10px] text-slate-600 mt-1 text-right">By: ${ord.salesman_email || 'Me'}</div>` : ''}
            </div>`;
        }).join('') || '<div class="text-center text-slate-500 text-xs">No Orders</div>';
    }

    updateStats() {
        document.getElementById('stat-shops').innerText = this.data.shops.length;
        document.getElementById('stat-orders').innerText = this.data.orders.length;
    }

    // --- MODAL LOGIC ---

    openModal(shopId) {
        const shop = this.data.shops.find(s => s.shop_id === shopId);
        if(!shop) return;
        this.currentModalShop = shop;
        
        document.getElementById('modal-shop-name').innerText = shop.shop_name;
        document.getElementById('modal-shop-id').innerText = shop.address;
        
        // Load existing user data
        const meta = this.data.userData.find(u => u.shop_id === shopId) || {};
        document.getElementById('inp-visit-notes').value = meta.notes || '';
        document.getElementById('inp-visit-target').value = meta.target || '';
        document.getElementById('inp-visit-due').value = meta.due_amount || '';
        document.getElementById('inp-order-qty').value = '';

        const m = document.getElementById('modal-action');
        m.classList.remove('hidden');
        setTimeout(() => { m.classList.remove('opacity-0'); document.getElementById('modal-content').classList.remove('scale-95'); }, 10);
    }

    closeModal() {
        const m = document.getElementById('modal-action');
        m.classList.add('opacity-0');
        document.getElementById('modal-content').classList.add('scale-95');
        setTimeout(() => m.classList.add('hidden'), 300);
    }

    switchModalTab(tab) {
        document.getElementById('m-tab-visit').classList.toggle('hidden', tab !== 'visit');
        document.getElementById('m-tab-order').classList.toggle('hidden', tab !== 'order');
        document.querySelectorAll('.modal-tab-btn').forEach(b => {
            if(b.dataset.tab === tab) {
                b.classList.remove('text-slate-500'); b.classList.add('text-white', 'bg-slate-800');
            } else {
                b.classList.add('text-slate-500'); b.classList.remove('text-white', 'bg-slate-800');
            }
        });
    }

    async saveVisit() {
        if(!driveAuth.isManager) { // Only salesman edits own data
            const note = document.getElementById('inp-visit-notes').value;
            const target = document.getElementById('inp-visit-target').value;
            const due = document.getElementById('inp-visit-due').value;

            // Update local array
            const idx = this.data.userData.findIndex(u => u.shop_id === this.currentModalShop.shop_id);
            const entry = {
                shop_id: this.currentModalShop.shop_id,
                target: target,
                visit_status: 'Visited',
                notes: note,
                due_amount: due,
                last_visit_date: Utils.fmtDate()
            };

            if(idx > -1) this.data.userData[idx] = entry;
            else this.data.userData.push(entry);

            // Upload
            const rootId = await driveAuth.getRootFolder();
            const userDir = await driveAuth.findFile(CONFIG.FILES.USER_DIR, rootId);
            const userFileName = `${driveAuth.userEmail}.csv`;
            const userFile = await driveAuth.findFile(userFileName, userDir.id);
            
            const csv = Utils.toCSV(this.data.userData, this.headers.userData);
            await driveAuth.uploadFile(userFileName, csv, userDir.id, userFile.id);
            
            this.renderShops();
            this.closeModal();
            alert("Visit Saved");
        } else {
            alert("Managers view only for Visit Data (in this demo)");
        }
    }

    async saveOrder() {
        const qty = document.getElementById('inp-order-qty').value;
        const status = document.getElementById('inp-order-status').value;
        if(!qty) return alert("Enter Quantity");

        const newOrder = {
            order_id: Utils.uuid(),
            shop_id: this.currentModalShop.shop_id,
            quantity: qty,
            order_date: Utils.fmtDate(),
            payment_status: status,
            salesman_email: driveAuth.userEmail
        };

        this.data.orders.push(newOrder);

        // Upload
        const rootId = await driveAuth.getRootFolder();
        const orderDir = await driveAuth.findFile(CONFIG.FILES.ORDER_DIR, rootId);
        const orderFileName = `orders_${driveAuth.userEmail}.csv`;
        const orderFile = await driveAuth.findFile(orderFileName, orderDir.id);

        // Filter orders to only current user's for this file
        const myOrders = this.data.orders.filter(o => o.salesman_email === driveAuth.userEmail);
        const csv = Utils.toCSV(myOrders, this.headers.orders);
        await driveAuth.uploadFile(orderFileName, csv, orderDir.id, orderFile ? orderFile.id : null);

        this.renderOrders();
        this.updateStats();
        this.closeModal();
        alert("Order Placed");
    }

    switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hide'));
        document.getElementById('tab-'+tab).classList.remove('hide');
        document.querySelectorAll('.nav-btn').forEach(b => {
            if(b.dataset.target === tab) b.classList.add('text-brand', 'active');
            else b.classList.remove('text-brand', 'active');
        });
    }
}

// Init
const app = new App();
const driveAuth = new DriveService();
driveAuth.init();

</script>
</body>
</html>
