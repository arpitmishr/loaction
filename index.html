<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <title>GeoGuard Logistics | Light</title>
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ICONS -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- LEAFLET MAPS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- ROUTING MACHINE -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <!-- GOOGLE API (Async) -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; user-select: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* TAB ANIMATION */
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeEffect 0.2s; }
        @keyframes fadeEffect { from {opacity: 0;} to {opacity: 1;} }

        /* MAP STYLES */
        #map-container { position: relative; width: 100%; height: 65vh; background: #e5e7eb; border-radius: 1rem; overflow: hidden; z-index: 1; }
        #osm-map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        
        /* ROUTING HIDE TEXT */
        .leaflet-routing-container { display: none !important; }

        /* BUTTONS Z-INDEX FIX */
        .map-control { z-index: 999 !important; position: absolute; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans h-screen flex flex-col">

    <!-- HEADER -->
    <header class="fixed top-0 w-full z-50 bg-white/95 backdrop-blur border-b border-gray-200 shadow-sm">
        <div class="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white">
                    <i class="ph-bold ph-map-pin"></i>
                </div>
                <h1 class="font-bold text-gray-900 text-sm">GEO<span class="text-blue-600">GUARD</span></h1>
            </div>
            <div class="flex items-center gap-2">
                <span id="gps-status" class="text-[10px] font-bold text-orange-500 bg-orange-50 px-2 py-1 rounded border border-orange-100">GPS..</span>
            </div>
        </div>
    </header>

    <!-- MAIN -->
    <main class="flex-1 w-full max-w-md mx-auto pt-16 pb-20 px-4 overflow-y-auto no-scrollbar">

        <!-- === MAP TAB === -->
        <div id="tab-home" class="tab-content active space-y-4">
            
            <!-- MAP AREA -->
            <div id="map-container" class="shadow-md border border-gray-300">
                <div id="osm-map"></div>

                <!-- HUD -->
                <div class="map-control top-3 left-3 bg-white/90 backdrop-blur px-3 py-1 rounded-full border border-gray-200 text-xs font-bold shadow-sm">
                    <i class="ph-bold ph-compass text-blue-600"></i> <span id="hud-heading">0</span>°
                </div>

                <!-- ZOOM BUTTONS -->
                <div class="map-control bottom-20 right-3 flex flex-col gap-2">
                    <button onclick="app.zoom(1)" class="w-10 h-10 bg-white rounded-full shadow-lg border border-gray-200 text-gray-700 flex items-center justify-center active:bg-gray-100">
                        <i class="ph-bold ph-plus"></i>
                    </button>
                    <button onclick="app.zoom(-1)" class="w-10 h-10 bg-white rounded-full shadow-lg border border-gray-200 text-gray-700 flex items-center justify-center active:bg-gray-100">
                        <i class="ph-bold ph-minus"></i>
                    </button>
                </div>

                <!-- RECENTER BUTTON -->
                <button onclick="app.recenter()" class="map-control bottom-4 right-3 w-12 h-12 bg-blue-600 rounded-full shadow-lg text-white flex items-center justify-center active:scale-95 transition-transform">
                    <i class="ph-bold ph-crosshair text-xl"></i>
                </button>
            </div>

            <!-- CONTROLS -->
            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm space-y-3">
                
                <!-- Target Select -->
                <div class="flex gap-2">
                    <select id="sel-target" onchange="app.setRoute()" class="flex-1 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5 outline-none focus:border-blue-500">
                        <option value="">-- Select Destination --</option>
                    </select>
                    <button onclick="app.openExtMap()" class="bg-gray-100 text-blue-600 px-3 rounded-lg border border-gray-200">
                        <i class="ph-bold ph-arrow-square-out text-lg"></i>
                    </button>
                </div>

                <!-- Route Info -->
                <div id="route-info" class="hidden flex justify-between items-center text-sm pt-2 border-t border-gray-100">
                    <span class="text-gray-500">Dist: <b class="text-gray-900" id="val-dist">0 m</b></span>
                    <span class="text-gray-500">Time: <b class="text-gray-900" id="val-time">0 min</b></span>
                </div>

                <!-- Status & Action -->
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-100">
                    <div>
                        <div class="text-[10px] text-gray-400 font-bold uppercase">Current Zone</div>
                        <div id="zone-lbl" class="font-bold text-gray-800 text-sm">Outside</div>
                    </div>
                    <button id="btn-action" onclick="app.modal('order')" disabled class="px-4 py-2 bg-gray-200 text-gray-400 rounded-lg text-xs font-bold disabled:cursor-not-allowed transition-colors">
                        TAKE ORDER
                    </button>
                </div>
                
                <button onclick="app.modal('add')" class="w-full py-3 border border-gray-300 rounded-lg text-gray-600 font-bold text-xs hover:bg-gray-50">
                    + SAVE CURRENT LOCATION
                </button>
            </div>
        </div>

        <!-- === ORDERS TAB === -->
        <div id="tab-orders" class="tab-content space-y-3">
            <h2 class="font-bold text-lg">Order History</h2>
            <div class="bg-white rounded-xl border border-gray-200 overflow-hidden min-h-[50vh]">
                <table class="w-full text-left text-xs">
                    <thead class="bg-gray-50 border-b border-gray-200 text-gray-500">
                        <tr><th class="p-3">Loc</th><th class="p-3">Desc</th><th class="p-3 text-right">₹</th></tr>
                    </thead>
                    <tbody id="list-orders" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>

        <!-- === STORES TAB === -->
        <div id="tab-stores" class="tab-content space-y-3">
            <h2 class="font-bold text-lg">Saved Stores</h2>
            <div id="list-stores" class="space-y-2 pb-4"></div>
        </div>

        <!-- === SETTINGS TAB === -->
        <div id="tab-settings" class="tab-content space-y-4">
            <h2 class="font-bold text-lg">Profile & Sync</h2>
            
            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm space-y-3">
                <div>
                    <label class="text-xs font-bold text-gray-500">Name</label>
                    <input id="inp-pname" type="text" class="w-full p-2 border border-gray-300 rounded bg-gray-50 mt-1">
                </div>
                <button onclick="app.saveProf()" class="w-full py-2 bg-blue-600 text-white rounded font-bold text-sm">Save Profile</button>
            </div>

            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                <button id="btn-glogin" onclick="drive.login()" class="w-full py-2 border border-gray-300 rounded font-bold text-sm flex justify-center gap-2 mb-2">
                    <i class="ph-bold ph-google-logo"></i> Login Google
                </button>
                <button id="btn-gsync" onclick="drive.sync()" disabled class="w-full py-2 bg-gray-100 text-gray-400 rounded font-bold text-sm">
                    Sync Data
                </button>
                <p id="sync-msg" class="text-center text-[10px] text-gray-400 mt-2">Offline</p>
            </div>
            
             <button onclick="app.exportCSV()" class="w-full py-3 bg-white border border-gray-300 text-green-600 font-bold rounded-xl">
                Export CSV
            </button>
        </div>

    </main>

    <!-- NAV BAR -->
    <nav class="fixed bottom-0 w-full bg-white border-t border-gray-200 z-50 pb-safe">
        <div class="flex justify-around items-center h-16 max-w-md mx-auto">
            <button onclick="app.tab('home')" class="nav-btn text-blue-600 flex flex-col items-center w-full" data-t="home">
                <i class="ph-fill ph-map-trifold text-2xl"></i><span class="text-[10px] font-bold">Map</span>
            </button>
            <button onclick="app.tab('orders')" class="nav-btn text-gray-400 flex flex-col items-center w-full" data-t="orders">
                <i class="ph-fill ph-receipt text-2xl"></i><span class="text-[10px] font-bold">Orders</span>
            </button>
            <button onclick="app.tab('stores')" class="nav-btn text-gray-400 flex flex-col items-center w-full" data-t="stores">
                <i class="ph-fill ph-storefront text-2xl"></i><span class="text-[10px] font-bold">Stores</span>
            </button>
            <button onclick="app.tab('settings')" class="nav-btn text-gray-400 flex flex-col items-center w-full" data-t="settings">
                <i class="ph-fill ph-user-circle text-2xl"></i><span class="text-[10px] font-bold">Settings</span>
            </button>
        </div>
    </nav>

    <!-- MODALS -->
    <div id="modal-add" class="hidden fixed inset-0 z-[60] bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-xl p-5 shadow-2xl">
            <h3 class="font-bold mb-4">Save Location</h3>
            <input id="add-name" type="text" placeholder="Shop Name" class="w-full p-3 border border-gray-300 rounded-lg mb-4 outline-none">
            <div class="flex gap-2">
                <button onclick="app.closeModal()" class="flex-1 py-3 text-gray-500 font-bold">Cancel</button>
                <button onclick="app.saveLoc()" class="flex-1 py-3 bg-blue-600 text-white rounded-lg font-bold">Save</button>
            </div>
        </div>
    </div>

    <div id="modal-order" class="hidden fixed inset-0 z-[60] bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-xl p-5 shadow-2xl">
            <h3 class="font-bold mb-2">New Order</h3>
            <div class="text-xs text-gray-500 mb-3">Shop: <span id="ord-shop" class="font-bold text-gray-800">--</span></div>
            <textarea id="ord-desc" rows="2" placeholder="Details" class="w-full p-3 border border-gray-300 rounded-lg mb-3"></textarea>
            <input id="ord-amt" type="number" placeholder="Amount" class="w-full p-3 border border-gray-300 rounded-lg mb-4">
            <div class="flex gap-2">
                <button onclick="app.closeModal()" class="flex-1 py-3 text-gray-500 font-bold">Cancel</button>
                <button onclick="app.saveOrd()" class="flex-1 py-3 bg-green-600 text-white rounded-lg font-bold">Confirm</button>
            </div>
        </div>
    </div>

<script>
/**
 * GEOGUARD LOGISTICS - FIXED VERSION
 */

// DATA & UTILS
const DB = {
    get: () => JSON.parse(localStorage.getItem('geo_db')) || { locs:[], logs:[], prof:{name:''} },
    save: (d) => localStorage.setItem('geo_db', JSON.stringify(d)),
    dist: (lat1,lon1,lat2,lon2) => {
        const R=6371e3, r=Math.PI/180, a=Math.sin((lat2-lat1)*r/2)**2 + Math.cos(lat1*r)*Math.cos(lat2*r)*Math.sin((lon2-lon1)*r/2)**2;
        return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }
};

// GOOGLE DRIVE (Safe Mode)
const Drive = {
    inited: false, token: null,
    login: function() { 
        if(window.google) {
            google.accounts.oauth2.initTokenClient({
                client_id: '405512233820-hj65j2lgmqf8arfqhqmugh0un3garh54.apps.googleusercontent.com',
                scope: 'https://www.googleapis.com/auth/drive.file',
                callback: (r)=>{ this.token=r.access_token; this.ui(true); }
            }).requestAccessToken({prompt:'consent'});
        } else { alert("Google Services Loading..."); }
    },
    ui: function(on) {
        document.getElementById('btn-glogin').classList.add('hidden');
        const b = document.getElementById('btn-gsync');
        b.disabled=false; b.classList.replace('bg-gray-100','bg-blue-600'); b.classList.replace('text-gray-400','text-white');
        document.getElementById('sync-msg').innerText = "Ready";
    },
    sync: async function() {
        const msg = document.getElementById('sync-msg'); msg.innerText="Syncing...";
        try {
            gapi.client.init({apiKey:'AIzaSyBpwJ_Z5wnR67SxDfxEf0Vr0KiFFwR8beE', discoveryDocs:['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']})
            .then(async ()=>{
                const file = new Blob([JSON.stringify(DB.get())], {type:'application/json'});
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify({name:'geoguard_lite.json'})], {type:'application/json'}));
                form.append('file', file);
                await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method:'POST', headers:{'Authorization':`Bearer ${this.token}`}, body:form
                });
                msg.innerText="Synced: "+new Date().toLocaleTimeString();
            });
        } catch(e) { msg.innerText="Sync Error"; console.error(e); }
    }
};

// APP LOGIC
class Application {
    constructor() {
        this.data = DB.get();
        this.pos = null;
        this.target = null;
        this.map = null;
        this.userMark = null;
        this.routeCtrl = null;
        this.markers = {};

        this.initMap();
        this.startGPS();
        this.renderLists();
        
        // Init Google silently
        setTimeout(()=> { if(window.gapi) gapi.load('client', ()=>{}); }, 1000);
    }

    initMap() {
        // Init Leaflet
        this.map = L.map('osm-map', { zoomControl: false }).setView([20, 78], 5);
        
        // Add Tiles (CartoDB Light)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 20, attribution: '©OSM'
        }).addTo(this.map);

        // User Marker
        this.userMark = L.marker([0,0], {
            icon: L.divIcon({className:'bg-transparent', html:'<div class="w-4 h-4 bg-blue-600 border-2 border-white rounded-full shadow-lg"></div>'})
        }).addTo(this.map);
        
        this.drawMarkers();
    }

    startGPS() {
        if(navigator.geolocation) {
            navigator.geolocation.watchPosition(p => {
                const {latitude:lat, longitude:lng, accuracy:acc} = p.coords;
                const isFirst = !this.pos;
                this.pos = {lat, lng};
                
                // UI
                document.getElementById('gps-status').innerText = `GPS: ±${Math.round(acc)}m`;
                document.getElementById('gps-status').classList.replace('text-orange-500','text-green-600');
                
                // Map
                this.userMark.setLatLng([lat,lng]);
                if(isFirst) this.map.setView([lat,lng], 16);
                
                // Logic
                this.checkZone();
                if(this.routeCtrl && this.target) this.routeCtrl.setWaypoints([L.latLng(lat,lng), L.latLng(this.target.lat,this.target.lng)]);

            }, e => console.warn(e), {enableHighAccuracy:true});
            
            // Compass
            window.addEventListener('deviceorientation', e => {
                const h = e.webkitCompassHeading || Math.abs(e.alpha-360);
                if(h) document.getElementById('hud-heading').innerText = Math.round(h);
            }, true);
        }
    }

    drawMarkers() {
        // Clear
        for(let k in this.markers) this.map.removeLayer(this.markers[k]);
        this.markers = {};
        
        // Add
        this.data.locs.forEach(l => {
            const col = l.isInside ? '#10b981' : (this.target?.id===l.id ? '#f59e0b' : '#3b82f6');
            const icon = L.divIcon({className:'bg-transparent', html:`<div class="w-3 h-3 rounded-full border border-white shadow" style="background:${col}"></div>`});
            const m = L.marker([l.lat,l.lng], {icon}).addTo(this.map).bindPopup(l.name);
            this.markers[l.id] = m;
        });
    }

    // MAP ACTIONS
    zoom(d) { this.map.setZoom(this.map.getZoom()+d); }
    recenter() { if(this.pos) this.map.setView([this.pos.lat,this.pos.lng], 16); }
    
    // NAVIGATION
    setRoute() {
        const id = document.getElementById('sel-target').value;
        this.target = this.data.locs.find(l=>l.id===id);
        
        if(this.routeCtrl) { this.map.removeControl(this.routeCtrl); this.routeCtrl=null; }
        document.getElementById('route-info').classList.add('hidden');
        this.drawMarkers();

        if(this.target && this.pos) {
            this.routeCtrl = L.Routing.control({
                waypoints: [L.latLng(this.pos.lat,this.pos.lng), L.latLng(this.target.lat,this.target.lng)],
                router: L.Routing.osrmv1({serviceUrl:'https://router.project-osrm.org/route/v1'}),
                lineOptions: {styles:[{color:'#2563eb', weight:5}]},
                addWaypoints:false, show:false
            }).addTo(this.map);
            
            this.routeCtrl.on('routesfound', e => {
                const s = e.routes[0].summary;
                document.getElementById('route-info').classList.remove('hidden');
                document.getElementById('val-dist').innerText = Math.round(s.totalDistance)+" m";
                document.getElementById('val-time').innerText = Math.round(s.totalTime/60)+" min";
            });
        }
    }

    openExtMap() {
        if(this.target) window.open(`https://www.openstreetmap.org/directions?engine=graphhopper_car&route=${this.pos.lat}%2C${this.pos.lng}%3B${this.target.lat}%2C${this.target.lng}`);
        else alert("Select destination");
    }

    // LOGIC
    checkZone() {
        if(!this.pos) return;
        let inside = false;
        
        this.data.locs.forEach(l => {
            const d = DB.dist(this.pos.lat, this.pos.lng, l.lat, l.lng);
            if(!l.isInside && d <= 5) {
                l.isInside = true; 
                this.data.logs.unshift({l:l.name, d:'Entered', a:0, t:Date.now()});
                DB.save(this.data); this.drawMarkers(); this.renderLists();
            } else if(l.isInside && d > 10) {
                l.isInside = false;
                this.data.logs.unshift({l:l.name, d:'Exited', a:0, t:Date.now()});
                DB.save(this.data); this.drawMarkers(); this.renderLists();
            }
            if(l.isInside) {
                inside = true;
                document.getElementById('zone-lbl').innerText = l.name;
                document.getElementById('zone-lbl').className = "font-bold text-green-600 text-sm";
                document.getElementById('btn-action').disabled = false;
                document.getElementById('btn-action').className = "px-4 py-2 bg-green-600 text-white rounded-lg text-xs font-bold shadow-sm";
                document.getElementById('ord-shop').innerText = l.name;
            }
        });

        if(!inside) {
            document.getElementById('zone-lbl').innerText = "Outside";
            document.getElementById('zone-lbl').className = "font-bold text-gray-800 text-sm";
            document.getElementById('btn-action').disabled = true;
            document.getElementById('btn-action').className = "px-4 py-2 bg-gray-200 text-gray-400 rounded-lg text-xs font-bold disabled:cursor-not-allowed";
        }
    }

    // UI
    tab(t) {
        document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => {
            const active = b.dataset.t === t;
            b.classList.toggle('text-blue-600', active);
            b.classList.toggle('text-gray-400', !active);
        });
        
        // FIX: Force Map Redraw
        if(t==='home') setTimeout(() => this.map.invalidateSize(), 100);
        if(t==='orders') this.renderLists();
    }

    modal(id) { document.getElementById('modal-'+id).classList.remove('hidden'); }
    closeModal() { document.querySelectorAll('[id^="modal-"]').forEach(e=>e.classList.add('hidden')); }

    renderLists() {
        // Orders
        const ords = this.data.logs.filter(x=>x.a > 0).map(x => `
            <tr><td class="p-3 font-bold">${x.l}</td><td class="p-3 text-gray-500">${x.d}</td><td class="p-3 text-right text-green-600">₹${x.a}</td></tr>
        `).join('');
        document.getElementById('list-orders').innerHTML = ords || '<tr><td colspan="3" class="p-4 text-center text-gray-400">No Orders</td></tr>';

        // Stores
        const stores = this.data.locs.map(x => `
            <div class="bg-white p-3 rounded-lg border border-gray-200 flex justify-between items-center shadow-sm">
                <div><div class="font-bold text-sm">${x.name}</div><div class="text-[10px] text-gray-400">${x.lat.toFixed(4)}, ${x.lng.toFixed(4)}</div></div>
                <button onclick="app.delLoc('${x.id}')" class="text-red-500 bg-red-50 p-2 rounded"><i class="ph-bold ph-trash"></i></button>
            </div>
        `).join('');
        document.getElementById('list-stores').innerHTML = stores;

        // Select
        let opts = '<option value="">-- Select Destination --</option>';
        this.data.locs.forEach(l => opts += `<option value="${l.id}">${l.name}</option>`);
        document.getElementById('sel-target').innerHTML = opts;
    }

    // DATA MOD
    saveLoc() {
        const n = document.getElementById('add-name').value;
        if(n && this.pos) {
            this.data.locs.push({id:Date.now().toString(), name:n, lat:this.pos.lat, lng:this.pos.lng, isInside:false});
            DB.save(this.data); this.drawMarkers(); this.renderLists(); this.closeModal(); document.getElementById('add-name').value='';
        }
    }
    saveOrd() {
        const d = document.getElementById('ord-desc').value;
        const a = document.getElementById('ord-amt').value;
        const s = document.getElementById('ord-shop').innerText;
        if(d && a) {
            this.data.logs.unshift({l:s, d:d, a:a, t:Date.now()});
            DB.save(this.data); this.renderLists(); this.closeModal(); document.getElementById('ord-desc').value=''; document.getElementById('ord-amt').value='';
        }
    }
    delLoc(id) {
        if(confirm('Delete?')) {
            this.data.locs = this.data.locs.filter(l=>l.id!==id);
            DB.save(this.data); this.drawMarkers(); this.renderLists();
        }
    }
    saveProf() {
        this.data.prof.name = document.getElementById('inp-pname').value;
        DB.save(this.data); alert('Saved');
    }
    exportCSV() {
        let c = "LOC,DESC,AMT,TIME\n";
        this.data.logs.forEach(l => c+=`${l.l},${l.d},${l.a},${new Date(l.t).toLocaleString()}\n`);
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([c],{type:'text/csv'})); a.download='data.csv'; a.click();
    }
}

// START
window.drive = Drive;
window.onload = () => { window.app = new Application(); };
</script>
</body>
</html>
