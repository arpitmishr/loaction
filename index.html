<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FreskeyPiyo | Logistics & Sales</title>

    <!-- PICO CSS (Class-less / Minimalist Framework) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    
    <!-- ICONS -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- GOOGLE API SCRIPTS -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>

    <style>
        /* --- CUSTOM STYLES & OVERRIDES --- */
        :root {
            --primary: #d81b60;
            --primary-hover: #ad1457;
            --background-color: #11191f;
            --card-background-color: #1a2632;
        }

        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow: hidden; /* Prevent body scroll, handle in main */
        }

        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Helpers */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-small { font-size: 0.75rem; color: var(--muted-color); }
        .text-success { color: #43a047; }
        .text-error { color: #e53935; }
        .full-width { width: 100%; }
        
        /* Layout Components */
        header.app-header {
            padding: 0.5rem 1rem;
            border-bottom: 1px solid var(--muted-border-color);
            background-color: var(--card-background-color);
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }

        main.app-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            padding-bottom: 80px; /* Space for bottom nav */
        }

        /* Cards */
        article.shop-card {
            margin-bottom: 1rem;
            padding: 1rem;
            border-left: 4px solid var(--muted-border-color);
            cursor: pointer;
            transition: transform 0.1s;
        }
        article.shop-card:active { transform: scale(0.98); }
        article.shop-card.visited { border-left-color: #43a047; }
        
        .badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: #37474f;
            color: white;
        }
        .badge.manager { background: #d81b60; }
        .badge.sales { background: #1e88e5; }

        /* Bottom Navigation */
        nav.bottom-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: var(--card-background-color);
            border-top: 1px solid var(--muted-border-color);
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0;
            z-index: 100;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--muted-color);
            background: none;
            border: none;
            font-size: 0.7rem;
            padding: 0.5rem;
        }
        .nav-item i { font-size: 1.5rem; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary); }

        /* Console Log Box on Login */
        #console-log {
            font-family: monospace;
            font-size: 0.7rem;
            background: #000;
            padding: 10px;
            border-radius: 5px;
            height: 150px;
            overflow-y: auto;
            text-align: left;
            margin-top: 20px;
            border: 1px solid #333;
        }
        .log-line { border-bottom: 1px solid #222; padding: 2px 0; }
    </style>
</head>
<body>

    <!-- =================================================================
         VIEW: LOGIN / AUTHENTICATION
         ================================================================= -->
    <dialog id="modal-login" open>
        <article class="text-center" style="max-width: 400px; width: 100%;">
            <header>
                <hgroup>
                    <h2>FreskeyPiyo</h2>
                    <h3>Sales Force Automation</h3>
                </hgroup>
            </header>
            
            <div id="login-ui-container">
                <i class="ph-duotone ph-brandy" style="font-size: 4rem; color: var(--primary);"></i>
                <p style="margin-top: 1rem;">Secure Cloud Sync System</p>
                
                <button id="btn-google-login" onclick="Auth.login()" class="contrast" disabled>
                    <i class="ph-bold ph-google-logo"></i> Initializing System...
                </button>
            </div>

            <div id="console-log">
                <div class="log-line">System booting...</div>
            </div>
            
            <footer>
                <small class="text-small">Powered by Google Drive API</small>
            </footer>
        </article>
    </dialog>

    <!-- =================================================================
         VIEW: APP LAYOUT (Hidden until logged in)
         ================================================================= -->
    <div id="app-layout" class="hidden">
        
        <!-- Header -->
        <header class="app-header">
            <div style="display: flex; align-items: center; gap: 10px;">
                <i class="ph-fill ph-brandy" style="font-size: 1.5rem; color: var(--primary);"></i>
                <div>
                    <strong style="display: block; line-height: 1;">FreskeyPiyo</strong>
                    <span id="user-badge" class="badge">...</span>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="Sync.start()" class="outline secondary" style="padding: 5px 10px; font-size: 0.8rem;" id="btn-sync">
                    <i class="ph-bold ph-arrows-clockwise"></i> Sync
                </button>
                <button onclick="Auth.logout()" class="outline contrast" style="padding: 5px 10px; font-size: 0.8rem;">
                    <i class="ph-bold ph-sign-out"></i>
                </button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="app-content">
            
            <!-- SECTION: HOME / SHOPS -->
            <section id="view-home">
                
                <!-- Manager Controls -->
                <article id="manager-controls" class="hidden" style="margin-bottom: 1rem; background: #2c0b16;">
                    <header style="padding: 0.5rem 1rem;">
                        <strong>Manager Panel</strong>
                    </header>
                    <div class="grid">
                        <div class="text-center">
                            <h4 id="stat-shops">0</h4>
                            <small>Total Shops</small>
                        </div>
                        <div class="text-center">
                            <h4 id="stat-orders">0</h4>
                            <small>Total Orders</small>
                        </div>
                    </div>
                    <footer style="padding: 0.5rem;">
                        <button onclick="UI.toggleAddShop()" class="full-width outline">
                            <i class="ph-bold ph-plus-circle"></i> Add New Shop
                        </button>
                    </footer>
                </article>

                <!-- Add Shop Form (Toggled) -->
                <article id="form-add-shop" class="hidden">
                    <header>Add Shop to Master List</header>
                    <form onsubmit="Data.addShop(event)">
                        <label>Shop Name <input type="text" name="name" required></label>
                        <label>Address <input type="text" name="addr" required></label>
                        <div class="grid">
                            <label>Route
                                <select name="route">
                                    <option>Route A</option>
                                    <option>Route B</option>
                                    <option>Route C</option>
                                </select>
                            </label>
                            <label>Type
                                <select name="type">
                                    <option>Retail</option>
                                    <option>Wholesale</option>
                                </select>
                            </label>
                        </div>
                        <button type="submit">Save Shop</button>
                    </form>
                </article>

                <!-- Filter -->
                <input type="search" id="shop-search" placeholder="Search shops..." onkeyup="UI.renderShops()" style="margin-bottom: 1rem;">

                <!-- Shop List -->
                <div id="shop-list-container">
                    <!-- Javascript populates this -->
                    <div class="text-center" style="padding: 2rem;">Loading Data...</div>
                </div>
            </section>

            <!-- SECTION: ORDERS -->
            <section id="view-orders" class="hidden">
                <hgroup>
                    <h4>Order History</h4>
                    <h5 id="order-subtitle">My Orders</h5>
                </hgroup>
                <div style="overflow-x: auto;">
                    <table role="grid">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Shop</th>
                                <th>Qty</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="order-table-body">
                            <!-- JS Populates -->
                        </tbody>
                    </table>
                </div>
            </section>

        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-item active" onclick="UI.switchTab('home')" id="nav-home">
                <i class="ph-fill ph-storefront"></i>
                <span>Shops</span>
            </button>
            <button class="nav-item" onclick="UI.switchTab('orders')" id="nav-orders">
                <i class="ph-fill ph-receipt"></i>
                <span>Orders</span>
            </button>
        </nav>
    </div>

    <!-- =================================================================
         MODAL: SHOP ACTION (Visit / Order)
         ================================================================= -->
    <dialog id="modal-shop">
        <article>
            <header>
                <button aria-label="Close" class="close" onclick="UI.closeModal()"></button>
                <strong id="modal-shop-title">Shop Name</strong>
                <br><small id="modal-shop-subtitle" class="text-small">Address</small>
            </header>
            
            <!-- Tabs inside modal -->
            <div style="display: flex; gap: 10px; margin-bottom: 1rem;">
                <button onclick="UI.modalTab('visit')" class="outline secondary" id="mtab-visit">Visit</button>
                <button onclick="UI.modalTab('order')" class="outline" id="mtab-order">Order</button>
            </div>

            <!-- VISIT FORM -->
            <div id="mview-visit">
                <label>Visit Notes
                    <textarea id="inp-notes" rows="3"></textarea>
                </label>
                <div class="grid">
                    <label>Target
                        <input type="number" id="inp-target" placeholder="0">
                    </label>
                    <label>Due Amount
                        <input type="number" id="inp-due" placeholder="0">
                    </label>
                </div>
                <button onclick="Data.saveVisit()">Save Visit Info</button>
            </div>

            <!-- ORDER FORM -->
            <div id="mview-order" class="hidden">
                <label>Quantity (Cases/Units)
                    <input type="number" id="inp-qty" placeholder="0">
                </label>
                <label>Payment Status
                    <select id="inp-pay">
                        <option value="Pending">Pending</option>
                        <option value="Paid">Paid</option>
                        <option value="Partial">Partial</option>
                    </select>
                </label>
                <button onclick="Data.saveOrder()" class="contrast">Place Order</button>
            </div>
        </article>
    </dialog>

    <!-- =================================================================
         JAVASCRIPT LOGIC
         ================================================================= -->
    <script>
       /**
     * ===============================================================
     * 1. CONFIGURATION
     * ===============================================================
     */
    const CONFIG = {
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        // STEP 1: PASTE YOUR KEYS HERE OR IT WILL NOT WORK
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

        
        API_KEY: 'AIzaSyBpwJ_Z5wnR67SxDfxEf0Vr0KiFFwR8beE', 
        CLIENT_ID: '405512233820-hj65j2lgmqf8arfqhqmugh0un3garh54.apps.googleusercontent.com',
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        
        PROJECT_NAME: 'FreskeyPiyo',
        MANAGER_EMAIL: 'freskeypiyo@gmail.com',
        SCOPES: 'https://www.googleapis.com/auth/drive.file',
        FILES: {
            MASTER: 'shops_master.csv',
            USER_FOLDER: 'user_data',
            ORDER_FOLDER: 'orders'
        }
    };

    // Global State
    const State = {
        userEmail: null,
        isManager: false,
        accessToken: null,
        shops: [],      
        userData: [],   
        orders: [],     
        fileIds: {},    
        syncing: false
    };

    // Logging Utility (Prints to the black box on screen)
    const Logger = {
        log: (msg, type='info') => {
            const box = document.getElementById('console-log');
            if(!box) return;
            const line = document.createElement('div');
            line.className = 'log-line';
            line.style.color = type === 'error' ? '#ff5252' : (type === 'success' ? '#69f0ae' : '#ccc');
            line.innerText = `> ${msg}`;
            box.appendChild(line);
            box.scrollTop = box.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${msg}`);
        },
        error: (msg) => Logger.log(msg, 'error'),
        success: (msg) => Logger.log(msg, 'success')
    };

    // Utils
    const Utils = {
        uuid: () => Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
        getToday: () => new Date().toISOString().split('T')[0],
        parseCSV: (text) => {
            if (!text) return [];
            const lines = text.split('\n').filter(l => l.trim() !== '');
            if (lines.length < 2) return [];
            const headers = lines[0].split(',').map(h => h.trim());
            return lines.slice(1).map(line => {
                const data = line.split(',');
                let obj = {};
                headers.forEach((h, i) => obj[h] = data[i] ? data[i].replace(/"/g, '').trim() : '');
                return obj;
            });
        },
        toCSV: (arr, headers) => {
            const headerRow = headers.join(',');
            const rows = arr.map(obj => headers.map(h => `"${(obj[h]||'').toString().replace(/"/g,'""')}"`).join(','));
            return [headerRow, ...rows].join('\n');
        }
    };

    // Drive API Wrapper
    const Drive = {
        find: async (name, parentId = null, mimeType = null) => {
            let q = `name = '${name}' and trashed = false`;
            if (parentId) q += ` and '${parentId}' in parents`;
            if (mimeType) q += ` and mimeType = '${mimeType}'`;
            try {
                const res = await gapi.client.drive.files.list({ 'q': q, 'fields': 'files(id, name)' });
                return res.result.files.length > 0 ? res.result.files[0] : null;
            } catch (e) { Logger.error(`Find Error: ${e.message}`); return null; }
        },
        createFolder: async (name, parentId = null) => {
            const meta = { 'name': name, 'mimeType': 'application/vnd.google-apps.folder' };
            if (parentId) meta.parents = [parentId];
            const res = await gapi.client.drive.files.create({ resource: meta, fields: 'id' });
            return res.result;
        },
        read: async (fileId) => {
            try { return (await gapi.client.drive.files.get({ fileId, alt: 'media' })).body; } 
            catch (e) { return ""; }
        },
        save: async (name, content, parentId = null, existingId = null) => {
            const meta = { 'name': name, 'mimeType': 'text/csv' };
            if (parentId && !existingId) meta.parents = [parentId];
            const boundary = '-------314159265358979323846';
            const delimiter = "\r\n--" + boundary + "\r\n";
            const close_delim = "\r\n--" + boundary + "--";
            const multipartRequestBody = delimiter + 'Content-Type: application/json\r\n\r\n' + JSON.stringify(meta) + delimiter + 'Content-Type: text/csv\r\n\r\n' + content + close_delim;
            
            const path = existingId ? `/upload/drive/v3/files/${existingId}` : '/upload/drive/v3/files';
            const method = existingId ? 'PATCH' : 'POST';
            
            await gapi.client.request({
                path: path,
                method: method,
                params: { uploadType: 'multipart' },
                headers: { 'Content-Type': 'multipart/related; boundary="' + boundary + '"' },
                body: multipartRequestBody
            });
            Logger.success(`Saved ${name}`);
        }
    };

    // Auth & Init Logic
    const Auth = {
        tokenClient: null,
        
        init: () => {
            // --- CRITICAL CHECK ---
            if (CONFIG.API_KEY.includes('PASTE') || CONFIG.CLIENT_ID.includes('PASTE')) {
                const btn = document.getElementById('btn-google-login');
                btn.innerText = "CONFIGURATION ERROR";
                btn.style.backgroundColor = "#d32f2f";
                btn.style.borderColor = "#d32f2f";
                
                Logger.error("STOP: Missing API Keys!");
                alert("ERROR: You must open the code and paste your API_KEY and CLIENT_ID where indicated.\n\nThe app cannot start without them.");
                return;
            }

            Logger.log("Loading GAPI Client...");
            gapi.load('client', async () => {
                try {
                    await gapi.client.init({
                        apiKey: CONFIG.API_KEY,
                        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                    });
                    
                    // Initialize Identity Services
                    Auth.tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: CONFIG.CLIENT_ID,
                        scope: CONFIG.SCOPES,
                        callback: Auth.handleLogin
                    });

                    // Activate Button
                    const btn = document.getElementById('btn-google-login');
                    btn.disabled = false;
                    btn.classList.remove('contrast');
                    btn.classList.add('primary');
                    btn.innerHTML = '<i class="ph-bold ph-google-logo"></i> Sign In with Google';
                    Logger.success("System Ready. Please Login.");
                    
                } catch (err) {
                    Logger.error("GAPI Init Error: " + JSON.stringify(err));
                    alert("Google API failed to load. Check console for details. (Are your keys correct? Is 'Drive API' enabled in console?)");
                }
            });
        },

        login: () => {
            if(!Auth.tokenClient) return alert("System not ready yet.");
            Auth.tokenClient.requestAccessToken({ prompt: 'consent' });
        },

        handleLogin: async (resp) => {
            if (resp.error) {
                Logger.error("Login Failed: " + resp.error);
                return;
            }
            State.accessToken = resp.access_token;
            Logger.success("Logged In! Fetching profile...");
            
            try {
                const res = await gapi.client.drive.about.get({ fields: "user" });
                State.userEmail = res.result.user.emailAddress;
                State.isManager = (State.userEmail.toLowerCase() === CONFIG.MANAGER_EMAIL.toLowerCase());
                
                document.getElementById('modal-login').removeAttribute('open');
                document.getElementById('app-layout').classList.remove('hidden');
                
                UI.init();
                Sync.start();
            } catch(e) { Logger.error("Profile Error: "+e.message); }
        },

        logout: () => {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
            }
            location.reload();
        }
    };

    const Sync = {
        start: async () => {
            const btn = document.getElementById('btn-sync');
            btn.setAttribute('aria-busy', 'true');
            Logger.log("Syncing...");
            
            try {
                // 1. Root
                let root = await Drive.find(CONFIG.PROJECT_NAME, null, 'application/vnd.google-apps.folder');
                if(!root) {
                    if(State.isManager) root = await Drive.createFolder(CONFIG.PROJECT_NAME);
                    else throw new Error("Folder 'FreskeyPiyo' not found. Ask manager to share it.");
                }
                State.fileIds.root = root.id;

                // 2. Master
                let master = await Drive.find(CONFIG.FILES.MASTER, root.id);
                if(master) {
                    const txt = await Drive.read(master.id);
                    State.shops = Utils.parseCSV(txt);
                    State.fileIds.master = master.id;
                } else if(State.isManager) {
                    await Drive.save(CONFIG.FILES.MASTER, "id,name,address,route,type,created_by", root.id);
                    State.shops = [];
                    master = await Drive.find(CONFIG.FILES.MASTER, root.id);
                    State.fileIds.master = master.id;
                }

                // 3. User Data
                let userDir = await Drive.find(CONFIG.FILES.USER_FOLDER, root.id, 'application/vnd.google-apps.folder');
                if(!userDir && State.isManager) userDir = await Drive.createFolder(CONFIG.FILES.USER_FOLDER, root.id);
                if(userDir) {
                    State.fileIds.userDir = userDir.id;
                    const fName = `${State.userEmail}.csv`;
                    let uFile = await Drive.find(fName, userDir.id);
                    if(uFile) {
                        State.userData = Utils.parseCSV(await Drive.read(uFile.id));
                        State.fileIds.userFile = uFile.id;
                    } else {
                        await Drive.save(fName, "shop_id,status,notes,target,due,last_visit", userDir.id);
                        State.userData = [];
                        uFile = await Drive.find(fName, userDir.id);
                        State.fileIds.userFile = uFile.id;
                    }
                }

                // 4. Orders
                let orderDir = await Drive.find(CONFIG.FILES.ORDER_FOLDER, root.id, 'application/vnd.google-apps.folder');
                if(!orderDir && State.isManager) orderDir = await Drive.createFolder(CONFIG.FILES.ORDER_FOLDER, root.id);
                if(orderDir) {
                    State.fileIds.orderDir = orderDir.id;
                    const oName = `orders_${State.userEmail}.csv`;
                    let oFile = await Drive.find(oName, orderDir.id);
                    if(oFile) {
                        State.orders = Utils.parseCSV(await Drive.read(oFile.id));
                        State.fileIds.orderFile = oFile.id;
                    } else {
                        await Drive.save(oName, "id,date,shop_id,qty,status,salesman", orderDir.id);
                        State.orders = [];
                        oFile = await Drive.find(oName, orderDir.id);
                        State.fileIds.orderFile = oFile.id;
                    }
                }

                Logger.success("Sync Complete");
                UI.renderShops();
                UI.renderOrders();
            } catch(e) { 
                Logger.error("Sync Failed: "+e.message); 
                alert("Sync Failed: "+e.message);
            } finally {
                btn.setAttribute('aria-busy', 'false');
            }
        }
    };

    const Data = {
        addShop: async (e) => {
            e.preventDefault();
            const form = e.target;
            const newShop = { id: Utils.uuid(), name: form.name.value, address: form.addr.value, route: form.route.value, type: form.type.value, created_by: State.userEmail };
            State.shops.push(newShop);
            UI.renderShops();
            UI.toggleAddShop();
            form.reset();
            const headers = ['id', 'name', 'address', 'route', 'type', 'created_by'];
            await Drive.save(CONFIG.FILES.MASTER, Utils.toCSV(State.shops, headers), null, State.fileIds.master);
        },
        saveVisit: async () => {
            const note = document.getElementById('inp-notes').value;
            const target = document.getElementById('inp-target').value;
            const due = document.getElementById('inp-due').value;
            let idx = State.userData.findIndex(u => u.shop_id === State.currentShopId);
            const entry = { shop_id: State.currentShopId, status: 'Visited', notes: note, target, due, last_visit: Utils.getToday() };
            if (idx >= 0) State.userData[idx] = entry; else State.userData.push(entry);
            UI.closeModal();
            UI.renderShops();
            const headers = ['shop_id', 'status', 'notes', 'target', 'due', 'last_visit'];
            await Drive.save(`${State.userEmail}.csv`, Utils.toCSV(State.userData, headers), null, State.fileIds.userFile);
        },
        saveOrder: async () => {
            const qty = document.getElementById('inp-qty').value;
            if(!qty) return;
            const order = { id: Utils.uuid(), date: Utils.getToday(), shop_id: State.currentShopId, qty, status: document.getElementById('inp-pay').value, salesman: State.userEmail };
            State.orders.push(order);
            UI.closeModal();
            UI.renderOrders();
            const headers = ['id', 'date', 'shop_id', 'qty', 'status', 'salesman'];
            await Drive.save(`orders_${State.userEmail}.csv`, Utils.toCSV(State.orders, headers), null, State.fileIds.orderFile);
        }
    };

    const UI = {
        init: () => {
            const b = document.getElementById('user-badge');
            b.innerText = State.isManager ? 'MANAGER' : 'SALESMAN';
            b.className = `badge ${State.isManager ? 'manager' : 'sales'}`;
            if(State.isManager) document.getElementById('manager-controls').classList.remove('hidden');
        },
        renderShops: () => {
            const term = document.getElementById('shop-search').value.toLowerCase();
            document.getElementById('stat-shops').innerText = State.shops.length;
            document.getElementById('stat-orders').innerText = State.orders.length;
            const list = State.shops.filter(s => s.name.toLowerCase().includes(term));
            const container = document.getElementById('shop-list-container');
            if(list.length === 0) { container.innerHTML = '<div class="text-center text-small">No Data</div>'; return; }
            container.innerHTML = list.map(s => {
                const meta = State.userData.find(u => u.shop_id === s.id);
                const visited = meta && meta.status === 'Visited';
                return `<article class="shop-card ${visited?'visited':''}" onclick="UI.openShopModal('${s.id}')">
                    <header style="display:flex;justify-content:space-between"><strong>${s.name}</strong>${visited?'<span class="badge" style="background:#43a047">VISITED</span>':''}</header>
                    <div class="text-small" style="color:#bbb"><i class="ph-bold ph-map-pin"></i> ${s.address}<br><span style="color:var(--primary)">${s.route}</span></div>
                </article>`;
            }).join('');
        },
        renderOrders: () => {
            document.getElementById('order-table-body').innerHTML = State.orders.map(o => {
                const s = State.shops.find(x => x.id === o.shop_id);
                return `<tr><td>${o.date}</td><td>${s?s.name:'Unknown'}</td><td>${o.qty}</td><td>${o.status}</td></tr>`;
            }).join('');
        },
        openShopModal: (id) => {
            State.currentShopId = id;
            const s = State.shops.find(x => x.id === id);
            const m = State.userData.find(x => x.shop_id === id) || {};
            document.getElementById('modal-shop-title').innerText = s.name;
            document.getElementById('modal-shop-subtitle').innerText = s.address;
            document.getElementById('inp-notes').value = m.notes||'';
            document.getElementById('inp-target').value = m.target||'';
            document.getElementById('inp-due').value = m.due||'';
            document.getElementById('inp-qty').value = '';
            document.getElementById('modal-shop').setAttribute('open', true);
        },
        closeModal: () => document.getElementById('modal-shop').removeAttribute('open'),
        modalTab: (t) => {
            document.getElementById('mview-visit').classList.toggle('hidden', t!=='visit');
            document.getElementById('mview-order').classList.toggle('hidden', t!=='order');
            document.getElementById('mtab-visit').classList.toggle('secondary', t==='visit');
            document.getElementById('mtab-order').classList.toggle('secondary', t==='order');
        },
        switchTab: (t) => {
            document.getElementById('nav-home').classList.toggle('active', t==='home');
            document.getElementById('nav-orders').classList.toggle('active', t==='orders');
            document.getElementById('view-home').classList.toggle('hidden', t!=='home');
            document.getElementById('view-orders').classList.toggle('hidden', t!=='orders');
        },
        toggleAddShop: () => document.getElementById('form-add-shop').classList.toggle('hidden')
    };

    // BOOTSTRAP
    window.onload = () => {
        Logger.log("Booting...");
        let attempts = 0;
        const check = setInterval(() => {
            if (window.google && window.gapi) {
                clearInterval(check);
                Logger.log("Scripts Found.");
                Auth.init();
            } else if (++attempts > 20) {
                clearInterval(check);
                Logger.error("Google Scripts Timeout (Check Internet)");
            }
        }, 500);
    };
    </script>
</body>
</html>
