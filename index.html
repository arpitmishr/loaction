<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FreskeyPiyo | Logistics</title>
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { slate: { 850: '#1e293b', 950: '#020617' } } } }
        }
    </script>

    <!-- LEAFLET MAP -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- ICONS -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- GOOGLE APIS -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; user-select: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal { transition: opacity 0.3s; opacity: 0; pointer-events: none; }
        .modal.open { opacity: 1; pointer-events: auto; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 font-sans antialiased min-h-screen flex flex-col">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-slate-950 flex flex-col items-center justify-center p-6 text-center">
        <div class="w-20 h-20 bg-emerald-600 rounded-2xl flex items-center justify-center mb-6 shadow-lg shadow-emerald-500/20">
            <i class="ph-fill ph-plant text-4xl text-white"></i>
        </div>
        <h1 class="text-2xl font-bold text-white mb-2">FreskeyPiyo</h1>
        <p class="text-slate-400 mb-8 text-sm">Role-Based Sales & Logistics System<br>Powered by Google Drive</p>
        <button onclick="auth.login()" class="bg-white text-slate-900 px-6 py-3 rounded-xl font-bold flex items-center gap-3 hover:bg-slate-100 transition-all">
            <i class="ph-bold ph-google-logo"></i> Login with Google
        </button>
        <div id="login-status" class="mt-4 text-xs text-slate-500 font-mono"></div>
    </div>

    <!-- HEADER -->
    <header class="fixed top-0 w-full z-40 bg-slate-900/95 backdrop-blur-md border-b border-slate-800 shadow-md">
        <div class="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-emerald-600 rounded-lg flex items-center justify-center text-white">
                    <i class="ph-bold ph-storefront"></i>
                </div>
                <div>
                    <h1 class="text-xs font-bold text-slate-400">FRESKEYPIYO</h1>
                    <div class="flex items-center gap-2">
                        <span id="user-role" class="text-[10px] bg-slate-700 px-1 rounded text-white font-bold">...</span>
                        <span id="sync-status" class="text-[10px] text-emerald-400 font-mono">Synced</span>
                    </div>
                </div>
            </div>
            <button onclick="app.sync()" class="p-2 bg-slate-800 rounded-full border border-slate-700 text-emerald-400">
                <i class="ph-bold ph-arrows-clockwise"></i>
            </button>
        </div>
    </header>

    <!-- MAIN APP -->
    <main class="flex-1 max-w-md mx-auto w-full pt-20 pb-24 px-4 overflow-y-auto no-scrollbar">
        
        <!-- MAP TAB -->
        <div id="tab-map" class="tab-content active space-y-4">
            <div class="relative w-full aspect-square bg-slate-900 rounded-2xl border border-slate-700 overflow-hidden">
                <div id="map" class="absolute inset-0 z-10"></div>
                <button onclick="app.centerMap()" class="absolute bottom-4 right-4 z-20 w-10 h-10 bg-slate-800 border border-slate-600 rounded-full text-white flex items-center justify-center shadow-lg">
                    <i class="ph-bold ph-crosshair"></i>
                </button>
            </div>
            
            <!-- Add Shop (Salesman) -->
            <button id="btn-add-shop" onclick="ui.openAddShop()" class="w-full py-3 bg-slate-800 border border-slate-700 text-white font-bold rounded-xl hidden">
                <i class="ph-bold ph-plus-circle"></i> Add New Shop
            </button>

            <!-- Shop List -->
            <div id="shop-list" class="space-y-3">
                <!-- Injected via JS -->
            </div>
        </div>

        <!-- PROFILE TAB -->
        <div id="tab-profile" class="tab-content space-y-4">
            <div class="bg-slate-900 p-4 rounded-xl border border-slate-800">
                <h3 class="font-bold text-white mb-4">My Dashboard</h3>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-slate-950 p-3 rounded-lg border border-slate-800">
                        <div class="text-xs text-slate-500">Shops</div>
                        <div id="dash-shops" class="text-xl font-bold text-white">0</div>
                    </div>
                    <div class="bg-slate-950 p-3 rounded-lg border border-slate-800">
                        <div class="text-xs text-slate-500">Total Due</div>
                        <div id="dash-due" class="text-xl font-bold text-red-400">₹0</div>
                    </div>
                </div>
                <div class="text-xs text-slate-500">Logged in as: <span id="user-email" class="text-white">--</span></div>
            </div>
        </div>
    </main>

    <!-- NAV -->
    <nav class="fixed bottom-0 w-full bg-slate-900 border-t border-slate-800 z-40 pb-safe">
        <div class="max-w-md mx-auto flex justify-around items-center h-16">
            <button onclick="ui.switchTab('map')" class="nav-btn text-emerald-500 flex flex-col items-center gap-1">
                <i class="ph-fill ph-map-trifold text-xl"></i><span class="text-[10px]">Map</span>
            </button>
            <button onclick="ui.switchTab('profile')" class="nav-btn text-slate-500 flex flex-col items-center gap-1">
                <i class="ph-bold ph-user-circle text-xl"></i><span class="text-[10px]">Profile</span>
            </button>
        </div>
    </nav>

    <!-- ADD SHOP MODAL -->
    <div id="modal-shop" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-slate-900 w-full max-w-sm rounded-xl border border-slate-700 p-4 space-y-3">
            <h3 class="font-bold text-white">Add New Shop</h3>
            <input id="inp-shop-name" placeholder="Shop Name" class="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white text-sm">
            <input id="inp-shop-addr" placeholder="Address / Route" class="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white text-sm">
            <select id="inp-shop-type" class="w-full bg-slate-950 border border-slate-700 rounded p-3 text-white text-sm">
                <option value="Retail">Retail</option>
                <option value="Wholesale">Wholesale</option>
            </select>
            <div class="text-[10px] text-slate-400">Location will be captured automatically.</div>
            <div class="flex gap-3">
                <button onclick="ui.closeModals()" class="flex-1 py-3 border border-slate-700 text-slate-400 rounded-lg text-sm">Cancel</button>
                <button onclick="app.saveNewShop()" class="flex-1 py-3 bg-emerald-600 text-white rounded-lg text-sm font-bold">Save Shop</button>
            </div>
        </div>
    </div>

    <!-- VISIT / ORDER MODAL -->
    <div id="modal-visit" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-slate-900 w-full max-w-sm rounded-xl border border-slate-700 p-4 space-y-3 flex flex-col max-h-[90vh]">
            <div class="border-b border-slate-800 pb-2">
                <h3 id="visit-shop-name" class="font-bold text-white">Shop Name</h3>
                <span id="visit-shop-id" class="text-[10px] text-slate-500 font-mono">ID</span>
            </div>
            
            <div class="overflow-y-auto space-y-3 custom-scrollbar">
                <!-- User Data Section -->
                <div class="bg-slate-950 p-3 rounded border border-slate-800">
                    <label class="text-[10px] text-slate-500 uppercase font-bold">Target</label>
                    <input id="inp-target" type="number" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white text-sm mb-2">
                    
                    <label class="text-[10px] text-slate-500 uppercase font-bold">Due Amount (₹)</label>
                    <input id="inp-due" type="number" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white text-sm mb-2">
                    
                    <label class="text-[10px] text-slate-500 uppercase font-bold">Visit Notes</label>
                    <textarea id="inp-notes" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white text-sm"></textarea>
                </div>

                <!-- Order Section -->
                <div class="bg-blue-900/10 p-3 rounded border border-blue-900/30">
                    <h4 class="text-xs font-bold text-blue-400 mb-2">New Order</h4>
                    <input id="inp-order-qty" type="number" placeholder="Quantity" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white text-sm">
                </div>
            </div>

            <div class="flex gap-3 pt-2">
                <button onclick="ui.closeModals()" class="flex-1 py-3 border border-slate-700 text-slate-400 rounded-lg text-sm">Close</button>
                <button onclick="app.saveVisit()" class="flex-1 py-3 bg-emerald-600 text-white rounded-lg text-sm font-bold">Update</button>
            </div>
        </div>
    </div>

<script>
/**
 * FRESKEYPIYO - LOGISTICS PRO
 * Stack: HTML5, Tailwind, Leaflet, Google Drive API (No Firebase)
 */

// --- CONFIGURATION ---
const GOOGLE_API_KEY = 'AIzaSyBpwJ_Z5wnR67SxDfxEf0Vr0KiFFwR8beE'; 
const GOOGLE_CLIENT_ID = '405512233820-hj65j2lgmqf8arfqhqmugh0un3garh54.apps.googleusercontent.com';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';
const MANAGER_EMAIL = 'freskeypiyo@gmail.com';

// --- FOLDER STRUCTURE ---
const FOLDER_ROOT = 'FreskeyPiyo';
const FOLDER_USER = 'user_data';
const FOLDER_ORDERS = 'orders';
const FILE_MASTER = 'shops_master.csv';

// --- UTILS ---
const Utils = {
    uuid: () => Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
    now: () => new Date().toISOString(),
    
    // Convert Array of Objects to CSV String
    toCSV: (data) => {
        if (!data || data.length === 0) return '';
        const headers = Object.keys(data[0]);
        const rows = data.map(obj => headers.map(header => {
            let val = obj[header] || '';
            // Escape commas/quotes
            if (typeof val === 'string' && (val.includes(',') || val.includes('"') || val.includes('\n'))) {
                val = `"${val.replace(/"/g, '""')}"`;
            }
            return val;
        }).join(','));
        return [headers.join(','), ...rows].join('\n');
    },

    // Convert CSV String to Array of Objects
    fromCSV: (text) => {
        if (!text || text.trim() === '') return [];
        const lines = text.trim().split('\n');
        const headers = lines[0].split(',').map(h => h.trim());
        return lines.slice(1).map(line => {
            const obj = {};
            // Handle simple CSV splitting (ignores complex quoted commas for simplicity in this MVP)
            const values = line.split(','); 
            headers.forEach((h, i) => obj[h] = values[i] ? values[i].replace(/^"|"$/g, '') : '');
            return obj;
        });
    }
};

// --- DRIVE API SERVICE ---
const Drive = {
    token: null,
    
    init: async () => {
        return new Promise((resolve) => {
            gapi.load('client', async () => {
                await gapi.client.init({ apiKey: API_KEY, discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'] });
                resolve();
            });
        });
    },

    login: () => {
        return new Promise((resolve, reject) => {
            const client = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: SCOPES,
                callback: (resp) => {
                    if (resp.error) reject(resp);
                    Drive.token = resp.access_token;
                    resolve(resp);
                },
            });
            client.requestAccessToken();
        });
    },

    // Find a file/folder by name inside a parent (or root)
    find: async (name, parentId = 'root', mimeType = null) => {
        let q = `name = '${name}' and '${parentId}' in parents and trashed = false`;
        if (mimeType) q += ` and mimeType = '${mimeType}'`;
        const res = await gapi.client.drive.files.list({ q, fields: 'files(id, name)' });
        return res.result.files.length > 0 ? res.result.files[0] : null;
    },

    // Create a folder
    createFolder: async (name, parentId = 'root') => {
        const metadata = { name, mimeType: 'application/vnd.google-apps.folder', parents: [parentId] };
        const res = await gapi.client.drive.files.create({ resource: metadata, fields: 'id' });
        return res.result;
    },

    // Create a CSV file
    createFile: async (name, parentId, content) => {
        const metadata = { name, mimeType: 'text/csv', parents: [parentId] };
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', new Blob([content], { type: 'text/csv' }));
        
        await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + Drive.token },
            body: form
        });
    },

    // Update a file
    updateFile: async (fileId, content) => {
        await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
            method: 'PATCH',
            headers: { 'Authorization': 'Bearer ' + Drive.token, 'Content-Type': 'text/csv' },
            body: content
        });
    },

    // Read File Content
    read: async (fileId) => {
        try {
            const res = await gapi.client.drive.files.get({ fileId, alt: 'media' });
            return res.body;
        } catch (e) { return ''; }
    }
};

// --- DATA STORE ---
const Store = {
    user: null, // { email, role }
    ids: { root: null, userFolder: null, ordersFolder: null, masterFile: null, userFile: null, ordersFile: null },
    data: {
        shops: [], // From shops_master.csv
        userData: [], // From user_data/{email}.csv
        orders: [] // From orders/{email}.csv
    }
};

// --- APP LOGIC ---
const app = {
    init: async () => {
        await Drive.init();
        // Check for session? For now, manual login.
    },

    // 1. Authenticate & Setup
    loginSuccess: async () => {
        // Get User Info
        const res = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', { 
            headers: { Authorization: `Bearer ${Drive.token}` } 
        });
        const profile = await res.json();
        
        Store.user = {
            email: profile.email,
            role: profile.email === MANAGER_EMAIL ? 'MANAGER' : 'SALESMAN'
        };

        // UI Update
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('user-email').innerText = Store.user.email;
        document.getElementById('user-role').innerText = Store.user.role;
        
        if (Store.user.role === 'SALESMAN') {
            document.getElementById('btn-add-shop').classList.remove('hidden');
        }

        // Initialize Map
        ui.initMap();

        // Start Sync
        app.sync();
    },

    // 2. Core Sync Logic
    sync: async () => {
        ui.status("Syncing...");
        try {
            // A. Ensure Structure Exists
            let root = await Drive.find(FOLDER_ROOT);
            if (!root) {
                if (Store.user.role === 'MANAGER') {
                    root = await Drive.createFolder(FOLDER_ROOT);
                } else {
                    alert("System not initialized. Ask Manager to run app first.");
                    return;
                }
            }
            Store.ids.root = root.id;

            // B. Subfolders
            let userFolder = await Drive.find(FOLDER_USER, root.id);
            if (!userFolder) userFolder = await Drive.createFolder(FOLDER_USER, root.id);
            Store.ids.userFolder = userFolder.id;

            let orderFolder = await Drive.find(FOLDER_ORDERS, root.id);
            if (!orderFolder) orderFolder = await Drive.createFolder(FOLDER_ORDERS, root.id);
            Store.ids.ordersFolder = orderFolder.id;

            // C. Load Master File
            let master = await Drive.find(FILE_MASTER, root.id);
            if (master) {
                Store.ids.masterFile = master.id;
                const csv = await Drive.read(master.id);
                Store.data.shops = Utils.fromCSV(csv);
            } else if (Store.user.role === 'MANAGER') {
                // Initialize Empty Master
                const initial = [{shop_id:'INIT', shop_name:'Init', address:'-', lat:0, lng:0, created_by:'system'}];
                await Drive.createFile(FILE_MASTER, root.id, Utils.toCSV(initial));
                Store.data.shops = initial;
                // Re-find to get ID
                master = await Drive.find(FILE_MASTER, root.id);
                Store.ids.masterFile = master.id;
            }

            // D. Load User Specific Data
            const userFileName = `${Store.user.email}.csv`;
            let userFile = await Drive.find(userFileName, userFolder.id);
            if (userFile) {
                Store.ids.userFile = userFile.id;
                const csv = await Drive.read(userFile.id);
                Store.data.userData = Utils.fromCSV(csv);
            } else {
                Store.data.userData = []; // Empty start
            }

            // E. Load Orders
            const orderFileName = `orders_${Store.user.email}.csv`;
            let orderFile = await Drive.find(orderFileName, orderFolder.id);
            if (orderFile) {
                Store.ids.ordersFile = orderFile.id;
                const csv = await Drive.read(orderFile.id);
                Store.data.orders = Utils.fromCSV(csv);
            } else {
                Store.data.orders = [];
            }

            ui.status("Synced");
            ui.renderShops();

        } catch (e) {
            console.error(e);
            ui.status("Sync Error");
        }
    },

    // 3. Add Shop (Salesman)
    saveNewShop: async () => {
        const name = document.getElementById('inp-shop-name').value;
        const addr = document.getElementById('inp-shop-addr').value;
        const type = document.getElementById('inp-shop-type').value;

        if (!name) return alert("Name required");

        // Get Location
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const newShop = {
                shop_id: 'S' + Utils.uuid(),
                shop_name: name,
                address: addr,
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
                route: 'Default',
                shop_type: type,
                created_by: Store.user.email,
                created_at: Utils.now()
            };

            // 1. Update Local
            Store.data.shops.push(newShop);
            
            // 2. Update Drive (Master)
            // Note: In a real concurrent env, we should download fresh before appending. 
            // For this Code-only constraint, we overwrite with local state.
            if (Store.ids.masterFile) {
                await Drive.updateFile(Store.ids.masterFile, Utils.toCSV(Store.data.shops));
            }

            ui.closeModals();
            ui.renderShops();
            ui.status("Shop Added");
        }, () => alert("GPS required"));
    },

    // 4. Update Visit/Target (Personal Data)
    saveVisit: async () => {
        const id = document.getElementById('visit-shop-id').innerText;
        const target = document.getElementById('inp-target').value;
        const notes = document.getElementById('inp-notes').value;
        const due = document.getElementById('inp-due').value;
        const orderQty = document.getElementById('inp-order-qty').value;

        // A. Handle User Data (Target/Notes/Due)
        let userEntry = Store.data.userData.find(u => u.shop_id === id);
        if (!userEntry) {
            userEntry = { shop_id: id };
            Store.data.userData.push(userEntry);
        }
        userEntry.target = target;
        userEntry.notes = notes;
        userEntry.due_amount = due;
        userEntry.visit_status = 'Visited';
        userEntry.last_visit_date = Utils.now();

        // Save User CSV
        const userCsv = Utils.toCSV(Store.data.userData);
        if (Store.ids.userFile) {
            await Drive.updateFile(Store.ids.userFile, userCsv);
        } else {
            await Drive.createFile(`${Store.user.email}.csv`, Store.ids.userFolder, userCsv);
            // Re-sync to get ID
            const f = await Drive.find(`${Store.user.email}.csv`, Store.ids.userFolder);
            Store.ids.userFile = f.id;
        }

        // B. Handle Order
        if (orderQty > 0) {
            const newOrder = {
                order_id: 'O' + Utils.uuid(),
                shop_id: id,
                quantity: orderQty,
                order_date: Utils.now(),
                payment_status: 'Pending'
            };
            Store.data.orders.push(newOrder);
            
            const orderCsv = Utils.toCSV(Store.data.orders);
            if (Store.ids.ordersFile) {
                await Drive.updateFile(Store.ids.ordersFile, orderCsv);
            } else {
                await Drive.createFile(`orders_${Store.user.email}.csv`, Store.ids.ordersFolder, orderCsv);
                const f = await Drive.find(`orders_${Store.user.email}.csv`, Store.ids.ordersFolder);
                Store.ids.ordersFile = f.id;
            }
        }

        ui.closeModals();
        ui.renderShops();
        ui.status("Updated");
    }
};

// --- UI LOGIC ---
const ui = {
    map: null,
    markers: [],

    initMap: () => {
        if (ui.map) return;
        ui.map = L.map('map').setView([20.5937, 78.9629], 5);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(ui.map);
    },

    status: (msg) => { document.getElementById('sync-status').innerText = msg; },

    switchTab: (t) => {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + t).classList.add('active');
        if (t === 'map') setTimeout(() => ui.map.invalidateSize(), 300);
    },

    renderShops: () => {
        const list = document.getElementById('shop-list');
        list.innerHTML = '';
        
        // Clear Map Markers
        ui.markers.forEach(m => ui.map.removeLayer(m));
        ui.markers = [];

        let totalDue = 0;

        Store.data.shops.forEach(shop => {
            if(shop.shop_id === 'INIT') return; // Skip header/init row

            // Merge with User Data
            const uData = Store.data.userData.find(u => u.shop_id === shop.shop_id) || {};
            const due = parseFloat(uData.due_amount || 0);
            totalDue += due;

            // HTML Item
            const div = document.createElement('div');
            div.className = 'bg-slate-900 p-4 rounded-xl border border-slate-800 flex justify-between items-center';
            div.innerHTML = `
                <div>
                    <div class="font-bold text-white">${shop.shop_name}</div>
                    <div class="text-[10px] text-slate-500">${shop.address}</div>
                    ${uData.visit_status ? '<span class="text-[9px] text-emerald-400">Visited</span>' : ''}
                </div>
                <button onclick="ui.openVisit('${shop.shop_id}')" class="px-3 py-1 bg-blue-900 text-blue-400 rounded text-xs border border-blue-800">
                    Visit
                </button>
            `;
            list.appendChild(div);

            // Map Marker
            if (shop.lat && shop.lng) {
                const marker = L.circleMarker([shop.lat, shop.lng], {
                    radius: 8, color: '#fff', fillColor: due > 0 ? '#ef4444' : '#10b981', fillOpacity: 0.8
                }).addTo(ui.map);
                marker.bindPopup(shop.shop_name);
                ui.markers.push(marker);
            }
        });

        document.getElementById('dash-shops').innerText = Store.data.shops.length - (Store.data.shops.length > 0 && Store.data.shops[0].shop_id === 'INIT' ? 1 : 0);
        document.getElementById('dash-due').innerText = '₹' + totalDue;
    },

    openAddShop: () => document.getElementById('modal-shop').classList.add('open'),
    
    openVisit: (id) => {
        const shop = Store.data.shops.find(s => s.shop_id === id);
        const uData = Store.data.userData.find(u => u.shop_id === id) || {};

        document.getElementById('visit-shop-name').innerText = shop.shop_name;
        document.getElementById('visit-shop-id').innerText = shop.shop_id;
        document.getElementById('inp-target').value = uData.target || '';
        document.getElementById('inp-notes').value = uData.notes || '';
        document.getElementById('inp-due').value = uData.due_amount || '';
        document.getElementById('inp-order-qty').value = ''; // Reset order
        
        document.getElementById('modal-visit').classList.add('open');
    },

    closeModals: () => document.querySelectorAll('.modal').forEach(m => m.classList.remove('open')),
    
    centerMap: () => {
        navigator.geolocation.getCurrentPosition(pos => {
            ui.map.setView([pos.coords.latitude, pos.coords.longitude], 15);
        });
    }
};

// --- AUTH HANDLER ---
const auth = {
    login: async () => {
        try {
            document.getElementById('login-status').innerText = 'Authenticating...';
            await Drive.init();
            await Drive.login();
            document.getElementById('login-status').innerText = 'Success!';
            app.loginSuccess();
        } catch (e) {
            console.error(e);
            document.getElementById('login-status').innerText = 'Login Failed';
        }
    }
};

</script>
</body>
</html>
